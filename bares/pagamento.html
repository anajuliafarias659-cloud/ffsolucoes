<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Fechar Conta</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#020617;
  color:#fff;
}
.container{max-width:900px;margin:auto;padding:30px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}
.row{display:flex;gap:12px;flex-wrap:wrap}
input,select,button{padding:12px;border-radius:10px;border:none;font-size:16px}
button{background:#22c55e;font-weight:bold;cursor:pointer}
button.sec{background:#1e293b}
.item{display:flex;justify-content:space-between;border-bottom:1px solid #1e293b;padding:6px 0}
.total{font-size:20px;font-weight:bold}
.pago{color:#22c55e}
.falta{color:#ef4444}
</style>
</head>

<body>

<script>
// ================= SUPABASE =================
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

// ================= SESS√ÉO =================
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin || !admin.app_id){
  alert("Sess√£o expirada");
  location.href="../auth/login.html";
}

// ================= PEDIDO =================
const pedidoId = new URLSearchParams(location.search).get("pedido");
if(!pedidoId){
  alert("Pedido n√£o informado");
  throw new Error("Pedido n√£o informado");
}

// ================= VARI√ÅVEIS =================
let totalPedido = 0;
let pagamentos = [];
let mesaId = null;

let tipoSelect, valorInput, clienteInput;
</script>

<div class="container">

<h2>üßæ Fechar Conta</h2>

<div class="box">
  <h3>Consumo</h3>
  <div id="itens"></div>
  <p class="total">Total: R$ <span id="totalPedido">0.00</span></p>
</div>

<div class="box">
  <h3>Pagamentos</h3>

  <div class="row">
    <select id="tipo" onchange="tipoChanged()">
      <option value="pix">Pix</option>
      <option value="debito">D√©bito</option>
      <option value="credito">Cr√©dito</option>
      <option value="dinheiro">Dinheiro</option>
      <option value="fiado">Fiado</option>
    </select>

    <input type="number" id="valor" placeholder="Valor" step="0.01">
    <input id="cliente" placeholder="Nome do cliente (fiado)" style="display:none">
    <button onclick="addPagamento()">Adicionar</button>
  </div>

  <div id="listaPagamentos"></div>

  <p class="pago">Pago: R$ <span id="totalPago">0.00</span></p>
  <p class="falta">Falta: R$ <span id="falta">0.00</span></p>
  <p class="pago">Troco: R$ <span id="troco">0.00</span></p>
</div>

<div class="box">
  <button class="sec" onclick="location.href='mesas.html'">Voltar</button>
</div>

</div>

<script>
// ================= INIT =================
document.addEventListener("DOMContentLoaded", ()=>{
  tipoSelect   = document.getElementById("tipo");
  valorInput   = document.getElementById("valor");
  clienteInput = document.getElementById("cliente");
});

// ================= CONSUMO =================
async function carregarItens(){
  const { data, error } = await sb
    .from("pedido_itens")
    .select("nome_produto, preco, quantidade")
    .eq("app_id", admin.app_id)
    .eq("pedido_id", pedidoId);

  if(error){
    console.error(error);
    alert("Erro ao carregar itens");
    return;
  }

  const div = document.getElementById("itens");
  div.innerHTML = "";
  totalPedido = 0;

  data.forEach(i=>{
    const sub = i.preco * i.quantidade;
    totalPedido += sub;
    div.innerHTML += `
      <div class="item">
        <span>${i.quantidade}x ${i.nome_produto}</span>
        <span>R$ ${sub.toFixed(2)}</span>
      </div>`;
  });

  document.getElementById("totalPedido").innerText = totalPedido.toFixed(2);
}

// ================= PEDIDO / MESA =================
async function carregarPedido(){
  const { data, error } = await sb
    .from("pedidos")
    .select("mesa_id")
    .eq("id", pedidoId)
    .eq("app_id", admin.app_id)
    .single();

  if(error){
    console.error(error);
    alert("Erro ao carregar pedido");
    return;
  }

  mesaId = data.mesa_id;
}

// ================= TIPO =================
function tipoChanged(){
  if(tipoSelect.value === "fiado"){
    clienteInput.style.display = "block";
  }else{
    clienteInput.style.display = "none";
    clienteInput.value = "";
  }
}

// ================= PAGAMENTOS =================
async function carregarPagamentos(){
  const { data, error } = await sb
    .from("pagamentos")
    .select("*")
    .eq("app_id", admin.app_id)
    .eq("pedido_id", pedidoId);

  if(error){
    console.error(error);
    alert("Erro ao carregar pagamentos");
    return;
  }

  pagamentos = data || [];
  renderTotais();
}

function renderTotais(){
  const div = document.getElementById("listaPagamentos");
  div.innerHTML = "";

  let totalPago = 0;
  let dinheiro = 0;

  pagamentos.forEach(p=>{
    if(p.tipo !== "fiado"){
      totalPago += p.valor;
      if(p.tipo === "dinheiro") dinheiro += p.valor;
    }

    div.innerHTML += `
      <div class="item">
        <span>
          ${p.tipo.toUpperCase()}
          ${p.tipo === "fiado" && p.cliente_fiado ? "‚Ä¢ " + p.cliente_fiado : ""}
        </span>
        <span>R$ ${p.valor.toFixed(2)}</span>
      </div>`;
  });

  const falta = Math.max(0, totalPedido - totalPago);
  const troco = Math.max(0, Math.min(dinheiro, totalPago - totalPedido));

  document.getElementById("totalPago").innerText = totalPago.toFixed(2);
  document.getElementById("falta").innerText = falta.toFixed(2);
  document.getElementById("troco").innerText = troco.toFixed(2);

  if(falta === 0){
    finalizarPedido();
  }
}

// ================= FINALIZAR =================
async function finalizarPedido(){
  const { error: erroPedido } = await sb
    .from("pedidos")
    .update({ status: "fechado" }) // üî• STATUS COMPAT√çVEL COM O CHECK
    .eq("id", pedidoId)
    .eq("app_id", admin.app_id);

  if(erroPedido){
    console.error("Erro ao fechar pedido:", erroPedido);
    return;
  }

  if(mesaId){
    const { error: erroMesa } = await sb
      .from("mesas")
      .update({ status: "livre" })
      .eq("id", mesaId)
      .eq("app_id", admin.app_id);

    if(erroMesa){
      console.error("Erro ao liberar mesa:", erroMesa);
    }
  }
}

// ================= ADD PAGAMENTO =================
async function addPagamento(){
  const tipo  = tipoSelect.value;
  const valor = Number(valorInput.value);

  if(valor <= 0){
    alert("Valor inv√°lido");
    return;
  }

  if(tipo === "fiado" && !clienteInput.value.trim()){
    alert("Informe o nome do cliente do fiado");
    return;
  }

  if(["pix","debito","credito"].includes(tipo)){
    const totalAtual = pagamentos
      .filter(p=>p.tipo !== "fiado")
      .reduce((s,p)=>s+p.valor,0);

    if(totalAtual + valor > totalPedido){
      alert("Pix ou cart√£o n√£o geram troco");
      return;
    }
  }

  const payload = {
    app_id: admin.app_id,
    pedido_id: pedidoId,
    tipo,
    valor
  };

  if(tipo === "fiado"){
    payload.cliente_fiado = clienteInput.value.trim();
  }

  const { error } = await sb.from("pagamentos").insert(payload);
  if(error){
    console.error(error);
    alert("Erro ao registrar pagamento");
    return;
  }

  valorInput.value="";
  clienteInput.value="";
  carregarPagamentos();
}

// ================= START =================
carregarPedido();
carregarItens();
carregarPagamentos();
</script>

</body>
</html>
