<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const app = new URLSearchParams(location.search).get("app");
if(!app){ document.body.innerHTML="Link invÃ¡lido"; throw ""; }

const carrinhoKey = "carrinho_"+app;

let carrinho = JSON.parse(localStorage.getItem(carrinhoKey)) || [];
let fotosProduto = {};
let fotosAtuais = [];
let indice = 0;
let WHATS = "";
let localizacaoLink = "";

/* ================= INIT ================= */
async function init(){
  const {data:cfg} = await sb
    .from("config_site")
    .select("*")
    .eq("app_id",app)
    .single();

  WHATS = cfg.whatsapp || "";

  nomeLoja.innerText = cfg.nome_site || "";
  descLoja.innerText = cfg.descricao_site || "";
  banner.innerHTML = cfg.banner_url ? `<img src="${cfg.banner_url}">` : "";

  const {data} = await sb
    .from("produtos")
    .select("*")
    .eq("ativo",true)
    .eq("app_id",app);

  produtos.innerHTML = (data || []).map(p=>{

    /* ===== TRATAMENTO DEFINITIVO DE IMAGEM ===== */
    let fotos = [];

    try{
      if(p.imagens){
        fotos = typeof p.imagens === "string"
          ? JSON.parse(p.imagens)
          : p.imagens;
      } else if(p.imagem){
        fotos = [p.imagem];
      }
    }catch(e){
      fotos = [];
    }

    if(!Array.isArray(fotos)) fotos = [fotos];
    fotos = fotos.filter(f => f && f.trim() !== "");

    fotosProduto[p.id] = fotos;

    return `
      <div class="card">
        ${fotos[0] 
          ? `<img src="${fotos[0]}" loading="lazy" onclick="abrirImagem('${p.id}')">`
          : `<div style="height:160px;display:flex;align-items:center;justify-content:center;opacity:.3">Sem imagem</div>`
        }
        <b>${p.nome}</b><br>
        R$ ${Number(p.preco).toFixed(2)}
        <button class="botao" onclick='add(${JSON.stringify(p)})'>Adicionar</button>
      </div>
    `;
  }).join("");

  atualizarBadge();
}

init();

/* ================= GALERIA ================= */
function abrirImagem(id){
  fotosAtuais = fotosProduto[id];
  if(!fotosAtuais.length) return;

  indice = 0;
  atualizarImagem();
  modalImagem.style.display = "flex";
}

function atualizarImagem(){
  imgZoom.src = fotosAtuais[indice];
  contador.innerText = `${indice+1} / ${fotosAtuais.length}`;

  indicadores.innerHTML = fotosAtuais.map((_,i)=>
    `<span class="${i===indice?'ativo':''}" onclick="irPara(${i},event)"></span>`
  ).join("");
}

function irPara(i,e){
  e.stopPropagation();
  indice = i;
  atualizarImagem();
}

imgZoom.onclick = ()=>{
  indice = (indice+1) % fotosAtuais.length;
  atualizarImagem();
}

function fecharImagem(){
  modalImagem.style.display="none";
}

/* ================= CARRINHO ================= */
function add(p){
  const item = carrinho.find(x=>x.id===p.id);
  item ? item.qtd++ : carrinho.push({...p,qtd:1});
  salvarCarrinho();
  atualizarBadge();
}

function diminuir(i){
  carrinho[i].qtd--;
  if(carrinho[i].qtd<=0) carrinho.splice(i,1);
  salvarCarrinho();
  atualizarBadge();
  renderCarrinho();
}

function salvarCarrinho(){
  localStorage.setItem(carrinhoKey, JSON.stringify(carrinho));
}

function atualizarBadge(){
  const total = carrinho.reduce((s,i)=>s+i.qtd,0);
  badge.innerText = total;
  badge.style.display = total ? "block" : "none";
}

function abrirCarrinho(){
  modal.style.display="flex";
  renderCarrinho();
}

function fecharCarrinho(){
  modal.style.display="none";
}

function renderCarrinho(){
  let totalValor = 0;

  listaCarrinho.innerHTML = carrinho.map((i,idx)=>{
    totalValor += i.preco * i.qtd;
    return `
      <div class="item">
        ${i.nome} x${i.qtd}
        <button onclick="diminuir(${idx})">âˆ’</button>
      </div>`;
  }).join("");

  total.innerText = totalValor.toFixed(2);
}

/* ================= TROCO ================= */
pagamento.addEventListener("change",()=>{
  trocoBox.style.display = pagamento.value==="Dinheiro" ? "block" : "none";
  precisaTroco.value="";
  trocoValor.value="";
  trocoValor.style.display="none";
});

function toggleTrocoValor(){
  trocoValor.style.display =
    precisaTroco.value==="sim" ? "block" : "none";
}

/* ================= LOCALIZAÃ‡ÃƒO ================= */
function usarLocalizacao(){
  navigator.geolocation.getCurrentPosition(pos=>{
    localizacaoLink =
      `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
    alert("LocalizaÃ§Ã£o capturada");
  });
}

/* ================= FINALIZAR ================= */
function finalizar(){

  if(!carrinho.length){
    alert("Carrinho vazio");
    return;
  }

  if(!cliNome.value || !cliEndereco.value || !cliNumero.value){
    alert("Preencha nome, rua e nÃºmero");
    return;
  }

  let enderecoCompleto =
    cliEndereco.value + ", NÂº " + cliNumero.value;

  let msg = `ðŸ›ï¸ *${nomeLoja.innerText}*\n\n`;
  msg += `ðŸ‘¤ ${cliNome.value}\n`;
  msg += `ðŸ  ${enderecoCompleto}\n`;

  if(cliReferencia.value)
    msg += `ðŸ“Œ ${cliReferencia.value}\n`;

  if(localizacaoLink)
    msg += `ðŸ“ ${localizacaoLink}\n`;

  msg += "\n";

  carrinho.forEach(i=>{
    msg += `â€¢ ${i.nome} x${i.qtd}\n`;
  });

  msg += `\nðŸ’° Total: R$ ${total.innerText}`;
  msg += `\nðŸ’³ ${pagamento.value}`;

  if(pagamento.value==="Dinheiro"){
    if(precisaTroco.value==="sim"){
      msg += `\nðŸ’µ Troco para: R$ ${trocoValor.value}`;
    }else{
      msg += `\nðŸ’µ Sem troco`;
    }
  }

  window.open(
    `https://wa.me/55${WHATS}?text=${encodeURIComponent(msg)}`
  );

  carrinho=[];
  salvarCarrinho();
  atualizarBadge();
  fecharCarrinho();
}
</script>
