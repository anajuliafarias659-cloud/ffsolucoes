<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Loja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#fff}
:root{--p:#22c55e;--b:#0f172a;--c:#0f172a}

/* BANNER */
.banner{height:260px;background:#0f172a}
.banner img{width:100%;height:100%;object-fit:cover}

/* TOPO */
.topo{text-align:center;padding:24px;background:#0f172a}

/* GRID */
.container{padding:20px;max-width:1200px;margin:auto}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.card{background:#0f172a;padding:12px;border-radius:14px;text-align:center}
.card img{width:100%;height:160px;object-fit:cover;border-radius:10px;cursor:pointer}
.botao{margin-top:8px;width:100%;padding:10px;border:none;border-radius:10px;background:#22c55e;font-weight:bold}

/* CARRINHO */
#carrinhoBtn{
position:fixed;bottom:20px;right:20px;
width:60px;height:60px;border-radius:50%;
background:#22c55e;font-size:22px;border:none
}
#badge{
position:absolute;top:-5px;right:-5px;
background:red;color:#fff;border-radius:50%;
padding:2px 7px;font-size:12px;display:none
}

/* MODAL */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:999}
.modal-content{background:#020617;padding:20px;border-radius:16px;width:420px;max-width:95%}

.item{display:flex;justify-content:space-between;margin-bottom:6px}
.item button{background:#ef4444;color:#fff;border:none;border-radius:6px;padding:2px 8px}

/* FORM */
.form input,.form select{
width:100%;padding:10px;margin-bottom:10px;border-radius:10px;border:none
}

/* GALERIA */
.modal-imagem{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;z-index:2000}
.galeria{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center}
.galeria img{max-width:90%;max-height:80%;border-radius:14px}
.fechar{position:absolute;top:16px;right:16px;font-size:28px;cursor:pointer}

.contador{
position:absolute;bottom:70px;
background:rgba(0,0,0,.6);
padding:6px 12px;border-radius:20px;font-size:14px;
}

.indicadores{
position:absolute;bottom:30px;display:flex;gap:10px;
background:rgba(0,0,0,.4);padding:8px 14px;border-radius:30px;
}
.indicadores span{
width:10px;height:10px;border-radius:50%;
background:#64748b;cursor:pointer
}
.indicadores span.ativo{background:#22c55e}
</style>
</head>

<body>

<div id="banner" class="banner"></div>

<div class="topo">
<h1 id="nomeLoja"></h1>
<p id="descLoja"></p>
</div>

<div class="container">
<div id="produtos" class="grid"></div>
</div>

<button id="carrinhoBtn" onclick="abrirCarrinho()">üõí <span id="badge">0</span></button>

<!-- MODAL CARRINHO -->
<div id="modal" class="modal">
<div class="modal-content">
<h3>Carrinho</h3>
<div id="listaCarrinho"></div>
<p><b>Total:</b> R$ <span id="total">0.00</span></p>

<div class="form">
<input id="cliNome" placeholder="Nome completo">
<input id="cliEndereco" placeholder="Rua / Avenida">
<input id="cliNumero" placeholder="N√∫mero">
<input id="cliReferencia" placeholder="Ponto de refer√™ncia">

<button class="botao" onclick="usarLocalizacao()">üìç Usar minha localiza√ß√£o</button>

<select id="pagamento">
<option>PIX</option>
<option>Cart√£o</option>
<option>Dinheiro</option>
</select>

<div id="trocoBox" style="display:none">
<select id="precisaTroco" onchange="toggleTrocoValor()">
<option value="">Precisa de troco?</option>
<option value="nao">N√£o</option>
<option value="sim">Sim</option>
</select>
<input id="trocoValor" placeholder="Troco para quanto?" style="display:none">
</div>

<button class="botao" onclick="finalizar()">Enviar no WhatsApp</button>
</div>

<button class="botao" style="background:red" onclick="fecharCarrinho()">Fechar</button>
</div>
</div>

<!-- GALERIA -->
<div class="modal-imagem" id="modalImagem">
<div class="galeria">
<span class="fechar" onclick="fecharImagem()">√ó</span>
<img id="imgZoom">
<div class="contador" id="contador"></div>
<div class="indicadores" id="indicadores"></div>
</div>
</div>

<script>
const sb=supabase.createClient("https://pdajixsoowcyhnjwhgpc.supabase.co","sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw");

const app=new URLSearchParams(location.search).get("app");
if(!app){document.body.innerHTML="Link inv√°lido";throw""}

const carrinhoKey="carrinho_"+app;
let carrinho=JSON.parse(localStorage.getItem(carrinhoKey))||[];
let fotosProduto={},fotosAtuais=[],indice=0,WHATS="";

/* INIT */
async function init(){
const {data:cfg}=await sb.from("config_site").select("*").eq("app_id",app).single();
WHATS=cfg.whatsapp;
nomeLoja.innerText=cfg.nome_site;
descLoja.innerText=cfg.descricao_site||"";
banner.innerHTML=cfg.banner_url?`<img src="${cfg.banner_url}">`:"";

const {data}=await sb.from("produtos").select("*").eq("ativo",true).eq("app_id",app);

produtos.innerHTML=(data||[]).map(p=>{
let fotos=[];
try{fotos=JSON.parse(p.imagens||p.imagem||"[]")}catch{}
if(!Array.isArray(fotos))fotos=[fotos];
fotosProduto[p.id]=fotos;

return `
<div class="card">
${fotos[0]?`<img src="${fotos[0]}" onclick="abrirImagem('${p.id}')">`:""}
<b>${p.nome}</b><br>
R$ ${p.preco.toFixed(2)}
<button class="botao" onclick='add(${JSON.stringify(p)})'>Adicionar</button>
</div>`;
}).join("");

atualizarBadge();
}
init();

/* GALERIA */
function abrirImagem(id){
fotosAtuais=fotosProduto[id];
indice=0;
atualizarImagem();
modalImagem.style.display="flex";
}
function atualizarImagem(){
imgZoom.src=fotosAtuais[indice];
contador.innerText=`${indice+1} / ${fotosAtuais.length}`;
indicadores.innerHTML=fotosAtuais.map((_,i)=>
`<span class="${i===indice?'ativo':''}" onclick="irPara(${i},event)"></span>`
).join("");
}
function irPara(i,e){e.stopPropagation();indice=i;atualizarImagem();}
imgZoom.onclick=()=>{indice=(indice+1)%fotosAtuais.length;atualizarImagem();}
function fecharImagem(){modalImagem.style.display="none"}

/* CARRINHO */
function add(p){
const i=carrinho.find(x=>x.id===p.id);
i?i.qtd++:carrinho.push({...p,qtd:1});
salvar(); atualizarBadge();
}
function salvar(){localStorage.setItem(carrinhoKey,JSON.stringify(carrinho))}
function atualizarBadge(){
const t=carrinho.reduce((s,i)=>s+i.qtd,0);
badge.innerText=t; badge.style.display=t?"block":"none";
}
function abrirCarrinho(){modal.style.display="flex";renderCarrinho();}
function fecharCarrinho(){modal.style.display="none"}
function renderCarrinho(){
let totalValor=0;
listaCarrinho.innerHTML=carrinho.map((i,idx)=>{
totalValor+=i.preco*i.qtd;
return `<div class="item">${i.nome} x${i.qtd} <button onclick="diminuir(${idx})">‚àí</button></div>`;
}).join("");
total.innerText=totalValor.toFixed(2);
}
function diminuir(i){
carrinho[i].qtd--;
if(carrinho[i].qtd<=0)carrinho.splice(i,1);
salvar(); atualizarBadge(); renderCarrinho();
}

/* TROCO */
pagamento.addEventListener("change",()=>{
trocoBox.style.display=pagamento.value==="Dinheiro"?"block":"none";
});
function toggleTrocoValor(){
trocoValor.style.display=precisaTroco.value==="sim"?"block":"none";
}

/* LOCALIZA√á√ÉO */
function usarLocalizacao(){
navigator.geolocation.getCurrentPosition(pos=>{
window.localizacaoLink=`https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
alert("Localiza√ß√£o capturada");
});
}

/* FINALIZAR */
function finalizar(){
if(!carrinho.length){alert("Carrinho vazio");return;}

let endereco=cliEndereco.value;
if(cliNumero.value)endereco+=", N¬∫ "+cliNumero.value;

let msg=`üõçÔ∏è *${nomeLoja.innerText}*\n\n`;
msg+=`üë§ ${cliNome.value}\n`;
msg+=`üè† ${endereco}\n`;
if(cliReferencia.value)msg+=`üìå ${cliReferencia.value}\n`;
if(window.localizacaoLink)msg+=`üìç ${window.localizacaoLink}\n\n`;

carrinho.forEach(i=>msg+=`‚Ä¢ ${i.nome} x${i.qtd}\n`);
msg+=`\nüí∞ Total: R$ ${total.innerText}`;
msg+=`\nüí≥ ${pagamento.value}`;

if(pagamento.value==="Dinheiro"){
if(precisaTroco.value==="sim"){
msg+=`\nüíµ Troco para: R$ ${trocoValor.value}`;
}else{
msg+=`\nüíµ Sem troco`;
}
}

window.open(`https://wa.me/${WHATS}?text=${encodeURIComponent(msg)}`);
carrinho=[]; salvar(); atualizarBadge(); fecharCarrinho();
}
</script>

</body>
</html>
