<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Loja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#fff}
:root{--p:#22c55e;--b:#0f172a;--c:#0f172a}

/* ===== BANNER ===== */
.banner{height:260px;background:#0f172a}
.banner img{width:100%;height:100%;object-fit:cover}

/* ===== TOPO ===== */
.topo{text-align:center;padding:24px;background:#0f172a}

/* ===== GRID ===== */
.container{padding:20px;max-width:1200px;margin:auto}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.card{background:#0f172a;padding:12px;border-radius:14px;text-align:center}
.card img{
  width:100%;height:160px;object-fit:cover;
  border-radius:10px;cursor:pointer
}
.botao{
  margin-top:8px;width:100%;padding:10px;
  border:none;border-radius:10px;
  background:#22c55e;font-weight:bold
}

/* ===== MODAL IMAGEM ===== */
.modal-imagem{
  position:fixed;inset:0;
  background:rgba(0,0,0,.95);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
.galeria{
  position:relative;
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.galeria img{
  max-width:90%;
  max-height:80%;
  border-radius:14px;
}

/* FECHAR */
.fechar{
  position:absolute;
  top:16px;right:16px;
  font-size:28px;
  cursor:pointer;
}

/* ===== CONTADOR ===== */
.contador{
  position:absolute;
  bottom:70px;
  background:rgba(0,0,0,.6);
  padding:6px 12px;
  border-radius:20px;
  font-size:14px;
}

/* ===== BOLINHAS ===== */
.indicadores{
  position:absolute;
  bottom:30px;
  display:flex;
  gap:10px;
  background:rgba(0,0,0,.4);
  padding:8px 14px;
  border-radius:30px;
}
.indicadores span{
  width:10px;height:10px;
  border-radius:50%;
  background:#64748b;
  cursor:pointer;
}
.indicadores span.ativo{
  background:#22c55e;
}
</style>
</head>

<body>

<div id="banner" class="banner"></div>

<div class="topo">
  <h1 id="nomeLoja"></h1>
  <p id="descLoja"></p>
</div>

<div class="container">
  <div id="produtos" class="grid"></div>
</div>

<!-- MODAL IMAGEM -->
<div class="modal-imagem" id="modalImagem">
  <div class="galeria"
       ontouchstart="touchStart(event)"
       ontouchend="touchEnd(event)">
    <span class="fechar" onclick="fecharImagem()">×</span>
    <img id="imgZoom" loading="lazy">
    <div class="contador" id="contador"></div>
    <div class="indicadores" id="indicadores"></div>
  </div>
</div>

<script>
/* ===== SUPABASE ===== */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const app = new URLSearchParams(location.search).get("app");
if(!app){document.body.innerHTML="Link inválido";throw""}

/* ===== VARIÁVEIS ===== */
let fotosProduto={},fotosAtuais=[],indice=0,autoPlay=null;
let startX=0;

/* ===== INIT ===== */
async function init(){
  const {data:cfg}=await sb.from("config_site").select("*").eq("app_id",app).single();
  nomeLoja.innerText=cfg.nome_site;
  descLoja.innerText=cfg.descricao_site||"";
  banner.innerHTML=cfg.banner_url?`<img src="${cfg.banner_url}">`:"";

  const {data}=await sb.from("produtos").select("*").eq("ativo",true).eq("app_id",app);

  produtos.innerHTML=(data||[]).map(p=>{
    let fotos=[];
    if(p.imagens){
      try{fotos=JSON.parse(p.imagens)}catch{}
    }else if(p.imagem){
      fotos=[p.imagem];
    }
    fotosProduto[p.id]=fotos;

    return `
      <div class="card">
        ${fotos[0]?`<img src="${fotos[0]}" loading="lazy" onclick="abrirImagem('${p.id}')">`:""}
        <b>${p.nome}</b><br>
        R$ ${p.preco.toFixed(2)}
        <button class="botao">Ver</button>
      </div>
    `;
  }).join("");
}
init();

/* ===== GALERIA ===== */
function abrirImagem(id){
  fotosAtuais=fotosProduto[id];
  indice=0;
  atualizarImagem();
  modalImagem.style.display="flex";

  // autoplay (opcional)
  autoPlay=setInterval(proxima,4000);
}

function atualizarImagem(){
  imgZoom.src=fotosAtuais[indice];
  contador.innerText=`${indice+1} / ${fotosAtuais.length}`;
  indicadores.innerHTML=fotosAtuais.map((_,i)=>
    `<span class="${i===indice?'ativo':''}" onclick="irPara(${i},event)"></span>`
  ).join("");
}

function proxima(){
  indice=(indice+1)%fotosAtuais.length;
  atualizarImagem();
}

function irPara(i,e){
  e.stopPropagation();
  indice=i;
  atualizarImagem();
}

function fecharImagem(){
  modalImagem.style.display="none";
  clearInterval(autoPlay);
}

/* ===== SWIPE ===== */
function touchStart(e){startX=e.changedTouches[0].clientX}
function touchEnd(e){
  const endX=e.changedTouches[0].clientX;
  if(startX-endX>50) proxima();
  if(endX-startX>50){
    indice=(indice-1+fotosAtuais.length)%fotosAtuais.length;
    atualizarImagem();
  }
}
</script>

</body>
</html>
