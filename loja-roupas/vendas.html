<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Loja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#fff}
:root{--p:#22c55e}

/* ===== TEMAS ===== */
body.tema-natal{--p:#ef4444;background:#1a0b0b}
body.tema-anonovo{--p:#22c55e;background:#052e16}
body.tema-saojoao{--p:#f59e0b;background:#2a1505}
body.tema-carnaval{--p:#a855f7;background:#1e0b2e}
body.tema-preto{--p:#000;background:#000}

/* ===== BANNER ===== */
.banner{height:260px;background:#0f172a}
.banner img{width:100%;height:100%;object-fit:cover}

/* ===== TOPO ===== */
.topo{text-align:center;padding:24px;background:#0f172a}

/* ===== GRID ===== */
.container{padding:20px;max-width:1200px;margin:auto}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.card{background:#0f172a;padding:12px;border-radius:14px;text-align:center}
.card img{width:100%;height:160px;object-fit:cover;border-radius:10px;cursor:pointer}
.botao{margin-top:8px;width:100%;padding:10px;border:none;border-radius:10px;background:var(--p);font-weight:bold}

/* ===== BOT√ÉO CARRINHO */
#btnCarrinho{
position:fixed;bottom:20px;right:20px;
width:60px;height:60px;border-radius:50%;
background:var(--p);font-size:22px;border:none
}
#badge{
position:absolute;top:-5px;right:-5px;
background:red;color:#fff;border-radius:50%;
padding:2px 7px;font-size:12px;display:none
}

/* ===== MODAL CARRINHO ===== */
.modalCarrinho{
position:fixed;inset:0;background:rgba(0,0,0,.85);
display:none;align-items:center;justify-content:center;z-index:1500
}
.carrinhoBox{
background:#020617;padding:20px;border-radius:16px;
width:420px;max-width:95%;max-height:90vh;overflow-y:auto
}
.item{display:flex;justify-content:space-between;margin-bottom:6px}
.item button{background:red;color:#fff;border:none;border-radius:6px;padding:2px 8px}

/* ===== FORM ===== */
.form{
background:#0f172a;
padding:20px;
border-radius:18px;
margin-top:16px;
box-shadow:0 15px 40px rgba(0,0,0,.5);
}
.campo{display:flex;flex-direction:column;margin-bottom:16px}
.campo label{font-size:13px;margin-bottom:6px;color:#94a3b8;font-weight:600}
.form input,.form select{
width:100%;padding:14px;border-radius:14px;
border:1px solid #1e293b;background:#0b1220;
color:#fff;font-size:16px;outline:none
}
.linha{display:flex;gap:12px}
.linha .campo{flex:1}
.btnLocal{
width:100%;padding:14px;border-radius:14px;
border:1px solid #334155;background:#1e293b;
color:#fff;font-weight:600;margin-bottom:18px;cursor:pointer
}
.form .botao{
width:100%;padding:16px;border-radius:16px;
background:var(--p);color:#000;font-weight:800;
font-size:17px;border:none;cursor:pointer
}
</style>
</head>

<body>

<div id="banner" class="banner"></div>

<div class="topo">
<h1 id="nomeLoja"></h1>
<p id="descLoja"></p>
</div>

<div class="container">
<div id="produtos" class="grid"></div>
</div>

<button id="btnCarrinho" onclick="abrirCarrinho()">
üõí <span id="badge">0</span>
</button>

<div class="modalCarrinho" id="modalCarrinho">
<div class="carrinhoBox">
<h3>Carrinho</h3>
<div id="listaCarrinho"></div>
<p><b>Total:</b> R$ <span id="total">0.00</span></p>

<div class="form">

<div class="campo">
<label for="cliNome">üë§ Nome completo</label>
<input id="cliNome" name="cliNome">
</div>

<div class="campo">
<label for="cliEndereco">üè† Endere√ßo</label>
<input id="cliEndereco" name="cliEndereco">
</div>

<div class="linha">
<div class="campo">
<label for="cliNumero">üî¢ N√∫mero</label>
<input id="cliNumero" name="cliNumero">
</div>

<div class="campo">
<label for="cliReferencia">üìç Refer√™ncia</label>
<input id="cliReferencia" name="cliReferencia">
</div>
</div>

<button type="button" class="btnLocal" onclick="usarLocalizacao()">
üìç Usar minha localiza√ß√£o
</button>

<div class="campo">
<label for="pagamento">üí≥ Forma de pagamento</label>
<select id="pagamento" onchange="verificarPagamento()">
<option value="PIX">PIX</option>
<option value="Cart√£o">Cart√£o</option>
<option value="Dinheiro">Dinheiro</option>
</select>
</div>

<div id="trocoArea" style="display:none;">
<div class="campo">
<label for="trocoValor">üíµ Troco para quanto?</label>
<input id="trocoValor">
</div>
</div>

<button type="button" class="botao" onclick="finalizar()">
Enviar pedido no WhatsApp
</button>

</div>

<button onclick="fecharCarrinho()">Fechar</button>
</div>
</div>

<script>
const sb = supabase.createClient(
"https://pdajixsoowcyhnjwhgpc.supabase.co",
"sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const app = new URLSearchParams(location.search).get("app");
if(!app){ document.body.innerHTML="Link inv√°lido"; throw new Error("Sem app"); }

const carrinhoKey="carrinho_"+app;
let carrinho=JSON.parse(localStorage.getItem(carrinhoKey))||[];
let WHATS="";

/* INIT */
async function init(){
try{

const {data:cfg,error} = await sb
.from("config_site")
.select("*")
.eq("app_id",app)
.maybeSingle();

if(error || !cfg){
document.body.innerHTML="Loja n√£o encontrada";
return;
}

WHATS = cfg.whatsapp || "";
nomeLoja.innerText = cfg.nome_site || "Loja";
descLoja.innerText = cfg.descricao_site || "";

if(cfg.banner_url){
banner.innerHTML = `<img src="${cfg.banner_url}">`;
}

if(cfg.tema_site && cfg.tema_site!=="padrao"){
document.body.classList.add("tema-"+cfg.tema_site);
}

/* PRODUTOS */
const {data:produtosData} = await sb
.from("produtos")
.select("*")
.eq("ativo",true)
.eq("app_id",app);

produtos.innerHTML = (produtosData||[]).map(p=>{

let foto="";
if(p.imagem) foto=p.imagem;
else if(p.imagem_url) foto=p.imagem_url;
else if(p.imagens){
try{
const arr=Array.isArray(p.imagens)?p.imagens:JSON.parse(p.imagens);
if(arr.length) foto=arr[0];
}catch{}
}

return `
<div class="card">
${foto?`<img src="${foto}">`:""}
<b>${p.nome}</b><br>
R$ ${Number(p.preco).toFixed(2)}
<button class="botao" onclick='add(${JSON.stringify(p)})'>
Adicionar
</button>
</div>
`;
}).join("");

atualizarBadge();

}catch(e){
console.error(e);
document.body.innerHTML="Erro ao carregar loja";
}
}

init();

/* CARRINHO */
function add(p){
const i=carrinho.find(x=>x.id===p.id);
i?i.qtd++:carrinho.push({...p,qtd:1});
salvar();
}
function salvar(){
localStorage.setItem(carrinhoKey,JSON.stringify(carrinho));
atualizarBadge();
}
function atualizarBadge(){
const t=carrinho.reduce((s,i)=>s+i.qtd,0);
badge.innerText=t;
badge.style.display=t?"block":"none";
}
function abrirCarrinho(){
renderCarrinho();
modalCarrinho.style.display="flex";
}
function fecharCarrinho(){
modalCarrinho.style.display="none";
}
function renderCarrinho(){
let s=0;
listaCarrinho.innerHTML=carrinho.map((i,idx)=>{
s+=i.preco*i.qtd;
return `<div class="item">${i.nome} x${i.qtd}
<button onclick="diminuir(${idx})">‚àí</button></div>`;
}).join("");
total.innerText=s.toFixed(2);
}
function diminuir(i){
carrinho[i].qtd--;
if(carrinho[i].qtd<=0)carrinho.splice(i,1);
salvar();renderCarrinho();
}

/* PAGAMENTO */
function verificarPagamento(){
if(pagamento.value==="Dinheiro"){
trocoArea.style.display="block";
}else{
trocoArea.style.display="none";
trocoValor.value="";
}
}

/* FINALIZAR */
function finalizar(){
if(!carrinho.length) return alert("Carrinho vazio");

let endereco=cliEndereco.value;
if(cliNumero.value) endereco+=", N¬∫ "+cliNumero.value;

let msg=`üõçÔ∏è *${nomeLoja.innerText}*\n\n`;
msg+=`üë§ ${cliNome.value}\n`;
msg+=`üè† ${endereco}\n`;
if(cliReferencia.value) msg+=`üìç ${cliReferencia.value}\n\n`;

carrinho.forEach(i=>msg+=`‚Ä¢ ${i.nome} x${i.qtd}\n`);
msg+=`\nüí∞ Total: R$ ${total.innerText}\nüí≥ ${pagamento.value}`;

if(pagamento.value==="Dinheiro" && trocoValor.value){
msg+=`\nüíµ Troco para: R$ ${trocoValor.value}`;
}

window.open(`https://wa.me/${WHATS}?text=${encodeURIComponent(msg)}`);

carrinho=[];salvar();renderCarrinho();fecharCarrinho();
}
</script>

</body>
</html>
