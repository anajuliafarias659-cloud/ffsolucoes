<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Loja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#fff}
:root{--p:#22c55e}

.banner{height:260px;background:#0f172a}
.banner img{width:100%;height:100%;object-fit:cover}

.topo{text-align:center;padding:24px;background:#0f172a}

.container{padding:20px;max-width:1200px;margin:auto}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.card{background:#0f172a;padding:12px;border-radius:14px;text-align:center}
.card img{width:100%;height:160px;object-fit:cover;border-radius:10px;cursor:pointer}
.botao{margin-top:8px;width:100%;padding:10px;border:none;border-radius:10px;background:#22c55e;font-weight:bold}

#btnCarrinho{
position:fixed;bottom:20px;right:20px;
width:60px;height:60px;border-radius:50%;
background:#22c55e;font-size:22px;border:none
}
#badge{
position:absolute;top:-5px;right:-5px;
background:red;color:#fff;border-radius:50%;
padding:2px 7px;font-size:12px;display:none
}

.modalCarrinho{
position:fixed;inset:0;background:rgba(0,0,0,.85);
display:none;align-items:center;justify-content:center;z-index:1500
}
.carrinhoBox{
background:#020617;padding:20px;border-radius:16px;
width:420px;max-width:95%
}
.item{display:flex;justify-content:space-between;margin-bottom:6px}
.item button{background:red;color:#fff;border:none;border-radius:6px;padding:2px 8px}

.form input, .form select{
width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:none
}

.modalImagem{
position:fixed;inset:0;background:rgba(0,0,0,.95);
display:none;align-items:center;justify-content:center;z-index:2000
}
.galeria{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center}
.galeria img{max-width:90%;max-height:80%;border-radius:14px}
.fechar{position:absolute;top:16px;right:16px;font-size:28px;cursor:pointer}
.contador{position:absolute;bottom:70px;background:rgba(0,0,0,.6);padding:6px 12px;border-radius:20px}
.indicadores{position:absolute;bottom:30px;display:flex;gap:10px;background:rgba(0,0,0,.4);padding:8px 14px;border-radius:30px}
.indicadores span{width:10px;height:10px;border-radius:50%;background:#64748b;cursor:pointer}
.indicadores span.ativo{background:#22c55e}
</style>
</head>

<body>

<div id="banner" class="banner"></div>

<div class="topo">
<h1 id="nomeLoja"></h1>
<p id="descLoja"></p>
</div>

<div class="container">
<div id="produtos" class="grid"></div>
</div>

<button id="btnCarrinho" onclick="abrirCarrinho()">
üõí <span id="badge">0</span>
</button>

<div class="modalCarrinho" id="modalCarrinho">
<div class="carrinhoBox">
<h3>Carrinho</h3>
<div id="listaCarrinho"></div>
<p><b>Total:</b> R$ <span id="total">0.00</span></p>

<div class="form">
<input id="cliNome" placeholder="Nome">
<input id="cliEndereco" placeholder="Endere√ßo">
<input id="cliReferencia" placeholder="Refer√™ncia">
<button onclick="usarLocalizacao()">üìç Usar localiza√ß√£o</button>

<select id="pagamento">
<option>PIX</option>
<option>Cart√£o</option>
<option>Dinheiro</option>
</select>

<button class="botao" onclick="finalizar()">Enviar no WhatsApp</button>
</div>

<button onclick="fecharCarrinho()">Fechar</button>
</div>
</div>

<div class="modalImagem" id="modalImagem">
<div class="galeria">
<span class="fechar" onclick="fecharImagem()">√ó</span>
<img id="imgZoom">
<div class="contador" id="contador"></div>
<div class="indicadores" id="indicadores"></div>
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async function(){

const sb = supabase.createClient(
"https://pdajixsoowcyhnjwhgpc.supabase.co",
"sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const app = new URLSearchParams(location.search).get("app");
if(!app){ document.body.innerHTML="Link inv√°lido"; return; }

const carrinhoKey="carrinho_"+app;
let carrinho=JSON.parse(localStorage.getItem(carrinhoKey))||[];

let fotosProduto={},fotosAtuais=[],indice=0,autoPlay=null,WHATS="";

/* ===== EXTRAIR FOTOS SEGURO ===== */
function extrairFotos(p){
let f=[];
try{
if(p.imagens) f=typeof p.imagens==="string"?JSON.parse(p.imagens):p.imagens;
else if(p.imagem) f=[p.imagem];
}catch{}
return Array.isArray(f)?f.filter(Boolean):[];
}

/* ===== INIT ===== */
async function init(){

const {data:cfg}=await sb.from("config_site")
.select("*")
.eq("app_id",app)
.maybeSingle();

if(!cfg){ alert("Configura√ß√£o n√£o encontrada"); return; }

WHATS=cfg.whatsapp||"";
nomeLoja.innerText=cfg.nome_site||"Loja";
descLoja.innerText=cfg.descricao_site||"";
banner.innerHTML=cfg.banner_url?`<img src="${cfg.banner_url}">`:"";

const {data}=await sb.from("produtos")
.select("*")
.eq("ativo",true)
.eq("app_id",app);

produtos.innerHTML=(data||[]).map(p=>{
const fotos=extrairFotos(p);
fotosProduto[p.id]=fotos;

return `
<div class="card">
${fotos[0]?`<img src="${fotos[0]}" onclick="abrirImagem('${p.id}')">`:`<div style="height:160px;display:flex;align-items:center;justify-content:center;opacity:.4">Sem imagem</div>`}
<b>${p.nome}</b><br>
R$ ${Number(p.preco||0).toFixed(2)}
<button class="botao" onclick='add(${JSON.stringify(p)})'>Adicionar</button>
</div>`;
}).join("");

atualizarBadge();
}

init();

/* ===== GALERIA ===== */
window.abrirImagem=function(id){
fotosAtuais=fotosProduto[id]||[];
if(!fotosAtuais.length)return;
indice=0;
atualizarImagem();
modalImagem.style.display="flex";
clearInterval(autoPlay);
autoPlay=setInterval(proxima,4000);
}

function atualizarImagem(){
imgZoom.src=fotosAtuais[indice];
contador.innerText=`${indice+1} / ${fotosAtuais.length}`;
indicadores.innerHTML=fotosAtuais.map((_,i)=>
`<span class="${i===indice?'ativo':''}" onclick="irPara(${i},event)"></span>`
).join("");
}

window.irPara=function(i,e){
e.stopPropagation();
indice=i;
atualizarImagem();
}

function proxima(){
indice=(indice+1)%fotosAtuais.length;
atualizarImagem();
}

window.fecharImagem=function(){
modalImagem.style.display="none";
clearInterval(autoPlay);
}

/* ===== CARRINHO ===== */
window.add=function(p){
const i=carrinho.find(x=>x.id===p.id);
i?i.qtd++:carrinho.push({...p,qtd:1});
salvar();
}

function salvar(){
localStorage.setItem(carrinhoKey,JSON.stringify(carrinho));
atualizarBadge();
}

function atualizarBadge(){
const t=carrinho.reduce((s,i)=>s+i.qtd,0);
badge.innerText=t;
badge.style.display=t?"block":"none";
}

window.abrirCarrinho=function(){
renderCarrinho();
modalCarrinho.style.display="flex";
}

window.fecharCarrinho=function(){
modalCarrinho.style.display="none";
}

function renderCarrinho(){
let s=0;
listaCarrinho.innerHTML=carrinho.map((i,idx)=>{
s+=i.preco*i.qtd;
return `<div class="item">${i.nome} x${i.qtd} <button onclick="diminuir(${idx})">‚àí</button></div>`;
}).join("");
total.innerText=s.toFixed(2);
}

window.diminuir=function(i){
carrinho[i].qtd--;
if(carrinho[i].qtd<=0)carrinho.splice(i,1);
salvar();
renderCarrinho();
}

/* ===== LOCALIZA√á√ÉO ===== */
window.usarLocalizacao=function(){
navigator.geolocation.getCurrentPosition(pos=>{
cliReferencia.value=`https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
});
}

/* ===== FINALIZAR ===== */
window.finalizar=function(){
if(!carrinho.length) return alert("Carrinho vazio");
if(!WHATS) return alert("WhatsApp n√£o configurado");

let msg=`üõçÔ∏è *${nomeLoja.innerText}*\n\n`;
msg+=`üë§ ${cliNome.value}\n`;
msg+=`üè† ${cliEndereco.value}\n`;
msg+=`üìç ${cliReferencia.value}\n\n`;

carrinho.forEach(i=>msg+=`‚Ä¢ ${i.nome} x${i.qtd}\n`);
msg+=`\nüí∞ Total: R$ ${total.innerText}\nüí≥ ${pagamento.value}`;

window.open(`https://wa.me/${WHATS}?text=${encodeURIComponent(msg)}`);

carrinho=[];
salvar();
renderCarrinho();
fecharCarrinho();
}

});
</script>

</body>
</html>
