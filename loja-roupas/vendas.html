<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Loja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#fff}
:root{--p:#22c55e;--b:#0f172a;--c:#0f172a}

/* BANNER */
.banner{height:260px;background:var(--b)}
.banner img{width:100%;height:100%;object-fit:cover}

/* TOPO */
.topo{text-align:center;padding:24px;background:var(--b)}

/* GRID */
.container{padding:20px;max-width:1200px;margin:auto}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.card{background:var(--c);padding:12px;border-radius:14px;text-align:center}
.card img{width:100%;height:160px;object-fit:cover;border-radius:10px;cursor:pointer}
.botao{margin-top:8px;width:100%;padding:10px;border:none;border-radius:10px;background:var(--p);font-weight:bold}

/* CARRINHO */
#carrinhoBtn{
  position:fixed;bottom:20px;right:20px;
  width:60px;height:60px;border-radius:50%;
  background:#22c55e;font-size:22px;border:none
}
#badge{
  position:absolute;top:-5px;right:-5px;
  background:red;color:#fff;border-radius:50%;
  padding:2px 7px;font-size:12px;display:none
}

/* MODAL IMAGEM */
.modal-imagem{
  position:fixed;inset:0;background:rgba(0,0,0,.9);
  display:none;align-items:center;justify-content:center;
  flex-direction:column;z-index:2000;
}
.modal-imagem img{
  max-width:90%;
  max-height:80%;
  border-radius:12px;
  cursor:pointer;
}
.modal-imagem span{
  position:absolute;top:16px;right:16px;
  font-size:28px;cursor:pointer
}

/* BOLINHAS */
.indicadores{
  margin-top:14px;
  display:flex;
  gap:8px;
}
.indicadores span{
  width:10px;height:10px;border-radius:50%;
  background:#64748b;cursor:pointer
}
.indicadores span.ativo{background:#22c55e}
</style>
</head>

<body>

<div id="banner" class="banner"></div>

<div class="topo">
  <h1 id="nomeLoja">Loja</h1>
  <p id="descLoja"></p>
</div>

<div class="container">
  <div id="produtos" class="grid"></div>
</div>

<button id="carrinhoBtn" onclick="abrirCarrinho()">üõí <span id="badge">0</span></button>

<!-- MODAL IMAGEM -->
<div class="modal-imagem" id="modalImagem" onclick="fecharImagem()">
  <span>&times;</span>
  <img id="imgZoom">
  <div class="indicadores" id="indicadores"></div>
</div>

<script>
/* SUPABASE */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const params = new URLSearchParams(location.search);
const APP_ID = params.get("app");
if(!APP_ID){document.body.innerHTML="Link inv√°lido";throw""}

/* VARI√ÅVEIS */
let carrinho=[];
let fotosProduto={};
let fotosAtuais=[];
let indice=0;

/* INIT */
async function init(){
  const {data:cfg}=await sb.from("config_site").select("*").eq("app_id",APP_ID).single();
  nomeLoja.innerText=cfg.nome_site;
  descLoja.innerText=cfg.descricao_site||"";
  banner.innerHTML=cfg.banner_url?`<img src="${cfg.banner_url}">`:"";

  const {data}=await sb.from("produtos").select("*").eq("ativo",true).eq("app_id",APP_ID);

  produtos.innerHTML=(data||[]).map(p=>{
    let fotos=[];
    if(p.imagens){
      try{fotos=JSON.parse(p.imagens)}catch{}
    }else if(p.imagem){
      fotos=[p.imagem];
    }
    fotosProduto[p.id]=fotos;

    return `
      <div class="card">
        ${fotos[0]?`<img src="${fotos[0]}" onclick="abrirImagem('${p.id}')">`:""}
        <b>${p.nome}</b><br>
        R$ ${p.preco.toFixed(2)}
        <button class="botao" onclick='add(${JSON.stringify(p)})'>Adicionar</button>
      </div>
    `;
  }).join("");
}
init();

/* GALERIA */
function abrirImagem(id){
  fotosAtuais=fotosProduto[id]||[];
  if(!fotosAtuais.length) return;
  indice=0;
  imgZoom.src=fotosAtuais[0];
  modalImagem.style.display="flex";
  renderIndicadores();
}

function renderIndicadores(){
  indicadores.innerHTML="";
  fotosAtuais.forEach((_,i)=>{
    indicadores.innerHTML+=
      `<span class="${i===indice?'ativo':''}" onclick="mudarImagem(${i},event)"></span>`;
  });
}

function mudarImagem(i,e){
  e.stopPropagation();
  indice=i;
  imgZoom.src=fotosAtuais[indice];
  renderIndicadores();
}

imgZoom.onclick=e=>{
  e.stopPropagation();
  indice=(indice+1)%fotosAtuais.length;
  imgZoom.src=fotosAtuais[indice];
  renderIndicadores();
};

function fecharImagem(){
  modalImagem.style.display="none";
  indicadores.innerHTML="";
}

/* CARRINHO */
function add(p){
  const i=carrinho.find(x=>x.id===p.id);
  i?i.qtd++:carrinho.push({...p,qtd:1});
  atualizarBadge();
}

function atualizarBadge(){
  const t=carrinho.reduce((s,i)=>s+i.qtd,0);
  badge.innerText=t;
  badge.style.display=t?"block":"none";
}

function abrirCarrinho(){
  alert("Carrinho funcionando üëç");
}
</script>

</body>
</html>
