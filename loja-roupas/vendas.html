<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Loja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#fff}
:root{--p:#22c55e;--b:#0f172a;--c:#0f172a}

.banner{height:260px;background:var(--b)}
.banner img{width:100%;height:100%;object-fit:cover}

.topo{text-align:center;padding:24px;background:var(--b)}

.container{padding:20px;max-width:1200px;margin:auto}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}

.card{
  background:var(--c);
  padding:12px;
  border-radius:14px;
  text-align:center
}
.card img{
  width:100%;
  height:160px;
  object-fit:cover;
  border-radius:10px;
  cursor:pointer
}

.botao{
  margin-top:8px;width:100%;padding:10px;
  border:none;border-radius:10px;
  background:var(--p);font-weight:bold
}

#carrinhoBtn{
  position:fixed;bottom:20px;right:20px;
  width:60px;height:60px;border-radius:50%;
  background:#22c55e;font-size:22px;border:none
}
#badge{
  position:absolute;top:-5px;right:-5px;
  background:red;color:#fff;border-radius:50%;
  padding:2px 7px;font-size:12px;display:none
}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:999}
.modal-content{background:#020617;padding:20px;border-radius:16px;width:420px;max-width:95%}
.item{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.item button{background:#ef4444;color:#fff;border:none;border-radius:6px;padding:2px 8px}

/* ===== MODAL IMAGEM ===== */
.modal-imagem{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000
}
.modal-imagem img{
  max-width:95%;
  max-height:95%;
  border-radius:14px;
  cursor:pointer
}
.modal-imagem span{
  position:absolute;
  top:16px;
  right:16px;
  font-size:28px;
  cursor:pointer;
  color:#fff
}

.form-finalizacao{
  background:linear-gradient(180deg,#dcfce7,#bbf7d0);
  color:#064e3b;
  padding:18px;border-radius:18px;margin-top:14px
}
.form-finalizacao input,
.form-finalizacao select{
  width:100%;padding:12px;margin-bottom:12px;
  border-radius:12px;border:1px solid #86efac
}
</style>
</head>

<body>

<div id="banner" class="banner"></div>

<div class="topo">
  <h1 id="nomeLoja">Loja</h1>
  <p id="descLoja"></p>
</div>

<div class="container">
  <div id="produtos" class="grid"></div>
</div>

<button id="carrinhoBtn" onclick="abrirCarrinho()">ðŸ›’ <span id="badge">0</span></button>

<!-- ===== MODAL CARRINHO ===== -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Carrinho</h3>
    <div id="listaCarrinho"></div>
    <p><b>Total:</b> R$ <span id="total">0.00</span></p>
    <button class="botao" style="background:red" onclick="fecharCarrinho()">Fechar</button>
  </div>
</div>

<!-- ===== MODAL IMAGEM ===== -->
<div class="modal-imagem" id="modalImagem" onclick="fecharImagem()">
  <span>&times;</span>
  <img id="imgZoom">
</div>

<script>
const sb=supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const params=new URLSearchParams(location.search);
const APP_ID=params.get("app")||localStorage.getItem("APP_ID");
if(!APP_ID){document.body.innerHTML="Link invÃ¡lido";throw""}
localStorage.setItem("APP_ID",APP_ID);

let carrinho=JSON.parse(localStorage.getItem("carrinho_"+APP_ID))||[];

let WHATS="",NOME="";
const fotosProduto={};
let fotosAtuais=[],indice=0;

async function init(){
  const {data:cfg}=await sb.from("config_site").select("*").eq("app_id",APP_ID).single();
  WHATS=cfg.whatsapp; NOME=cfg.nome_site;

  nomeLoja.innerText=cfg.nome_site;
  descLoja.innerText=cfg.descricao_site||"";
  banner.innerHTML=cfg.banner_url?`<img src="${cfg.banner_url}">`:"";

  const {data}=await sb.from("produtos").select("*").eq("ativo",true).eq("app_id",APP_ID);

  produtos.innerHTML=data.map(p=>{
    let fotos=[];
    try{fotos=JSON.parse(p.imagem)}catch{fotos=p.imagem?[p.imagem]:[]}
    fotosProduto[p.id]=fotos;

    return `
      <div class="card">
        ${fotos[0]?`<img src="${fotos[0]}" onclick="abrirImagem('${p.id}')">`:""}
        <b>${p.nome}</b><br>
        R$ ${p.preco.toFixed(2)}
        <button class="botao" onclick='add(${JSON.stringify(p)})'>Adicionar</button>
      </div>`;
  }).join("");

  atualizarBadge();
}

/* ===== GALERIA ===== */
function abrirImagem(id){
  fotosAtuais=fotosProduto[id];
  indice=0;
  imgZoom.src=fotosAtuais[0];
  modalImagem.style.display="flex";
}
imgZoom.onclick=e=>{
  e.stopPropagation();
  indice=(indice+1)%fotosAtuais.length;
  imgZoom.src=fotosAtuais[indice];
}
function fecharImagem(){
  modalImagem.style.display="none";
  imgZoom.src="";
}

/* ===== CARRINHO ===== */
function add(p){
  const it=carrinho.find(i=>i.id==p.id);
  it?it.qtd++:carrinho.push({...p,qtd:1});
  salvar(); atualizarBadge();
}
function diminuir(i){
  carrinho[i].qtd--;
  if(carrinho[i].qtd<=0) carrinho.splice(i,1);
  salvar(); atualizarBadge(); renderCarrinho();
}
function salvar(){
  localStorage.setItem("carrinho_"+APP_ID,JSON.stringify(carrinho));
}
function atualizarBadge(){
  const t=carrinho.reduce((s,i)=>s+i.qtd,0);
  badge.innerText=t;
  badge.style.display=t?"block":"none";
}
function abrirCarrinho(){
  modal.style.display="flex";
  renderCarrinho();
}
function fecharCarrinho(){modal.style.display="none"}
function renderCarrinho(){
  let s=0;
  listaCarrinho.innerHTML=carrinho.map((i,idx)=>{
    s+=i.preco*i.qtd;
    return `<div class="item">${i.nome} x${i.qtd} <button onclick="diminuir(${idx})">âˆ’</button></div>`;
  }).join("");
  total.innerText=s.toFixed(2);
}

init();
</script>

</body>
</html>
