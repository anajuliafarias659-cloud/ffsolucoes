<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Loja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#fff}
:root{--p:#22c55e;--b:#0f172a;--c:#0f172a}

/* ===== BANNER ===== */
.banner{height:260px;background:var(--b)}
.banner img{width:100%;height:100%;object-fit:cover}

/* ===== TOPO ===== */
.topo{text-align:center;padding:24px;background:var(--b)}

/* ===== GRID ===== */
.container{padding:20px;max-width:1200px;margin:auto}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.card{background:var(--c);padding:12px;border-radius:14px;text-align:center}
.card img{width:100%;height:160px;object-fit:cover;border-radius:10px;cursor:pointer}
.botao{margin-top:8px;width:100%;padding:10px;border:none;border-radius:10px;background:var(--p);font-weight:bold}

/* ===== CARRINHO ===== */
#carrinhoBtn{
  position:fixed;bottom:20px;right:20px;
  width:60px;height:60px;border-radius:50%;
  background:#22c55e;font-size:22px;border:none
}
#badge{
  position:absolute;top:-5px;right:-5px;
  background:red;color:#fff;border-radius:50%;
  padding:2px 7px;font-size:12px;display:none
}

/* ===== MODAL CARRINHO ===== */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#020617;padding:20px;border-radius:16px;width:420px;max-width:95%}
.item{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.item button{background:#ef4444;color:#fff;border:none;border-radius:6px;padding:2px 8px}

/* ===== FORM ===== */
.form input,select{
  width:100%;padding:10px;margin-bottom:10px;
  border-radius:8px;border:none;background:#0f172a;color:#fff
}

/* ===== MODAL IMAGEM ===== */
.modal-img{
  position:fixed;inset:0;background:rgba(0,0,0,.9);
  display:none;align-items:center;justify-content:center;
  z-index:2000;flex-direction:column
}
.modal-img img{max-width:90%;max-height:80%;border-radius:12px}
.modal-img span{
  position:absolute;top:16px;right:16px;
  font-size:28px;cursor:pointer
}

/* ===== BOLINHAS ===== */
.dots{display:flex;gap:8px;margin-top:12px}
.dots span{
  width:10px;height:10px;border-radius:50%;
  background:#64748b;cursor:pointer
}
.dots span.active{background:#22c55e}
</style>
</head>

<body>

<div id="banner" class="banner"></div>

<div class="topo">
  <h1 id="nomeLoja">Loja</h1>
  <p id="descLoja"></p>
</div>

<div class="container">
  <div id="produtos" class="grid"></div>
</div>

<button id="carrinhoBtn" onclick="abrirCarrinho()">üõí <span id="badge">0</span></button>

<!-- MODAL IMAGEM -->
<div class="modal-img" id="modalImg" onclick="fecharImagem()">
  <span>&times;</span>
  <img id="imgZoom">
  <div class="dots" id="dots"></div>
</div>

<!-- MODAL CARRINHO -->
<div class="modal" id="modalCarrinho">
  <div class="modal-content">
    <h3>üõí Carrinho</h3>
    <div id="listaCarrinho"></div>
    <p><b>Total:</b> R$ <span id="total">0.00</span></p>

    <div class="form">
      <input id="cliNome" placeholder="Nome">
      <input id="cliEndereco" placeholder="Endere√ßo">
      <input id="cliReferencia" placeholder="Refer√™ncia">
      <button class="botao" onclick="pegarLocalizacao()">üìç Usar localiza√ß√£o</button>

      <select id="pagamento">
        <option>PIX</option>
        <option>Cart√£o</option>
        <option>Dinheiro</option>
      </select>

      <button class="botao" onclick="finalizar()">Enviar WhatsApp</button>
    </div>

    <button class="botao" style="background:#ef4444" onclick="fecharCarrinho()">Fechar</button>
  </div>
</div>

<script>
const sb=supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const APP_ID=new URLSearchParams(location.search).get("app");
if(!APP_ID){document.body.innerHTML="Link inv√°lido";throw""}

let carrinho=JSON.parse(localStorage.getItem("carrinho_"+APP_ID))||[];
let fotosProduto={}, fotosAtuais=[], indice=0;
let WHATS="", NOME="";

/* ===== INIT ===== */
(async()=>{
  const {data:cfg}=await sb.from("config_site").select("*").eq("app_id",APP_ID).single();
  NOME=cfg.nome_site; WHATS=cfg.whatsapp;
  nomeLoja.innerText=cfg.nome_site;
  descLoja.innerText=cfg.descricao_site||"";
  banner.innerHTML=cfg.banner_url?`<img src="${cfg.banner_url}">`:"";

  const {data}=await sb.from("produtos").select("*").eq("ativo",true).eq("app_id",APP_ID);

  produtos.innerHTML=data.map(p=>{
    let imgs=[];
    try{imgs=JSON.parse(p.imagens||"[]")}catch{}
    fotosProduto[p.id]=imgs;

    return `
      <div class="card">
        ${imgs[0]?`<img src="${imgs[0]}" onclick="abrirImagem('${p.id}')">`:""}
        <b>${p.nome}</b><br>
        R$ ${p.preco.toFixed(2)}
        <button class="botao" onclick='add(${JSON.stringify(p)})'>Adicionar</button>
      </div>`;
  }).join("");

  atualizarBadge();
})();

/* ===== GALERIA ===== */
function abrirImagem(id){
  fotosAtuais=fotosProduto[id];
  indice=0;
  imgZoom.src=fotosAtuais[0];
  modalImg.style.display="flex";
  renderDots();
}
function renderDots(){
  dots.innerHTML="";
  fotosAtuais.forEach((_,i)=>{
    dots.innerHTML+=`<span class="${i===indice?'active':''}" onclick="mudar(${i},event)"></span>`;
  });
}
function mudar(i,e){
  e.stopPropagation();
  indice=i;
  imgZoom.src=fotosAtuais[i];
  renderDots();
}
imgZoom.onclick=e=>{
  e.stopPropagation();
  indice=(indice+1)%fotosAtuais.length;
  imgZoom.src=fotosAtuais[indice];
  renderDots();
};
function fecharImagem(){modalImg.style.display="none"}

/* ===== CARRINHO ===== */
function add(p){
  const i=carrinho.find(x=>x.id===p.id);
  i?i.qtd++:carrinho.push({...p,qtd:1});
  salvarCarrinho();
}
function salvarCarrinho(){
  localStorage.setItem("carrinho_"+APP_ID,JSON.stringify(carrinho));
  atualizarBadge();
}
function atualizarBadge(){
  const t=carrinho.reduce((s,i)=>s+i.qtd,0);
  badge.innerText=t;
  badge.style.display=t?"block":"none";
}
function abrirCarrinho(){
  modalCarrinho.style.display="flex";
  renderCarrinho();
}
function fecharCarrinho(){modalCarrinho.style.display="none"}
function renderCarrinho(){
  let total=0;
  listaCarrinho.innerHTML=carrinho.map((i,idx)=>{
    total+=i.preco*i.qtd;
    return `<div class="item">${i.nome} x${i.qtd}
      <button onclick="remover(${idx})">‚àí</button></div>`;
  }).join("");
  document.getElementById("total").innerText=total.toFixed(2);
}
function remover(i){
  carrinho[i].qtd--;
  if(carrinho[i].qtd<=0)carrinho.splice(i,1);
  salvarCarrinho(); renderCarrinho();
}

/* ===== LOCALIZA√á√ÉO ===== */
function pegarLocalizacao(){
  navigator.geolocation.getCurrentPosition(pos=>{
    localStorage.setItem("loc_"+APP_ID,
      `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`);
    alert("Localiza√ß√£o capturada");
  });
}

/* ===== FINALIZAR ===== */
function finalizar(){
  let msg=`üõçÔ∏è *${NOME}*\n\n`;
  carrinho.forEach(i=>msg+=`‚Ä¢ ${i.nome} x${i.qtd}\n`);
  msg+=`\nüí∞ Total: R$ ${total.innerText}`;
  msg+=`\nüë§ ${cliNome.value}`;
  msg+=`\nüè† ${cliEndereco.value}`;
  msg+=`\nüìç ${localStorage.getItem("loc_"+APP_ID)||""}`;

  window.open(`https://wa.me/${WHATS}?text=${encodeURIComponent(msg)}`);
  carrinho=[]; salvarCarrinho(); fecharCarrinho();
}
</script>

</body>
</html>
