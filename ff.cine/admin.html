<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Admin ‚Ä¢ Servi√ßos</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0b1b29;
  color:#fff;
  padding:20px;
}
h1{
  text-align:center;
  color:#1de9b6;
}

.card{
  background:#1e1e1e;
  padding:16px;
  margin-top:15px;
  border-radius:12px;
}

label{
  display:block;
  margin-top:10px;
  font-size:14px;
}

select,textarea,button{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:none;
  margin-top:5px;
}

textarea{
  resize:none;
}

button{
  background:#1de9b6;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}
</style>
</head>

<body>

<h1>üìã Painel de Servi√ßos</h1>
<div id="lista">Verificando acesso...</div>

<script type="module">

/* ================= SUPABASE ================= */
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBgar59yF1k6XmfG0iNOXvWCWKIa9dHcdI",
  authDomain: "servicospc-b3382.firebaseapp.com",
  projectId: "servicospc-b3382"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const lista = document.getElementById("lista");

/* ================= PROTEGER ADMIN ================= */
async function proteger(){

  const { data } = await supabase.auth.getUser();
  const user = data.user;

  if(!user){
    window.location.href = "login-admin.html";
    return;
  }

  const { data: usuario } = await supabase
    .from("usuarios")
    .select("tipo")
    .eq("id", user.id)
    .maybeSingle();

  if(!usuario || usuario.tipo !== "admin"){
    await supabase.auth.signOut();
    window.location.href = "login-admin.html";
    return;
  }

  carregarServicos();
}

/* ================= CARREGAR SERVI√áOS ================= */
async function carregarServicos(){

  lista.innerHTML = "Carregando servi√ßos...";

  const querySnapshot = await getDocs(collection(db, "servicos"));

  lista.innerHTML = "";

  querySnapshot.forEach(docSnap => {

    const dados = docSnap.data();

    lista.innerHTML += `
      <div class="card">
        <strong>C√≥digo:</strong> ${docSnap.id}<br>
        <strong>Nome:</strong> ${dados.nome}<br>
        <strong>Servi√ßo:</strong> ${dados.servico}<br>
        <strong>Status atual:</strong> ${dados.status}<br>

        <label>Status</label>
        <select id="status-${docSnap.id}">
          <option ${dados.status==="Pendente"?"selected":""}>Pendente</option>
          <option ${dados.status==="Em andamento"?"selected":""}>Em andamento</option>
          <option ${dados.status==="Finalizado"?"selected":""}>Finalizado</option>
        </select>

        <label>Descri√ß√£o do Problema</label>
        <textarea id="problema-${docSnap.id}" rows="3">${dados.problema || ""}</textarea>

        <button onclick="atualizar('${docSnap.id}')">Atualizar</button>
      </div>
    `;
  });
}

/* ================= ATUALIZAR ================= */
window.atualizar = async (codigo) => {

  const novoStatus = document.getElementById("status-"+codigo).value;
  const problema = document.getElementById("problema-"+codigo).value;

  await updateDoc(doc(db, "servicos", codigo), {
    status: novoStatus,
    problema: problema
  });

  alert("Atualizado com sucesso!");
  carregarServicos();
};

proteger();

</script>

</body>
</html>
