<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Configurar Site | Mercado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#020617;
  --card:#0f172a;
  --primary:#22c55e;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:var(--bg);
  color:#fff;
}

.topo{
  background:#0f172a;
  padding:18px;
  text-align:center;
}

.container{
  max-width:900px;
  margin:30px auto;
  padding:20px;
}

.box{
  background:var(--card);
  padding:20px;
  border-radius:16px;
  margin-bottom:20px;
}

input,textarea,select,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
  font-family:inherit;
}

input,textarea,select{
  background:#020617;
  color:#fff;
}

textarea{min-height:80px}

button{
  background:var(--primary);
  font-weight:bold;
  cursor:pointer;
}

.preview{
  width:100%;
  height:200px;
  background:#020617;
  background-size:cover;
  background-position:center;
  border-radius:14px;
  margin-top:10px;
  border:1px solid #1e293b;
}

.tema-preview{
  margin-top:10px;
  padding:10px;
  border-radius:12px;
  text-align:center;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="topo">
  <h2>âš™ï¸ Configurar Site do Mercado</h2>
</div>

<div class="container">

<div class="box">
  <h3>ğŸª InformaÃ§Ãµes do Mercado</h3>
  <input id="nome" placeholder="Nome do mercado">
  <input id="descricao" placeholder="DescriÃ§Ã£o curta">
  <textarea id="sobre" placeholder="Sobre o mercado"></textarea>
</div>

<div class="box">
  <h3>ğŸ–¼ï¸ Banner do Site</h3>
  <input type="file" id="bannerFile" accept="image/*">
  <div class="preview" id="preview"></div>
</div>

<div class="box">
  <h3>ğŸ¨ Tema do Site</h3>
  <select id="tema" onchange="previewTema()">
    <option value="padrao">PadrÃ£o</option>
    <option value="saojoao">SÃ£o JoÃ£o</option>
    <option value="natal">Natal</option>
    <option value="anonovo">Ano Novo</option>
    <option value="carnaval">Carnaval</option>
  </select>
  <div class="tema-preview" id="temaPreview">Tema padrÃ£o</div>
</div>

<div class="box">
  <h3>â­ BenefÃ­cios (um por linha)</h3>
  <textarea id="beneficios"
    placeholder="Entrega rÃ¡pida&#10;PreÃ§os justos&#10;Qualidade garantida"></textarea>
</div>

<div class="box">
  <h3>ğŸ“² WhatsApp do Mercado</h3>
  <input id="whatsapp" placeholder="Ex: 88999999999">
</div>

<div class="box">
  <button onclick="salvar()">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
</div>

</div>

<script>
/* ===== VALIDA ADMIN ===== */
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin || admin.tipo!=="mercado"){
  location.href="login.html";
  throw "";
}
const app = admin.app_id;

/* ===== SUPABASE ===== */
const supabaseClient = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

let bannerUrlAtual="";

/* ===== PREVIEW TEMA ===== */
function previewTema(){
  const t=tema.value;
  const map={
    padrao:["#22c55e","#0f172a","PadrÃ£o"],
    saojoao:["#facc15","#7c2d12","ğŸ‰ SÃ£o JoÃ£o"],
    natal:["#dc2626","#14532d","ğŸ„ Natal"],
    anonovo:["#22c55e","#020617","âœ¨ Ano Novo"],
    carnaval:["#ec4899","#581c87","ğŸ­ Carnaval"]
  };
  const [p,b,label]=map[t];
  temaPreview.style.background=`linear-gradient(135deg,${p},${b})`;
  temaPreview.innerText=label;
}

/* ===== CARREGAR CONFIG ===== */
(async()=>{
  const { data } = await supabaseClient
    .from("config_site")
    .select("*")
    .eq("app_id",app)
    .single();

  if(!data) return;

  nome.value=data.nome||"";
  descricao.value=data.descricao||"";
  sobre.value=data.sobre||"";
  whatsapp.value=data.whatsapp||"";
  tema.value=data.tema||"padrao";

  if(data.beneficios){
    beneficios.value=data.beneficios.join("\n");
  }

  if(data.banner){
    bannerUrlAtual=data.banner;
    preview.style.backgroundImage=`url(${data.banner})`;
  }

  previewTema();
})();

/* ===== UPLOAD BANNER ===== */
bannerFile.onchange = async ()=>{
  const file=bannerFile.files[0];
  if(!file) return;

  const path=`${app}/banner_${Date.now()}.jpg`;

  await supabaseClient
    .storage
    .from("site-banners")
    .upload(path,file,{upsert:true});

  bannerUrlAtual=supabaseClient
    .storage
    .from("site-banners")
    .getPublicUrl(path)
    .data.publicUrl;

  preview.style.backgroundImage=`url(${bannerUrlAtual})`;
};

/* ===== SALVAR (GLOBAL â€“ SEM BUG) ===== */
async function salvar(){
  const payload={
    app_id:app,
    nome:nome.value,
    descricao:descricao.value,
    sobre:sobre.value,
    whatsapp:whatsapp.value,
    tema:tema.value,
    banner:bannerUrlAtual,
    beneficios:beneficios.value
      .split("\n")
      .map(b=>b.trim())
      .filter(b=>b)
  };

  const { error } = await supabaseClient
    .from("config_site")
    .upsert(payload,{onConflict:"app_id"});

  if(error){
    console.error(error);
    alert("Erro ao salvar");
    return;
  }

  alert("ConfiguraÃ§Ãµes salvas com sucesso!");
}
</script>

</body>
</html>
