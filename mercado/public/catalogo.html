<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CatÃ¡logo | Mercado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primaria:#22c55e;
  --fundo:#020617;
  --card:#0f172a;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Arial;
  background:var(--fundo);
  color:#fff;
}

/* BANNER */
.banner{
  height:220px;
  background-size:cover;
  background-position:center;
  position:relative;
}
.banner::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(to top,rgba(2,6,23,.9),rgba(2,6,23,.3));
}
.banner-content{
  position:absolute;
  bottom:14px;
  left:14px;
  z-index:2;
}

/* GRID */
.section{padding:16px}
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}
.produto{
  background:var(--card);
  border-radius:10px;
  overflow:hidden;
}
.produto img{
  width:100%;
  height:90px;
  object-fit:cover;
}
.info{padding:6px;text-align:center}
.info h4{margin:4px 0;font-size:12px}
.preco{color:var(--primaria);font-weight:700}

/* CARRINHO */
.carrinho-btn{
  position:fixed;
  bottom:14px;
  right:14px;
  background:var(--primaria);
  padding:14px;
  border-radius:50%;
  font-size:18px;
}

/* MODAL IMAGENS */
.modal{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  z-index:50;
}
.modal .fechar{
  position:absolute;
  top:10px;
  right:14px;
  font-size:30px;
}
.galeria{
  display:flex;
  overflow-x:auto;
  height:100%;
  scroll-snap-type:x mandatory;
}
.galeria img{
  min-width:100%;
  height:100%;
  object-fit:contain;
  scroll-snap-align:center;
}
</style>
</head>

<body>

<div class="banner" id="banner">
  <div class="banner-content">
    <h2 id="nome"></h2>
    <p id="descricao"></p>
  </div>
</div>

<section class="section">
  <h3>ðŸ›’ Produtos</h3>
  <div class="grid" id="listaProdutos"></div>
</section>

<div class="carrinho-btn">ðŸ›’</div>

<!-- MODAL IMAGENS -->
<div class="modal" id="modal">
  <div class="fechar" onclick="fecharModal()">Ã—</div>
  <div class="galeria" id="galeria"></div>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const app = new URLSearchParams(location.search).get("app");
if(!app){ document.body.innerText="App nÃ£o encontrado"; throw ""; }

/* ===== UTIL ===== */
function parseFotos(imagem){
  if(!imagem) return [];
  try{
    const arr = JSON.parse(imagem);
    return Array.isArray(arr) ? arr : [];
  }catch{
    return [imagem];
  }
}

/* CONFIG */
(async()=>{
  const {data}=await sb.from("config_site")
    .select("*").eq("app_id",app).maybeSingle();

  if(!data) return;
  nome.innerText=data.nome_site||"";
  descricao.innerText=data.descricao_site||"";
  if(data.banner_url) banner.style.backgroundImage=`url(${data.banner_url})`;
})();

/* PRODUTOS */
async function carregarProdutos(){
  const {data}=await sb.from("produtos")
    .select("*").eq("app_id",app).eq("ativo",true);

  listaProdutos.innerHTML=data.map(p=>{
    const fotos=parseFotos(p.imagem);
    const capa=fotos[0]||"";
    return `
      <div class="produto" onclick='abrirModal(${JSON.stringify(fotos)})'>
        ${capa?`<img src="${capa}">`:""}
        <div class="info">
          <h4>${p.nome}</h4>
          <div class="preco">R$ ${p.preco.toFixed(2)}</div>
        </div>
      </div>
    `;
  }).join("");
}

/* MODAL */
function abrirModal(fotos){
  galeria.innerHTML=fotos.map(f=>`<img src="${f}">`).join("");
  modal.style.display="block";
}
function fecharModal(){
  modal.style.display="none";
  galeria.innerHTML="";
}

carregarProdutos();
</script>

</body>
</html>
