<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cat√°logo | Mercado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primaria:#22c55e;
  --fundo:#020617;
  --card:#0f172a;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Arial;
  background:var(--fundo);
  color:#fff;
}

/* GRID */
.section{padding:16px}
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}
.produto{
  background:var(--card);
  border-radius:10px;
  overflow:hidden;
}
.produto img{
  width:100%;
  height:90px;
  object-fit:cover;
  cursor:pointer;
}
.info{
  padding:6px;
  text-align:center;
}
.info h4{
  font-size:12px;
  margin:2px 0;
}
.preco{
  color:var(--primaria);
  font-weight:700;
  font-size:13px;
}

/* BOLINHAS */
.dots{
  display:flex;
  justify-content:center;
  gap:4px;
  padding-bottom:6px;
}
.dot{
  width:6px;
  height:6px;
  border-radius:50%;
  background:#475569;
}
.dot.active{
  background:var(--primaria);
}
</style>
</head>

<body>

<div class="section">
  <div class="grid" id="grid"></div>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* CONTROLE DE FOTOS */
const fotosProduto = {};
const indiceFoto = {};

/* CARREGAR PRODUTOS */
async function carregar(){
  const { data, error } = await supabaseClient
    .from("produtos")
    .select("*")
    .order("nome");

  if(error){
    console.log(error);
    alert("Erro ao carregar produtos");
    return;
  }

  grid.innerHTML = "";

  data.forEach(p => {
    let fotos = [];

    if(p.imagem){
      try{
        fotos = p.imagem.startsWith("[")
          ? JSON.parse(p.imagem)
          : [p.imagem];
      }catch{
        fotos = [];
      }
    }

    if(!fotos.length){
      fotos = ["https://via.placeholder.com/300x200?text=Sem+Foto"];
    }

    fotosProduto[p.id] = fotos;
    indiceFoto[p.id] = 0;

    const dots = fotos.map((_,i)=>`
      <span class="dot ${i===0?'active':''}"
        id="dot-${p.id}-${i}"></span>
    `).join("");

    grid.innerHTML += `
      <div class="produto">
        <img src="${fotos[0]}"
             id="foto-${p.id}"
             onclick="trocarFoto('${p.id}')">

        <div class="dots">
          ${dots}
        </div>

        <div class="info">
          <h4>${p.nome}</h4>
          <div class="preco">
            R$ ${Number(p.preco).toFixed(2)}
          </div>
        </div>
      </div>
    `;
  });
}

/* TROCAR FOTO */
function trocarFoto(id){
  const fotos = fotosProduto[id];
  if(fotos.length <= 1) return;

  indiceFoto[id] =
    (indiceFoto[id] + 1) % fotos.length;

  document.getElementById(`foto-${id}`).src =
    fotos[indiceFoto[id]];

  fotos.forEach((_,i)=>{
    document
      .getElementById(`dot-${id}-${i}`)
      .classList.toggle("active", i===indiceFoto[id]);
  });
}

carregar();
</script>

</body>
</html>
