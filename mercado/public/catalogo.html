<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cat√°logo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primaria:#22c55e;
  --bg:#020617;
  --card:#0f172a;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Segoe UI',system-ui,sans-serif;
  background:var(--bg);
  color:#fff;
}

/* ===== BANNER ===== */
.banner{
  width:100%;
  height:200px;
  background-size:cover;
  background-position:center;
  position:relative;
}
.banner::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(to top,rgba(2,6,23,.95),rgba(2,6,23,.35));
}
.banner-content{
  position:absolute;
  bottom:14px;
  left:14px;
}
.banner-content h1{margin:0;font-size:20px}
.banner-content p{font-size:13px;opacity:.85}

/* ===== SOBRE ===== */
.sobre-box{
  padding:14px;
  font-size:14px;
  opacity:.9;
}
.sobre-box .endereco{
  margin-top:6px;
  opacity:.75;
}

/* ===== TOPO ===== */
.topo{
  position:sticky;
  top:0;
  background:#020617;
  padding:10px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #1e293b;
}
.carrinho-btn{
  background:var(--primaria);
  color:#022c22;
  padding:6px 12px;
  border-radius:18px;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
}

/* ===== GRID ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  padding:14px;
}
.produto{
  background:var(--card);
  border-radius:12px;
  padding:8px;
  text-align:center;
}
.produto img{
  width:100%;
  height:80px;
  object-fit:cover;
  border-radius:8px;
}
.produto h4{
  font-size:12px;
  margin:6px 0 2px;
}
.preco{
  color:var(--primaria);
  font-weight:700;
  font-size:13px;
}
.produto button{
  margin-top:6px;
  width:100%;
  padding:6px;
  font-size:12px;
  border:none;
  border-radius:8px;
  background:var(--primaria);
  font-weight:bold;
}

/* ===== CARRINHO ===== */
.carrinho{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:flex-end;
}
.carrinho-box{
  background:#020617;
  width:100%;
  max-height:85%;
  border-radius:18px 18px 0 0;
  padding:14px;
  overflow:auto;
}
.item{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  margin-bottom:6px;
}
.total{
  font-weight:700;
  margin-top:8px;
}

/* ===== FORM ===== */
form input, form textarea, form select{
  width:100%;
  margin-top:8px;
  padding:10px;
  border-radius:10px;
  border:none;
  background:#0f172a;
  color:#fff;
  font-size:13px;
}
.finalizar{
  margin-top:12px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  background:var(--primaria);
  font-weight:800;
}
</style>
</head>

<body>

<!-- BANNER -->
<div class="banner" id="banner">
  <div class="banner-content">
    <h1 id="nomeMercado"></h1>
    <p id="descricaoMercado"></p>
  </div>
</div>

<!-- SOBRE -->
<div class="sobre-box">
  <div id="sobre"></div>
  <div class="endereco" id="endereco"></div>
</div>

<!-- TOPO -->
<div class="topo">
  <strong>üõí Cat√°logo</strong>
  <div class="carrinho-btn" onclick="abrirCarrinho()">
    üß∫ <span id="qtdCarrinho">0</span>
  </div>
</div>

<!-- PRODUTOS -->
<div id="listaProdutos" class="grid"></div>

<!-- CARRINHO -->
<div class="carrinho" id="carrinhoEl">
  <div class="carrinho-box">
    <h3>üß∫ Seu pedido</h3>
    <div id="itensCarrinho"></div>
    <div class="total" id="totalCarrinho"></div>

    <h3 style="margin-top:12px">üìç Dados para entrega</h3>
    <form id="formPedido">
      <input id="clienteNome" placeholder="Seu nome" required>
      <input id="clienteEndereco" placeholder="Endere√ßo">
      <input id="clienteReferencia" placeholder="Ponto de refer√™ncia">
      <select id="pagamento">
        <option>Dinheiro</option>
        <option>Pix</option>
        <option>Cart√£o</option>
      </select>
      <textarea id="obs" placeholder="Observa√ß√µes"></textarea>
    </form>

    <button class="finalizar" onclick="finalizar()">Enviar pedido</button>
    <button onclick="fecharCarrinho()" style="margin-top:8px;background:#334155;color:#fff;width:100%;padding:10px;border-radius:10px">
      Fechar
    </button>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const app = new URLSearchParams(location.search).get("app");
let carrinhoItens = JSON.parse(localStorage.getItem(`carrinho_${app}`)) || [];
let whatsapp="";

function salvarCarrinho(){
  localStorage.setItem(`carrinho_${app}`,JSON.stringify(carrinhoItens));
  qtdCarrinho.innerText = carrinhoItens.reduce((t,i)=>t+i.qtd,0);
}

(async()=>{
  const { data } = await sb.from("config_site").select("*").eq("app_id",app).maybeSingle();
  if(!data) return;

  nomeMercado.innerText = data.nome_site || "";
  descricaoMercado.innerText = data.descricao || "";
  sobre.innerText = data.sobre || "";
  endereco.innerText = data.endereco ? "üìç "+data.endereco+(data.cidade?" ‚Äì "+data.cidade:"") : "";
  if(data.banner_url) banner.style.backgroundImage=`url(${data.banner_url})`;
  whatsapp = data.whatsapp || "";
})();

async function carregarProdutos(){
  const { data } = await sb.from("produtos")
    .select("id,nome,preco,imagem")
    .eq("app_id",app).eq("ativo",true)
    .order("categoria").order("ordem");

  listaProdutos.innerHTML = data.map(p=>`
    <div class="produto">
      ${p.imagem?`<img src="${p.imagem}">`:""}
      <h4>${p.nome}</h4>
      <div class="preco">R$ ${Number(p.preco).toFixed(2)}</div>
      <button onclick='addCarrinho(${JSON.stringify(p)})'>Adicionar</button>
    </div>
  `).join("");
}

function addCarrinho(p){
  const item=carrinhoItens.find(i=>i.id===p.id);
  item?item.qtd++:carrinhoItens.push({...p,qtd:1});
  salvarCarrinho();
}

function abrirCarrinho(){ renderCarrinho(); carrinhoEl.style.display="flex"; }
function fecharCarrinho(){ carrinhoEl.style.display="none"; }

function renderCarrinho(){
  let total=0;
  itensCarrinho.innerHTML=carrinhoItens.map(i=>{
    total+=i.preco*i.qtd;
    return `<div class="item"><span>${i.qtd}x ${i.nome}</span><span>R$ ${(i.preco*i.qtd).toFixed(2)}</span></div>`;
  }).join("");
  totalCarrinho.innerText="Total: R$ "+total.toFixed(2);
}

function finalizar(){
  if(!whatsapp || !carrinhoItens.length) return;

  let msg=`üõí *Pedido*\n\n`;
  carrinhoItens.forEach(i=>msg+=`${i.qtd}x ${i.nome} - R$ ${(i.preco*i.qtd).toFixed(2)}\n`);
  msg+=`\nüë§ ${clienteNome.value}\nüìç ${clienteEndereco.value}\nüìå ${clienteReferencia.value}\nüí≥ ${pagamento.value}\nüìù ${obs.value}`;

  window.open(`https://wa.me/55${whatsapp}?text=${encodeURIComponent(msg)}`,"_blank");

  carrinhoItens=[];
  salvarCarrinho();
  fecharCarrinho();
}

carregarProdutos();
salvarCarrinho();
</script>

</body>
</html>
