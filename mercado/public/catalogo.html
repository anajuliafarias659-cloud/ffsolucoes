<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CatÃ¡logo | Mercado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primaria:#22c55e;
  --fundo:#020617;
  --card:#0f172a;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Segoe UI',system-ui,sans-serif;
  background:var(--fundo);
  color:#fff;
}

/* PRODUTOS */
.section{padding:20px 12px}
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}
.produto{
  background:var(--card);
  border-radius:10px;
  overflow:hidden;
}
.produto img{
  width:100%;
  height:90px;
  object-fit:cover;
  cursor:pointer;
}
.info{padding:6px;text-align:center}
.info h4{font-size:12px;margin:2px 0}
.preco{color:var(--primaria);font-weight:700;font-size:13px}

/* MODAL IMAGEM */
.modal-imagem{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  z-index:50;
}
.modal-imagem .galeria{
  display:flex;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  width:100%;
  height:100%;
}
.modal-imagem img{
  min-width:100%;
  object-fit:contain;
  scroll-snap-align:center;
}
.modal-imagem span{
  position:absolute;
  top:16px;
  right:16px;
  font-size:28px;
  cursor:pointer;
}
</style>
</head>

<body>

<section class="section">
  <h2>ðŸ›’ Produtos</h2>
  <div class="grid" id="listaProdutos"></div>
</section>

<!-- MODAL IMAGEM -->
<div class="modal-imagem" id="modalImagem">
  <span onclick="fecharImagem()">&times;</span>
  <div class="galeria" id="galeria"></div>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const app = new URLSearchParams(location.search).get("app");
if(!app){ document.body.innerText="Mercado nÃ£o encontrado"; throw ""; }

const fotosMemoria = {};
const modalImagem = document.getElementById("modalImagem");
const galeria = document.getElementById("galeria");

// ===== UTIL =====
function parseFotos(imagem){
  if(!imagem) return [];
  try{
    const arr = JSON.parse(imagem);
    return Array.isArray(arr) ? arr : [];
  }catch{
    return [imagem];
  }
}

// ===== PRODUTOS =====
async function carregarProdutos(){
  const {data}=await sb.from("produtos")
    .select("*")
    .eq("app_id",app)
    .eq("ativo",true);

  listaProdutos.innerHTML="";

  data.forEach(p=>{
    const fotos = parseFotos(p.imagem);
    fotosMemoria[p.id] = fotos;

    const capa = fotos[0] || "";

    listaProdutos.innerHTML += `
      <div class="produto">
        ${capa ? `<img src="${capa}" onclick="abrirImagem('${p.id}')">` : ""}
        <div class="info">
          <h4>${p.nome}</h4>
          <div class="preco">R$ ${p.preco.toFixed(2)}</div>
        </div>
      </div>
    `;
  });
}

// ===== MODAL =====
function abrirImagem(id){
  const fotos = fotosMemoria[id] || [];
  galeria.innerHTML = fotos.map(f=>`<img src="${f}">`).join("");
  modalImagem.style.display="block";
}
function fecharImagem(){
  modalImagem.style.display="none";
  galeria.innerHTML="";
}

carregarProdutos();
</script>

</body>
</html>
