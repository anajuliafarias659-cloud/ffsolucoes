<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mercado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primaria:#22c55e;
  --fundo:#020617;
  --card:#0f172a;
}

/* ===== TEMAS ===== */
body.tema-carnaval{--primaria:#ec4899;--card:#1f0a16;}
body.tema-saojoao{--primaria:#f97316;--card:#2a1608;}
body.tema-natal{--primaria:#22c55e;--card:#052e1a;}
body.tema-anonovo{--primaria:#eab308;--card:#1f1a00;}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Segoe UI',system-ui,sans-serif;
  background:var(--fundo);
  color:#fff;
}

/* ===== BANNER ===== */
.banner{
  height:220px;
  background-size:cover;
  background-position:center;
  position:relative;
}
.banner::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(
    to top,
    rgba(2,6,23,.65),
    rgba(2,6,23,.15)
  );
}
.banner-content{
  position:absolute;
  bottom:14px;
  left:14px;
  z-index:2;
  text-shadow:0 2px 6px rgba(0,0,0,.6);
}

/* ===== SE√á√ïES ===== */
.section{padding:20px 12px}

/* ===== SOBRE ===== */
.sobre p{font-size:14px;line-height:1.5;opacity:.9}
.endereco{margin-top:6px;font-size:13px;opacity:.75}

/* ===== CATEGORIA ===== */
.categoria{margin-bottom:24px}
.categoria h3{
  border-left:4px solid var(--primaria);
  padding-left:8px;
  font-size:16px;
  margin-bottom:8px;
}

/* ===== GRID ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}

/* ===== PRODUTO ===== */
.produto{
  background:var(--card);
  border-radius:10px;
  overflow:hidden;
}
.produto img{
  width:100%;
  height:90px;
  object-fit:cover;
  cursor:pointer;
}
.info{text-align:center;padding:6px}
.produto h4{font-size:12px;margin:2px 0}
.preco{color:var(--primaria);font-weight:700;font-size:13px}

/* ===== MODAL IMAGEM ===== */
.modal-imagem{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
}
.modal-imagem img{
  max-width:95%;
  max-height:95%;
  border-radius:10px;
  cursor:pointer;
}
.modal-imagem span{
  position:absolute;
  top:16px;
  right:16px;
  font-size:28px;
  cursor:pointer;
}

/* ===== RESPONSIVO ===== */
@media(min-width:768px){
  .grid{grid-template-columns:repeat(5,1fr)}
  .produto img{height:120px}
}

footer{
  text-align:center;
  padding:16px;
  font-size:13px;
  opacity:.6;
}
</style>
</head>

<body>

<!-- ===== BANNER ===== -->
<div class="banner" id="banner">
  <div class="banner-content">
    <h1 id="nome"></h1>
    <p id="descricao"></p>
  </div>
</div>

<!-- ===== SOBRE ===== -->
<section class="section sobre">
  <h2>üè™ Sobre o mercado</h2>
  <p id="sobreTexto"></p>
  <p class="endereco" id="enderecoTexto"></p>
</section>

<!-- ===== PRODUTOS ===== -->
<section class="section">
  <h2>üßæ Produtos</h2>
  <div id="listaProdutos"></div>
</section>

<footer>
  ¬© <span id="ano"></span> <span id="nomeRodape"></span>
</footer>

<!-- ===== MODAL ===== -->
<div class="modal-imagem" id="modalImagem" onclick="fecharImagem()">
  <span>&times;</span>
  <img id="imgZoom">
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const app = new URLSearchParams(location.search).get("app");
if(!app){document.body.innerText="Mercado n√£o encontrado";throw""}

/* ===== GALERIA ===== */
const fotosProduto={};
let fotosAtuais=[],indice=0;

/* ===== CONFIG ===== */
(async()=>{
  const {data}=await sb.from("config_site").select("*").eq("app_id",app).maybeSingle();
  if(!data)return;

  nome.innerText=data.nome_site||"";
  descricao.innerText=data.descricao_site||"";
  nomeRodape.innerText=data.nome_site||"";
  ano.innerText=new Date().getFullYear();

  if(data.sobre_site) sobreTexto.innerText=data.sobre_site;
  else sobreTexto.style.display="none";

  if(data.endereco){
    enderecoTexto.innerText="üìç "+data.endereco+(data.cidade?" ‚Äì "+data.cidade:"");
  }else enderecoTexto.style.display="none";

  if(data.banner_url) banner.style.backgroundImage=`url(${data.banner_url})`;

  if(data.tema_site && data.tema_site!=="padrao"){
    document.body.classList.add("tema-"+data.tema_site);
  }
})();

/* ===== PRODUTOS ===== */
async function carregarProdutos(){
  const {data}=await sb.from("produtos")
    .select("*")
    .eq("app_id",app)
    .eq("ativo",true)
    .order("categoria")
    .order("nome");

  const grupos={};
  data.forEach(p=>{
    const cat=p.categoria||"Outros";
    if(!grupos[cat]) grupos[cat]=[];
    let fotos=[];
    try{fotos=JSON.parse(p.imagem)}catch{fotos=p.imagem?[p.imagem]:[]}
    fotosProduto[p.id]=fotos;
    grupos[cat].push(p);
  });

  listaProdutos.innerHTML=Object.keys(grupos).map(cat=>`
    <div class="categoria">
      <h3>${cat}</h3>
      <div class="grid">
        ${grupos[cat].map(p=>`
          <div class="produto">
            ${fotosProduto[p.id][0]?`
              <img src="${fotosProduto[p.id][0]}" onclick="abrirImagem('${p.id}')">
            `:""}
            <div class="info">
              <h4>${p.nome}</h4>
              <div class="preco">R$ ${p.preco.toFixed(2)}</div>
            </div>
          </div>
        `).join("")}
      </div>
    </div>
  `).join("");
}

/* ===== MODAL ===== */
function abrirImagem(id){
  fotosAtuais=fotosProduto[id];
  indice=0;
  imgZoom.src=fotosAtuais[0];
  modalImagem.style.display="flex";
}
imgZoom.onclick=e=>{
  e.stopPropagation();
  indice=(indice+1)%fotosAtuais.length;
  imgZoom.src=fotosAtuais[indice];
}
function fecharImagem(){
  modalImagem.style.display="none";
}

carregarProdutos();
</script>

</body>
</html>
