<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caixa | FF SoluÃ§Ãµes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#e5e7eb}
.topo{padding:12px;border-bottom:1px solid #0f172a}
.brand{font-size:22px;font-weight:bold;color:#38bdf8}
.container{padding:12px;padding-bottom:220px}
.card{background:#0f172a;border-radius:14px;padding:12px;margin-bottom:10px}
input,button{width:100%;padding:10px;border-radius:10px;border:none}
input{background:#020617;color:#fff;margin-bottom:6px}
button{background:#0ea5e9;color:#fff;font-weight:bold;cursor:pointer;margin-bottom:6px}
.dinheiro{background:#16a34a}
.pix{background:#0ea5e9}
.cartao{background:#2563eb}
.fiado{background:#7c3aed}
.info{text-align:center;font-weight:bold;margin-top:6px}
.total-fixo{
  position:fixed;bottom:0;left:0;width:100%;
  background:#020617;border-top:1px solid #0f172a;
  color:#38bdf8;text-align:center;padding:12px;font-size:18px
}
</style>
</head>

<body>

<div class="topo"><div class="brand">CAIXA</div></div>

<div class="container">

  <div class="card carrinho">
    <b>ðŸ›’ Carrinho</b>
    <div id="carrinho"></div>
  </div>

  <div class="card">
    <b>ðŸ’³ Pagamento</b>
    <input id="valorPago" type="number" step="0.01" placeholder="Valor pago"
      oninput="calcularInfo()">

    <button class="dinheiro" onclick="finalizarVenda('DINHEIRO')">Dinheiro</button>
    <button class="pix" onclick="finalizarVenda('PIX')">PIX</button>
    <button class="cartao" onclick="finalizarVenda('CARTAO')">CartÃ£o</button>
    <button class="fiado" onclick="finalizarFiado()">Fiado</button>

    <div id="info" class="info"></div>
  </div>

</div>

<div class="total-fixo">
  TOTAL: R$ <span id="total">0.00</span>
</div>

<script>
const { jsPDF } = window.jspdf;
const admin = JSON.parse(localStorage.getItem("admin_logado"));

const supabaseClient = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

function round2(v){ return Math.round(v*100)/100; }

let carrinho = JSON.parse(localStorage.getItem("carrinho_caixa")) || [];
let total = 0;

const carrinhoDiv = document.getElementById("carrinho");
const totalSpan = document.getElementById("total");
const valorPago = document.getElementById("valorPago");
const info = document.getElementById("info");

/* ===== CARRINHO ===== */
function atualizarCarrinho(){
  carrinhoDiv.innerHTML="";
  total=0;
  carrinho.forEach(i=>{
    total += i.subtotal;
    carrinhoDiv.innerHTML += `${i.nome} - R$ ${i.subtotal.toFixed(2)}<br>`;
  });
  total = round2(total);
  totalSpan.innerText = total.toFixed(2);
}
atualizarCarrinho();

/* ===== INFO DE PAGAMENTO ===== */
function calcularInfo(){
  info.innerText="";
  info.style.color="#e5e7eb";

  if(total <= 0) return;

  const pago = round2(Number(valorPago.value));
  if(isNaN(pago) || pago<=0) return;

  const minimo = round2(total*0.9);
  if(pago < minimo){
    info.innerText = `âš ï¸ Falta R$ ${(total-pago).toFixed(2)}`;
    info.style.color="#f87171";
    return;
  }

  info.style.color="#22c55e";
  if(pago < total) info.innerText = `Desconto: R$ ${(total-pago).toFixed(2)}`;
  else if(pago > total) info.innerText = `Troco: R$ ${(pago-total).toFixed(2)}`;
  else info.innerText = "Pagamento exato";
}

/* ===== FINALIZAR NORMAL ===== */
async function finalizarVenda(tipo){
  if(carrinho.length===0 || total<=0){
    alert("Carrinho vazio");
    return;
  }

  const pago = round2(Number(valorPago.value));
  if(isNaN(pago) || pago<=0){
    alert("Informe valor vÃ¡lido");
    return;
  }

  if(tipo!=="DINHEIRO" && pago>total){
    alert("PIX/CartÃ£o nÃ£o aceita valor maior");
    return;
  }

  if(pago < round2(total*0.9)){
    alert("Desconto mÃ¡ximo Ã© 10%");
    return;
  }

  for(const i of carrinho){
    await supabaseClient.from("vendas").insert({
      app_id: admin.app_id,
      produto_id: i.id,
      quantidade: i.qtd,
      valor_total: total,
      valor_pago: pago,
      valor_devido: 0,
      forma_pagamento: tipo
    });
  }

  gerarPDF(tipo,pago);
  limpar();
}

/* ===== FINALIZAR FIADO (INTELIGENTE) ===== */
async function finalizarFiado(){
  if(carrinho.length===0 || total<=0){
    alert("Carrinho vazio");
    return;
  }

  const pago = round2(Number(valorPago.value)||0);
  const devidoAtual = round2(total - pago);
  if(devidoAtual<=0){
    alert("NÃ£o hÃ¡ valor para fiar");
    return;
  }

  let cpf = prompt("CPF do cliente (somente nÃºmeros):");
  if(!cpf) return;
  cpf = cpf.replace(/\D/g,"");
  if(cpf.length!==11){
    alert("CPF invÃ¡lido");
    return;
  }

  const { data: dividas } = await supabaseClient
    .from("vendas")
    .select("valor_devido, cliente_nome")
    .eq("cliente_cpf", cpf)
    .gt("valor_devido", 0);

  let dividaExistente = 0;
  let nomeCliente = "";

  dividas?.forEach(d=>{
    dividaExistente += Number(d.valor_devido||0);
    if(d.cliente_nome) nomeCliente = d.cliente_nome;
  });

  const LIMITE = 10; // ðŸ”’ limite mÃ¡ximo
  if(dividaExistente + devidoAtual > LIMITE){
    alert(
      `Venda bloqueada!\n`+
      `Cliente deve R$ ${dividaExistente.toFixed(2)}\n`+
      `Limite mÃ¡ximo: R$ ${LIMITE.toFixed(2)}`
    );
    return;
  }

  if(!nomeCliente){
    nomeCliente = prompt("Nome completo do cliente:");
    if(!nomeCliente) return;
  }

  const obs = prompt("ObservaÃ§Ã£o:") || "";

  for(const i of carrinho){
    await supabaseClient.from("vendas").insert({
      app_id: admin.app_id,
      produto_id: i.id,
      quantidade: i.qtd,
      valor_total: total,
      valor_pago: pago,
      valor_devido: devidoAtual,
      forma_pagamento: "FIADO",
      cliente_nome: nomeCliente,
      cliente_cpf: cpf,
      observacao: obs
    });
  }

  alert(
    `FIADO REGISTRADO\n${nomeCliente}\n`+
    `DÃ­vida atual: R$ ${(dividaExistente+devidoAtual).toFixed(2)}`
  );

  limpar();
}

/* ===== LIMPAR ===== */
function limpar(){
  carrinho=[];
  localStorage.removeItem("carrinho_caixa");
  atualizarCarrinho();
  valorPago.value="";
  info.innerText="";
}

/* ===== PDF ===== */
function gerarPDF(tipo,pago){
  const doc=new jsPDF();
  doc.text("RECIBO",105,10,{align:"center"});
  doc.text(`Total: R$ ${total.toFixed(2)}`,10,30);
  doc.text(`Pago: R$ ${pago.toFixed(2)}`,10,40);
  doc.text(`Pagamento: ${tipo}`,10,50);
  if(pago>total)
    doc.text(`Troco: R$ ${(pago-total).toFixed(2)}`,10,60);
  doc.save("recibo.pdf");
}
</script>

</body>
</html>
