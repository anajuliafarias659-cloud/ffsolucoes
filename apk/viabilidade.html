<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Viabilidade FTTH</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  body {
    margin:0;
    background:#0b1b29;
    color:#fff;
    font-family:Segoe UI, Arial, sans-serif;
  }
  header {
    background: linear-gradient(90deg,#0b3d1a,#2f8f4e);
    padding:12px 16px;
    font-size:18px;
    font-weight:bold;
    display:flex;
    align-items:center;
    gap:10px;
  }
  #map {
    height: calc(100vh - 52px);
  }
  .info {
    position:absolute;
    top:65px;
    left:10px;
    background:#fff;
    color:#000;
    padding:10px;
    border-radius:8px;
    font-size:14px;
    z-index:1000;
    min-width:200px;
  }
</style>
</head>

<body>

<header>
  游니 Viabilidade FTTH
</header>

<div class="info" id="info">
  Toque no mapa para verificar
</div>

<div id="map"></div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

<script>
const map = L.map('map').setView([-23.55, -46.63], 14);

// Mapa base
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '춸 OpenStreetMap'
}).addTo(map);

let ctos = [];

// CARREGA SOMENTE PONTOS (CTO)
omnivore.kml('rede.kml')
  .on('ready', function () {
    this.eachLayer(layer => {
      if (layer.getLatLng) {
        ctos.push(layer);
      }
    });

    if (ctos.length > 0) {
      const grupo = L.featureGroup(ctos);
      map.fitBounds(grupo.getBounds());
    }
  })
  .addTo(map);

let markerCliente;
let markerCTO;

// CLIQUE NO MAPA
map.on('click', function(e) {

  if (ctos.length === 0) {
    alert("Nenhuma CTO encontrada no KML");
    return;
  }

  if (markerCliente) map.removeLayer(markerCliente);
  if (markerCTO) map.removeLayer(markerCTO);

  markerCliente = L.circleMarker(e.latlng, {
    radius:8,
    color:"#0066ff",
    fillColor:"#0066ff",
    fillOpacity:0.9
  }).addTo(map);

  let menorDist = Infinity;
  let ctoProxima = null;

  ctos.forEach(cto => {
    const d = map.distance(e.latlng, cto.getLatLng());
    if (d < menorDist) {
      menorDist = d;
      ctoProxima = cto;
    }
  });

  let status, cor;

  if (menorDist <= 100) {
    status = "VI츼VEL";
    cor = "green";
  } else if (menorDist <= 150) {
    status = "VI츼VEL COM AN츼LISE";
    cor = "orange";
  } else {
    status = "INVI츼VEL";
    cor = "red";
  }

  markerCTO = L.circleMarker(ctoProxima.getLatLng(), {
    radius:10,
    color:cor,
    fillColor:cor,
    fillOpacity:0.9
  }).addTo(map)
    .bindPopup(`CTO mais pr칩xima<br>Dist칙ncia: ${menorDist.toFixed(1)} m`)
    .openPopup();

  document.getElementById('info').innerHTML = `
    <b>CTO mais pr칩xima</b><br>
    Dist칙ncia: ${menorDist.toFixed(1)} m<br>
    <b>Status:</b> <span style="color:${cor}">${status}</span>
  `;
});
</script>

</body>
</html>
