<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ve√≠culos | Locadora</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.container{max-width:900px;margin:40px auto;padding:20px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}
input,button{width:100%;padding:14px;margin-top:10px;border-radius:10px;border:none}
input{background:#020617;color:#fff}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.statusBtns{display:flex;gap:10px;margin-top:10px}
.statusBtns button{flex:1}
.veiculo{background:#020617;padding:14px;border-radius:12px;margin-top:12px;display:flex;gap:12px}
.veiculo img{width:120px;height:80px;object-fit:cover;border-radius:8px}
.actions button{margin-top:6px;background:#334155}
.actions .del{background:#ef4444}
.actions .edit{background:#fbbf24;color:#000}
</style>
</head>

<body>

<div class="container">

<div class="box">
<h2>üöó Cadastrar Ve√≠culo</h2>

<input id="modelo" placeholder="Modelo">
<input id="diaria" type="number" placeholder="Di√°ria (opcional)">

<div class="statusBtns">
<button type="button" onclick="setStatus('disponivel')" style="background:#22c55e">Dispon√≠vel</button>
<button type="button" onclick="setStatus('alugado')" style="background:#ef4444">Alugado</button>
</div>

<input id="status" type="hidden" value="disponivel">
<input id="dias" type="number" placeholder="Dias alugado" style="display:none">
<input id="fotos" type="file" accept="image/*" multiple>

<button onclick="cadastrarVeiculo()">Cadastrar Ve√≠culo</button>
</div>

<div class="box">
<h2>üìã Ve√≠culos cadastrados</h2>
<div id="lista"></div>
</div>

</div>

<script>
const db = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin?.app_id){
  alert("Locadora n√£o selecionada");
  throw new Error("sem app_id");
}

function setStatus(valor){
  status.value = valor;
  dias.style.display = valor === "alugado" ? "block" : "none";
}

async function uploadFotos(files){
  const urls=[];
  for(const f of files){
    const nome=`${Date.now()}_${f.name}`;
    await db.storage.from("veiculos").upload(nome,f);
    urls.push(db.storage.from("veiculos").getPublicUrl(nome).data.publicUrl);
  }
  return urls;
}

async function cadastrarVeiculo(){
  const modelo = modeloEl.value.trim();
  const diariaVal = diaria.value ? Number(diaria.value) : null;
  const statusVal = status.value;
  const diasVal = Number(dias.value)||null;

  if(!modelo){
    alert("Informe o modelo");
    return;
  }

  const fotos = await uploadFotos(fotosEl.files);
  const foto_url = fotos[0] || null;

  await db.from("veiculos").insert({
    app_id: admin.app_id,
    modelo,
    diaria: diariaVal,
    status: statusVal,
    dias_alugado: diasVal,
    foto_url,
    fotos
  });

  modeloEl.value="";
  diaria.value="";
  dias.value="";
  fotosEl.value="";
  setStatus("disponivel");

  carregarVeiculos();
}

async function carregarVeiculos(){
  const {data} = await db
    .from("veiculos")
    .select("*")
    .eq("app_id",admin.app_id)
    .order("created_at",{ascending:false});

  lista.innerHTML="";
  data.forEach(v=>{
    lista.innerHTML+=`
    <div class="veiculo">
      ${v.foto_url?`<img src="${v.foto_url}">`:""}
      <div>
        <b>${v.modelo}</b><br>
        Di√°ria: ${v.diaria ? `R$ ${v.diaria}` : "‚Äî"}<br>
        Status: ${v.status}
        <div class="actions">
          <button onclick="toggleStatus('${v.id}','${v.status}','${v.modelo}',${v.diaria||0})">
            ${v.status==="disponivel"?"Marcar alugado":"Marcar dispon√≠vel"}
          </button>
          <button class="edit" onclick="editarVeiculo('${v.id}')">Editar</button>
          <button class="del" onclick="excluir('${v.id}')">Excluir</button>
        </div>
      </div>
    </div>`;
  });
}

async function toggleStatus(id,status,modelo,diaria){
  if(status==="disponivel"){
    if(!diaria){
      alert("Este ve√≠culo n√£o possui di√°ria definida.");
      return;
    }
    const dias=Number(prompt("Quantos dias?"));
    if(!dias||dias<=0)return;

    const fim=new Date();
    fim.setDate(fim.getDate()+dias);

    await db.from("veiculos").update({
      status:"alugado",
      dias_alugado:dias,
      data_fim:fim.toISOString().split("T")[0]
    }).eq("id",id);
  }else{
    await db.from("veiculos").update({
      status:"disponivel",
      dias_alugado:null,
      data_fim:null
    }).eq("id",id);
  }
  carregarVeiculos();
}

async function editarVeiculo(id){
  const {data}=await db.from("veiculos").select("*").eq("id",id).single();
  modeloEl.value=data.modelo;
  diaria.value=data.diaria||"";
  status.value=data.status;
  setStatus(data.status);

  const btn=document.querySelector(".box button");
  btn.textContent="Atualizar Ve√≠culo";
  btn.onclick=()=>atualizarVeiculo(id);
}

async function atualizarVeiculo(id){
  await db.from("veiculos").update({
    modelo:modeloEl.value,
    diaria: diaria.value?Number(diaria.value):null,
    status:status.value,
    dias_alugado:Number(dias.value)||null
  }).eq("id",id);

  location.reload();
}

async function excluir(id){
  if(confirm("Excluir ve√≠culo?")){
    await db.from("veiculos").delete().eq("id",id);
    carregarVeiculos();
  }
}

const modeloEl=modelo;
const diariaEl=diaria;
const fotosEl=fotos;

carregarVeiculos();
</script>

</body>
</html>
