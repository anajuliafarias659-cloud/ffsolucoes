<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ve√≠culos | Locadora</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.container{max-width:900px;margin:40px auto;padding:20px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}
input,button{width:100%;padding:14px;margin-top:10px;border-radius:10px;border:none}
input{background:#020617;color:#fff}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.statusBtns{display:flex;gap:10px;margin-top:10px}
.statusBtns button{flex:1}
.veiculo{background:#020617;padding:14px;border-radius:12px;margin-top:12px;display:flex;gap:12px}
.veiculo img{width:120px;height:80px;object-fit:cover;border-radius:8px}
.actions button{margin-top:6px;background:#334155}
.actions .del{background:#ef4444}
.actions .edit{background:#fbbf24;color:#000}
</style>
</head>

<body>

<div class="container">

<div class="box">
<h2>üöó Cadastrar Ve√≠culo</h2>

<input id="modelo" placeholder="Modelo">
<input id="diaria" type="number" placeholder="Di√°ria (opcional)">

<div class="statusBtns">
<button type="button" onclick="setStatus('disponivel')" style="background:#22c55e">Dispon√≠vel</button>
<button type="button" onclick="setStatus('alugado')" style="background:#ef4444">Alugado</button>
</div>

<input id="status" type="hidden" value="disponivel">
<input id="dias" type="number" placeholder="Dias alugado" style="display:none">
<input id="fotos" type="file" accept="image/*" multiple>

<button id="btnSalvar" onclick="cadastrarVeiculo()">Cadastrar Ve√≠culo</button>
</div>

<div class="box">
<h2>üìã Ve√≠culos cadastrados</h2>
<div id="lista"></div>
</div>

</div>

<script>
const db = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ===== NOVO PADR√ÉO APP_ID ===== */
const app_id = localStorage.getItem("app_id");

if(!app_id){
  alert("Locadora n√£o encontrada. Fa√ßa login novamente.");
  window.location.href = "../auth/login.html";
  throw new Error("sem app_id");
}

/* ===== ELEMENTOS ===== */
const modeloEl = document.getElementById("modelo");
const diariaEl = document.getElementById("diaria");
const statusEl = document.getElementById("status");
const diasEl = document.getElementById("dias");
const fotosEl = document.getElementById("fotos");
const lista = document.getElementById("lista");
const btnSalvar = document.getElementById("btnSalvar");

/* ===== STATUS ===== */
function setStatus(valor){
  statusEl.value = valor;
  diasEl.style.display = valor === "alugado" ? "block" : "none";
}

/* ===== UPLOAD ===== */
async function uploadFotos(files){
  const urls=[];
  for(const f of files){
    const nome=`${Date.now()}_${f.name}`;
    await db.storage.from("veiculos").upload(nome,f);
    const publicUrl = db.storage.from("veiculos").getPublicUrl(nome).data.publicUrl;
    urls.push(publicUrl);
  }
  return urls;
}

/* ===== CADASTRAR ===== */
async function cadastrarVeiculo(){
  const modelo = modeloEl.value.trim();
  const diaria = diariaEl.value ? Number(diariaEl.value) : null;
  const status = statusEl.value;
  const dias = Number(diasEl.value)||null;

  if(!modelo){
    alert("Informe o modelo");
    return;
  }

  const fotos = await uploadFotos(fotosEl.files);
  const foto_url = fotos[0] || null;

  await db.from("veiculos").insert({
    app_id,
    modelo,
    diaria,
    status,
    dias_alugado: dias,
    foto_url,
    fotos
  });

  modeloEl.value="";
  diariaEl.value="";
  diasEl.value="";
  fotosEl.value="";
  setStatus("disponivel");

  carregarVeiculos();
}

/* ===== LISTAR ===== */
async function carregarVeiculos(){
  const {data} = await db
    .from("veiculos")
    .select("*")
    .eq("app_id",app_id)
    .order("created_at",{ascending:false});

  lista.innerHTML="";

  data.forEach(v=>{
    lista.innerHTML+=`
    <div class="veiculo">
      ${v.foto_url?`<img src="${v.foto_url}">`:""}
      <div>
        <b>${v.modelo}</b><br>
        Di√°ria: ${v.diaria ? `R$ ${v.diaria}` : "‚Äî"}<br>
        Status: ${v.status}
        <div class="actions">
          <button onclick="toggleStatus('${v.id}','${v.status}',${v.diaria||0})">
            ${v.status==="disponivel"?"Marcar alugado":"Marcar dispon√≠vel"}
          </button>
          <button class="edit" onclick="editarVeiculo('${v.id}')">Editar</button>
          <button class="del" onclick="excluir('${v.id}')">Excluir</button>
        </div>
      </div>
    </div>`;
  });
}

/* ===== ALTERAR STATUS ===== */
async function toggleStatus(id,status,diaria){
  if(status==="disponivel"){
    if(!diaria){
      alert("Este ve√≠culo n√£o possui di√°ria definida.");
      return;
    }

    const dias=Number(prompt("Quantos dias?"));
    if(!dias||dias<=0)return;

    const fim=new Date();
    fim.setDate(fim.getDate()+dias);

    await db.from("veiculos").update({
      status:"alugado",
      dias_alugado:dias,
      data_fim:fim.toISOString().split("T")[0]
    }).eq("id",id);

  }else{
    await db.from("veiculos").update({
      status:"disponivel",
      dias_alugado:null,
      data_fim:null
    }).eq("id",id);
  }

  carregarVeiculos();
}

/* ===== EDITAR ===== */
async function editarVeiculo(id){
  const {data}=await db.from("veiculos").select("*").eq("id",id).single();

  modeloEl.value=data.modelo;
  diariaEl.value=data.diaria||"";
  statusEl.value=data.status;
  setStatus(data.status);

  btnSalvar.textContent="Atualizar Ve√≠culo";
  btnSalvar.onclick=()=>atualizarVeiculo(id);
}

/* ===== ATUALIZAR ===== */
async function atualizarVeiculo(id){
  await db.from("veiculos").update({
    modelo:modeloEl.value,
    diaria: diariaEl.value?Number(diariaEl.value):null,
    status:statusEl.value,
    dias_alugado:Number(diasEl.value)||null
  }).eq("id",id);

  location.reload();
}

/* ===== EXCLUIR ===== */
async function excluir(id){
  if(confirm("Excluir ve√≠culo?")){
    await db.from("veiculos").delete().eq("id",id);
    carregarVeiculos();
  }
}

carregarVeiculos();
</script>

</body>
</html>
