<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Configurar Site P√∫blico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#020617;
  --card:#020617;
  --border:#1e293b;
  --primary:#22c55e;
  --text:#fff;
  --muted:#94a3b8;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:system-ui,Segoe UI;
  background:#020617;
  color:#fff;
}
.container{
  max-width:480px;
  margin:40px auto;
  padding:24px;
  border:1px solid var(--border);
  border-radius:16px;
}
h2{text-align:center;}
label{margin-top:14px;display:block;font-size:.9rem;}
input,button{
  width:100%;
  padding:14px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#020617;
  color:#fff;
}
input[type="checkbox"]{width:auto;margin-right:6px;}
button{
  margin-top:20px;
  background:var(--primary);
  color:#022c22;
  font-weight:700;
  border:none;
  cursor:pointer;
}
.preview{
  margin-top:10px;
  width:100%;
  max-height:180px;
  object-fit:cover;
  border-radius:12px;
  display:none;
}
small{color:var(--muted);}
</style>
</head>

<body>

<div class="container">
<h2>üåê Site P√∫blico</h2>

<label>Banner</label>
<input id="banner" type="file" accept="image/*">
<img id="preview" class="preview">
<label><input type="checkbox" id="remove_banner"> Remover banner</label>

<label>T√≠tulo</label>
<input id="titulo">

<label>Subt√≠tulo</label>
<input id="subtitulo">

<label>WhatsApp</label>
<input id="whatsapp" placeholder="88999999999">

<label>Cor principal</label>
<input id="cor" type="color">

<button onclick="salvar()">Salvar</button>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin?.app_id){
  alert("Sess√£o expirada");
  location.href="../auth/login.html";
}
const app_id = admin.app_id;

const banner = document.getElementById("banner");
const preview = document.getElementById("preview");
const remove_banner = document.getElementById("remove_banner");
const titulo = document.getElementById("titulo");
const subtitulo = document.getElementById("subtitulo");
const whatsapp = document.getElementById("whatsapp");
const cor = document.getElementById("cor");

banner.onchange = ()=>{
  if(banner.files[0]){
    preview.src = URL.createObjectURL(banner.files[0]);
    preview.style.display="block";
    remove_banner.checked=false;
  }
};

async function upload(file){
  const ext = file.name.split(".").pop();
  const path = `${app_id}/${Date.now()}.${ext}`;
  const { error } = await sb.storage
    .from("site-publico")
    .upload(path,file,{upsert:true});
  if(error) return null;
  return sb.storage.from("site-publico").getPublicUrl(path).data.publicUrl;
}

async function salvar(){
  const payload = {
    titulo: titulo.value || null,
    subtitulo: subtitulo.value || null,
    whatsapp: whatsapp.value || null,
    cor_primaria: cor.value || null
  };

  if(remove_banner.checked) payload.banner_url = null;
  if(banner.files[0]) payload.banner_url = await upload(banner.files[0]);

  const { data } = await sb
    .from("config_site_publico")
    .select("id")
    .eq("app_id",app_id)
    .maybeSingle();

  const res = data
    ? await sb.from("config_site_publico").update(payload).eq("app_id",app_id)
    : await sb.from("config_site_publico").insert({ ...payload, app_id });

  if(res.error) alert(res.error.message);
  else alert("Salvo üî•");
}

(async()=>{
  const { data } = await sb
    .from("config_site_publico")
    .select("*")
    .eq("app_id",app_id)
    .maybeSingle();

  if(!data) return;
  titulo.value = data.titulo || "";
  subtitulo.value = data.subtitulo || "";
  whatsapp.value = data.whatsapp || "";
  cor.value = data.cor_primaria || "#22c55e";
  if(data.banner_url){
    preview.src = data.banner_url;
    preview.style.display="block";
  }
})();
</script>

</body>
</html>
