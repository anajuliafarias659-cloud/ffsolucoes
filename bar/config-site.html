<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Site Público</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#22c55e;
  --bg:#020617;
  --text:#ffffff;
  --muted:#94a3b8;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui;}
body{background:var(--bg);color:var(--text);}
.hero{
  min-height:60vh;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
}
h1{font-size:2.4rem;}
p{margin-top:10px;color:var(--muted);}
</style>
</head>

<body>

<section class="hero">
  <div>
    <h1 id="titulo">Carregando…</h1>
    <p id="subtitulo">Site público</p>
  </div>
</section>

<script>
// ================= SUPABASE =================
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

// ================= PEGA UUID DA URL =================
const params = new URLSearchParams(location.search);
let rawId = params.get("app_id");

if(!rawId){
  const raw = location.search.replace("?", "").split("&")[0];
  rawId = raw?.includes("=") ? raw.split("=")[1] : raw;
}

if(!rawId){
  document.getElementById("titulo").innerText = "Site indisponível";
  document.getElementById("subtitulo").innerText = "URL inválida";
  throw new Error("UUID ausente");
}

// ================= LOAD (SEM 400) =================
(async()=>{
  // 1️⃣ resolve o SITE primeiro
  const siteRes = await sb
    .from("sites")
    .select("id,name")
    .eq("id", rawId)
    .maybeSingle();

  if(!siteRes.data){
    document.getElementById("titulo").innerText = "Site indisponível";
    document.getElementById("subtitulo").innerText = "Site não encontrado";
    return;
  }

  const siteId = siteRes.data.id;
  document.getElementById("titulo").innerText = siteRes.data.name;

  // 2️⃣ tenta carregar config (SEM QUEBRAR SE NÃO EXISTIR)
  const configRes = await sb
    .from("site_config")
    .select("*")
    .eq("site_id", siteId)
    .maybeSingle();

  if(configRes.data?.descricao){
    document.getElementById("subtitulo").innerText =
      configRes.data.descricao;
  } else {
    document.getElementById("subtitulo").innerText = "Site público";
  }
})();
</script>

</body>
</html>
