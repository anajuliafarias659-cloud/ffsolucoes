<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Configurar Site P√∫blico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===== VARI√ÅVEIS BASE ===== */
:root{
  --bg:#020617;
  --card:#020617;
  --border:#1e293b;
  --primary:#22c55e;
  --text:#ffffff;
  --muted:#94a3b8;
}

/* ===== TEMAS ===== */
body.tema-carnaval{
  --primary:#ec4899;
}
body.tema-saojoao{
  --primary:#f97316;
}
body.tema-natal{
  --primary:#22c55e;
}
body.tema-anonovo{
  --primary:#eab308;
}

*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Segoe UI',system-ui,sans-serif;
  background:linear-gradient(135deg,#020617,#020617dd);
  color:var(--text);
  min-height:100vh;
}
.container{
  max-width:480px;
  margin:40px auto;
  padding:28px;
  background:var(--card);
  border-radius:18px;
  border:1px solid var(--border);
}
h2,h3{text-align:center;}
label{display:block;margin-top:14px;font-size:.9rem;}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#020617;
  color:#fff;
}
input[type="checkbox"]{width:auto;margin-right:8px;}
button{
  background:var(--primary);
  color:#022c22;
  font-weight:700;
  border:none;
  cursor:pointer;
  margin-top:20px;
}
.preview{
  margin-top:10px;
  max-height:80px;
  max-width:100%;
  object-fit:contain;
  background:#fff;
  padding:6px;
  border-radius:10px;
  display:none;
}
small{color:var(--muted);}
.link{margin-top:20px;font-size:.85rem;word-break:break-all;color:var(--muted);}
.btn-voltar{
  background:transparent;
  border:1px solid var(--border);
  color:var(--muted);
  font-weight:600;
  margin-bottom:16px;
  cursor:pointer;
}
.btn-voltar:hover{
  border-color:var(--primary);
  color:var(--primary);
}
</style>
</head>

<body>

<div class="container">
<h2>‚öôÔ∏è Configurar Site P√∫blico</h2>
<button class="btn-voltar" onclick="history.back()">‚Üê Voltar</button>

<label>Nome do site</label>
<input id="nome_site">

<label>Logo</label>
<input id="logo_file" type="file" accept="image/*">
<img id="logo_preview" class="preview">
<label><input type="checkbox" id="remover_logo"> Remover logo</label>

<label>Banner do card√°pio</label>
<input id="banner_file" type="file" accept="image/*">
<img id="banner_preview" class="preview">
<label><input type="checkbox" id="remover_banner"> Remover banner</label>

<label>WhatsApp</label>
<input id="whatsapp">
<small id="wa_preview"></small>

<h3>üõí Funcionamento</h3>

<label>Modo do card√°pio</label>
<select id="modo_cardapio">
  <option value="venda">Permitir compras</option>
  <option value="vitrine">Somente vitrine</option>
</select>

<label>Hor√°rio de abertura</label>
<input type="time" id="horario_abertura">

<label>Hor√°rio de fechamento</label>
<input type="time" id="horario_fechamento">

<h3>üé® Apar√™ncia</h3>

<label>Tema do site</label>
<select id="tema_site">
  <option value="padrao">Padr√£o</option>
  <option value="carnaval">üé≠ Carnaval</option>
  <option value="saojoao">üî• S√£o Jo√£o</option>
  <option value="natal">üéÑ Natal</option>
  <option value="anonovo">‚ú® Ano Novo</option>
</select>

<label style="margin-top:18px">
  <input type="checkbox" id="mostrar_categorias">
  Mostrar categorias no card√°pio
</label>

<button onclick="salvar()">Salvar configura√ß√µes</button>

<div class="link">
Link p√∫blico:<br>
<span id="link"></span>
</div>
</div>

<script type="module">
import { supabase } from "../js/supabase.js";

let app_id = null;

/* ===============================
   üîê INICIAR
================================= */
async function iniciar(){

  const { data: { session } } = await supabase.auth.getSession();

  if(!session){
    window.location.href = "../auth/login.html";
    return;
  }

  const { data: usuario, error } = await supabase
    .from("usuarios")
    .select("app_id, ativo")
    .eq("id", session.user.id)
    .single();

  if(error || !usuario || !usuario.ativo){
    alert("Conta inv√°lida.");
    await supabase.auth.signOut();
    window.location.href = "../auth/login.html";
    return;
  }

  app_id = usuario.app_id;

  const { data: app } = await supabase
    .from("apps")
    .select("ativo, data_expiracao")
    .eq("id", app_id)
    .single();

  if(!app || !app.ativo || new Date(app.data_expiracao) < new Date()){
    alert("Plano expirado ou conta desativada.");
    await supabase.auth.signOut();
    window.location.href = "../auth/login.html";
    return;
  }

  document.getElementById("link").innerText =
    `${location.origin}/public/index.html?app_id=${app_id}`;

  carregarDados();
}

/* ===============================
   ELEMENTOS
================================= */
const nome_site = document.getElementById("nome_site");
const logo_file = document.getElementById("logo_file");
const banner_file = document.getElementById("banner_file");
const logo_preview = document.getElementById("logo_preview");
const banner_preview = document.getElementById("banner_preview");
const remover_logo = document.getElementById("remover_logo");
const remover_banner = document.getElementById("remover_banner");
const whatsapp = document.getElementById("whatsapp");
const wa_preview = document.getElementById("wa_preview");
const modo_cardapio = document.getElementById("modo_cardapio");
const horario_abertura = document.getElementById("horario_abertura");
const horario_fechamento = document.getElementById("horario_fechamento");
const tema_site = document.getElementById("tema_site");
const layout_categorias = document.getElementById("mostrar_categorias");

/* ===============================
   TEMA
================================= */
function aplicarTema(t){
  document.body.className = "";
  if(t && t !== "padrao"){
    document.body.classList.add("tema-" + t);
  }
}
tema_site.onchange = e => aplicarTema(e.target.value);

/* ===============================
   PREVIEW
================================= */
logo_file.onchange = ()=>{
  const f = logo_file.files[0];
  if(f){
    logo_preview.src = URL.createObjectURL(f);
    logo_preview.style.display="block";
    remover_logo.checked=false;
  }
};

banner_file.onchange = ()=>{
  const f = banner_file.files[0];
  if(f){
    banner_preview.src = URL.createObjectURL(f);
    banner_preview.style.display="block";
    remover_banner.checked=false;
  }
};

whatsapp.oninput=e=>{
  const n=e.target.value.replace(/\D/g,"");
  wa_preview.innerText=n?`https://wa.me/55${n}`:"";
};

/* ===============================
   UPLOAD
================================= */
async function uploadArquivo(file,bucket){
  if(!file) return null;
  const ext=file.name.split(".").pop();
  const path=`${app_id}/${Date.now()}.${ext}`;
  const {error}=await supabase.storage
    .from(bucket)
    .upload(path,file,{upsert:true});
  if(error) return null;
  return supabase.storage
    .from(bucket)
    .getPublicUrl(path).data.publicUrl;
}

/* ===============================
   SALVAR
================================= */
window.salvar = async function(){

  if(!nome_site.value.trim()){
    alert("Informe o nome do site");
    return;
  }

  const payload = {
    nome_site: nome_site.value.trim(),
    whatsapp: whatsapp.value || null,
    modo_cardapio: modo_cardapio.value,
    horario_abertura: horario_abertura.value || null,
    horario_fechamento: horario_fechamento.value || null,
    layout_categorias: layout_categorias.checked,
    tema_site: tema_site.value
  };

  if(remover_logo.checked) payload.logo_url = null;
  if(remover_banner.checked) payload.banner_url = null;

  if(logo_file.files[0]){
    payload.logo_url = await uploadArquivo(logo_file.files[0], "logos");
  }

  if(banner_file.files[0]){
    payload.banner_url = await uploadArquivo(banner_file.files[0], "banners");
  }

  const { data: existente } = await supabase
    .from("config_site")
    .select("id")
    .eq("app_id", app_id)
    .maybeSingle();

  const res = existente
    ? await supabase.from("config_site").update(payload).eq("app_id", app_id)
    : await supabase.from("config_site").insert({ ...payload, app_id });

  if(res.error){
    alert(res.error.message);
    return;
  }

  alert("Configura√ß√µes salvas üî•");
};

/* ===============================
   LOAD
================================= */
async function carregarDados(){

  const {data} = await supabase
    .from("config_site")
    .select("*")
    .eq("app_id",app_id)
    .maybeSingle();

  if(!data) return;

  nome_site.value=data.nome_site||"";
  whatsapp.value=data.whatsapp||"";
  modo_cardapio.value=data.modo_cardapio||"venda";
  horario_abertura.value=data.horario_abertura||"";
  horario_fechamento.value=data.horario_fechamento||"";
  tema_site.value=data.tema_site||"padrao";
  layout_categorias.checked=!!data.layout_categorias;

  aplicarTema(tema_site.value);

  if(data.logo_url){
    logo_preview.src=data.logo_url;
    logo_preview.style.display="block";
  }

  if(data.banner_url){
    banner_preview.src=data.banner_url;
    banner_preview.style.display="block";
  }
}

/* INIT */
iniciar();
</script>


</body>
</html>

