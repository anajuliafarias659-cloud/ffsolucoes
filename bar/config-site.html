<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Configurar Site P√∫blico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#020617;
  --card:#0f172a;
  --border:#1e293b;
  --primary:#22c55e;
  --text:#ffffff;
  --muted:#94a3b8;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:500px;
  margin:40px auto;
  padding:28px;
  background:var(--card);
  border-radius:18px;
  border:1px solid var(--border);
}

h2,h3{text-align:center}

label{display:block;margin-top:14px;font-size:.9rem}

input,select,button{
  width:100%;
  padding:14px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#020617;
  color:#fff;
}

button{
  background:var(--primary);
  font-weight:bold;
  border:none;
  cursor:pointer;
  margin-top:20px;
}

.preview{
  margin-top:10px;
  max-height:80px;
  display:none;
}

.link{
  margin-top:20px;
  font-size:.85rem;
  word-break:break-all;
  color:var(--muted);
}
</style>
</head>

<body>

<div class="container">

<h2>‚öôÔ∏è Configurar Site P√∫blico</h2>

<label>Nome do site</label>
<input id="nome_site">

<label>WhatsApp</label>
<input id="whatsapp">

<h3>üõí Funcionamento</h3>

<label>Modo do card√°pio</label>
<select id="modo_cardapio">
  <option value="venda">Permitir compras</option>
  <option value="vitrine">Somente vitrine</option>
</select>

<label>Hor√°rio abertura</label>
<input type="time" id="horario_abertura">

<label>Hor√°rio fechamento</label>
<input type="time" id="horario_fechamento">

<h3>üé® Tema</h3>

<select id="tema_site">
  <option value="padrao">Padr√£o</option>
  <option value="carnaval">Carnaval</option>
  <option value="saojoao">S√£o Jo√£o</option>
  <option value="natal">Natal</option>
  <option value="anonovo">Ano Novo</option>
</select>

<button onclick="salvar()">Salvar configura√ß√µes</button>

<div class="link">
<strong>Link do Card√°pio:</strong><br>
<span id="link_cardapio"></span>
</div>

<div class="link">
<strong>Link do Site:</strong><br>
<span id="link_site"></span>
</div>

</div>

<script type="module">
import { supabase } from "../js/supabase.js";

let app_id = null;

/* ===============================
   üîê VERIFICAR SESS√ÉO
================================= */
async function verificarSessao(){

  let { data: { session } } = await supabase.auth.getSession();

  if(session) return session;

  const { data } = await supabase.auth.refreshSession();

  if(data.session) return data.session;

  alert("Sess√£o expirada");
  window.location.href = "/auth/login.html";
}

/* ===============================
   üöÄ INICIAR
================================= */
async function iniciar(){

  const session = await verificarSessao();

  const { data: usuario } = await supabase
    .from("usuarios")
    .select("app_id, ativo")
    .eq("id", session.user.id)
    .single();

  if(!usuario || !usuario.ativo){
    alert("Conta inv√°lida");
    window.location.href = "/auth/login.html";
    return;
  }

  app_id = usuario.app_id;

  const { data: app } = await supabase
    .from("apps")
    .select("ativo, data_expiracao")
    .eq("id", app_id)
    .single();

  if(!app || !app.ativo || new Date(app.data_expiracao) < new Date()){
    alert("Plano expirado");
    window.location.href = "/auth/login.html";
    return;
  }

  /* LINKS CORRETOS */
  document.getElementById("link_cardapio").innerText =
    `${location.origin}/bar/public/cardapio/?app_id=${app_id}`;

  document.getElementById("link_site").innerText =
    `${location.origin}/bar/public/site/?app_id=${app_id}`;

  carregarDados();
}

/* ===============================
   SALVAR
================================= */
window.salvar = async function(){

  const payload = {
    nome_site: document.getElementById("nome_site").value.trim(),
    whatsapp: document.getElementById("whatsapp").value || null,
    modo_cardapio: document.getElementById("modo_cardapio").value,
    horario_abertura: document.getElementById("horario_abertura").value || null,
    horario_fechamento: document.getElementById("horario_fechamento").value || null,
    tema_site: document.getElementById("tema_site").value
  };

  const { data: existente } = await supabase
    .from("config_site")
    .select("id")
    .eq("app_id", app_id)
    .maybeSingle();

  const res = existente
    ? await supabase.from("config_site").update(payload).eq("app_id", app_id)
    : await supabase.from("config_site").insert({ ...payload, app_id });

  if(res.error){
    alert(res.error.message);
    return;
  }

  alert("Configura√ß√µes salvas üî•");
};

/* ===============================
   CARREGAR
================================= */
async function carregarDados(){

  const { data } = await supabase
    .from("config_site")
    .select("*")
    .eq("app_id", app_id)
    .maybeSingle();

  if(!data) return;

  document.getElementById("nome_site").value = data.nome_site || "";
  document.getElementById("whatsapp").value = data.whatsapp || "";
  document.getElementById("modo_cardapio").value = data.modo_cardapio || "venda";
  document.getElementById("horario_abertura").value = data.horario_abertura || "";
  document.getElementById("horario_fechamento").value = data.horario_fechamento || "";
  document.getElementById("tema_site").value = data.tema_site || "padrao";
}

/* INIT */
iniciar();

</script>

</body>
</html>
