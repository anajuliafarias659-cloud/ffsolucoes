<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pedidos Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="../js/auth.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{background:#0f172a;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.container{max-width:1100px;margin:auto;padding:24px}
.card{background:#0f172a;border-radius:16px;padding:16px;margin-bottom:16px}
.top{display:flex;justify-content:space-between;align-items:center}
.item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #1e293b;font-size:14px}
.total{font-weight:bold;font-size:16px;margin-top:8px}
button{padding:8px 12px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-left:6px}
.btn-ok{background:#22c55e}
.btn-delivery{background:#f59e0b}
.btn-final{background:#3b82f6}
.btn-cancel{background:#ef4444}
small{color:#94a3b8}
.vazio{text-align:center;margin-top:40px;color:#94a3b8}
</style>
</head>

<body>

<div class="topo">
  <h2>ğŸ“¦ Pedidos Online</h2>
  <button onclick="history.back()">â¬… Voltar</button>
</div>

<div class="container" id="lista">
  Carregando pedidos...
</div>

<script type="module">
import { supabase } from "../js/supabase.js";

let APP_ID=null;

async function iniciar(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ location.href="../auth/login.html"; return; }

  const { data: usuario } = await supabase
    .from("usuarios")
    .select("app_id")
    .eq("id", session.user.id)
    .single();

  APP_ID = usuario.app_id;
  carregarPedidos();
  setInterval(carregarPedidos,5000);
}

async function carregarPedidos(){

  const { data } = await supabase
    .from("pedidos")
    .select(`
      id,
      created_at,
      cliente_nome,
      telefone,
      forma_pagamento,
      status,
      pedido_itens ( nome_produto, quantidade, preco )
    `)
    .eq("app_id", APP_ID)
    .neq("status","cancelado")
    .order("created_at",{ascending:false});

  const lista=document.getElementById("lista");
  lista.innerHTML="";

  if(!data || data.length===0){
    lista.innerHTML='<div class="vazio">Nenhum pedido</div>';
    return;
  }

  data.forEach(p=>{

    let total=0;

    const itensHtml=(p.pedido_itens||[]).map(i=>{
      const sub=Number(i.quantidade)*Number(i.preco);
      total+=sub;
      return `<div class="item">
                <span>${i.quantidade}x ${i.nome_produto}</span>
                <span>R$ ${sub.toFixed(2)}</span>
              </div>`;
    }).join("");

    lista.innerHTML+=`
      <div class="card">
        <div class="top">
          <div>
            <b>${p.cliente_nome||"Cliente"}</b><br>
            <small>${new Date(p.created_at).toLocaleString()}</small><br>
            <small>Pagamento: ${p.forma_pagamento||"-"}</small><br>
            <small>Status: ${p.status}</small>
          </div>
          <div>
            ${botoesStatus(p)}
          </div>
        </div>
        ${itensHtml}
        <div class="total">Total: R$ ${total.toFixed(2)}</div>
      </div>`;
  });
}

function botoesStatus(p){

  if(p.status==="novo"){
    return `
      <button class="btn-ok" onclick="aceitar('${p.id}')">âœ” Aceitar</button>
      <button class="btn-cancel" onclick="cancelar('${p.id}')">âœ– Cancelar</button>`;
  }

  if(p.status==="em_preparo"){
    return `
      <button class="btn-delivery" onclick="saiuEntrega('${p.id}')">
      ğŸšš Saiu p/ Entrega</button>`;
  }

  if(p.status==="saiu_entrega"){
    return `
      <button class="btn-final" onclick="finalizar('${p.id}')">
      âœ… Finalizar</button>`;
  }

  return "";
}

async function enviarWhats(pedido,mensagem){

  if(!pedido.telefone) return;

  window.open(
    `https://wa.me/55${pedido.telefone}?text=${encodeURIComponent(mensagem)}`,
    "_blank"
  );
}

window.aceitar=async function(id){

  const { data:pedido } = await supabase
    .from("pedidos")
    .select("cliente_nome, telefone")
    .eq("id",id)
    .single();

  await supabase
    .from("pedidos")
    .update({status:"em_preparo"})
    .eq("id",id);

  await enviarWhats(pedido,
`OlÃ¡ ${pedido.cliente_nome || ""} ğŸ‘‹

âœ… Seu pedido foi aceito!
ğŸ‘¨â€ğŸ³ JÃ¡ estÃ¡ em preparo.

Avisaremos quando sair para entrega ğŸš€`
  );

  carregarPedidos();
};

window.saiuEntrega=async function(id){

  const { data:pedido } = await supabase
    .from("pedidos")
    .select("cliente_nome, telefone")
    .eq("id",id)
    .single();

  await supabase
    .from("pedidos")
    .update({status:"saiu_entrega"})
    .eq("id",id);

  await enviarWhats(pedido,
`ğŸšš Seu pedido saiu para entrega!

ğŸ“± Fique atento ao celular.
Nosso entregador pode entrar em contato.

Obrigado pela preferÃªncia ğŸ™`
  );

  carregarPedidos();
};

window.finalizar=async function(id){

  await supabase
    .from("pedidos")
    .update({status:"finalizado"})
    .eq("id",id);

  carregarPedidos();
};

window.cancelar=async function(id){

  if(!confirm("Deseja cancelar este pedido?")) return;

  const { data:pedido } = await supabase
    .from("pedidos")
    .select("cliente_nome, telefone")
    .eq("id",id)
    .single();

  await supabase
    .from("pedidos")
    .update({status:"cancelado"})
    .eq("id",id);

  await enviarWhats(pedido,
`OlÃ¡ ${pedido.cliente_nome || ""}

âŒ Seu pedido foi cancelado.
Se precisar de algo estamos Ã  disposiÃ§Ã£o.`
  );

  carregarPedidos();
};

iniciar();
</script>

</body>
</html>
