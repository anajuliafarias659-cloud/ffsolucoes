<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#020617;color:#fff}
.topo{background:#0f172a;padding:16px;font-size:20px;font-weight:bold}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:#0f172a;border-radius:14px;padding:16px;margin-bottom:16px}
input,select{width:100%;padding:12px;border-radius:10px;border:none;margin-bottom:12px}
button{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer}
.pay{background:#22c55e;color:#000}
.total{font-size:20px;font-weight:bold;margin-bottom:10px}
.troco{color:#22c55e;font-weight:bold}
</style>
</head>

<body>

<div class="topo">üí∞ Caixa</div>

<div class="container">
  <div id="pedidoBox" class="card">
    <p>Aguardando pedido‚Ä¶</p>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ================= CONTEXTO ================= */
const params = new URLSearchParams(location.search);
const appId = params.get("app_id");

/* ================= ESTADO ================= */
let pedido = null;
let totalPedido = 0;

/* ================= BUSCAR PEDIDO EM CONTA ================= */
async function buscarPedidoConta(){
  const { data } = await sb
    .from("pedidos")
    .select("id,mesa_id,status")
    .eq("app_id", appId)
    .eq("status", "conta_solicitada")
    .order("created_at",{ascending:true})
    .limit(1)
    .maybeSingle();

  if(!data){
    document.getElementById("pedidoBox").innerHTML =
      "<p>Aguardando pedido‚Ä¶</p>";
    return;
  }

  pedido = data;
  carregarItens();
}

/* ================= ITENS ================= */
async function carregarItens(){
  const { data } = await sb
    .from("pedido_itens")
    .select("nome_produto,quantidade,preco")
    .eq("pedido_id", pedido.id)
    .eq("app_id", appId);

  totalPedido = 0;
  let html = "<h3>Pedido</h3>";

  data.forEach(i=>{
    const sub = i.quantidade * i.preco;
    totalPedido += sub;
    html += `<p>${i.quantidade}x ${i.nome_produto} ‚Äî R$ ${sub.toFixed(2)}</p>`;
  });

  html += `
    <div class="total">Total: R$ ${totalPedido.toFixed(2)}</div>

    <select id="forma" onchange="ajustarForma()">
      <option value="dinheiro">Dinheiro</option>
      <option value="pix">PIX</option>
      <option value="cartao">Cart√£o</option>
    </select>

    <input id="valorPago" type="number" step="0.01" placeholder="Valor pago">

    <div id="troco"></div>

    <button class="pay" onclick="finalizarPagamento()">‚úÖ Finalizar pagamento</button>
  `;

  document.getElementById("pedidoBox").innerHTML = html;
  ajustarForma();
}

/* ================= AJUSTE FORMA ================= */
function ajustarForma(){
  const forma = document.getElementById("forma").value;
  const campo = document.getElementById("valorPago");
  const troco = document.getElementById("troco");

  if(forma === "dinheiro"){
    campo.disabled = false;
    campo.value = "";
    troco.innerHTML = "";
    campo.oninput = calcularTroco;
  } else {
    campo.value = totalPedido.toFixed(2);
    campo.disabled = true;
    troco.innerHTML = "";
    campo.oninput = null;
  }
}

/* ================= TROCO ================= */
function calcularTroco(){
  const pago = parseFloat(document.getElementById("valorPago").value || 0);
  const troco = pago - totalPedido;

  document.getElementById("troco").innerHTML =
    troco >= 0
      ? `<p class="troco">Troco: R$ ${troco.toFixed(2)}</p>`
      : "";
}

/* ================= PAGAMENTO ================= */
async function finalizarPagamento(){
  const forma = document.getElementById("forma").value;
  const valorPago = forma === "dinheiro"
    ? parseFloat(document.getElementById("valorPago").value || 0)
    : totalPedido;

  if(valorPago < totalPedido){
    alert("‚ùå Valor insuficiente");
    return;
  }

  await sb.from("pedidos")
    .update({
      status: "pago",
      valor_pago: valorPago,
      forma_pagamento: forma
    })
    .eq("id", pedido.id)
    .eq("app_id", appId);

  await sb.from("logs").insert({
    app_id: appId,
    pedido_id: pedido.id,
    tipo: "pagamento",
    destino: "caixa",
    mensagem: `Pedido pago - Total R$ ${totalPedido.toFixed(2)}`,
    nivel: "info",
    acao: "pedido_pago"
  });

  pedido = null;
  totalPedido = 0;

  document.getElementById("pedidoBox").innerHTML =
    "<p>Pagamento conclu√≠do. Aguardando pr√≥ximo pedido‚Ä¶</p>";

  // üîÅ RECARREGA O PR√ìPRIO CAIXA
  setTimeout(buscarPedidoConta, 800);
}

/* ================= LOOP ================= */
buscarPedidoConta();
setInterval(buscarPedidoConta, 5000);
</script>

</body>
</html>
