<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cozinha | Pedidos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#020617;
  --card:#0f172a;
  --border:#1e293b;
  --text:#ffffff;
  --muted:#94a3b8;
  --novo:#eab308;
  --preparo:#38bdf8;
  --finalizado:#22c55e;
  --cancelado:#ef4444;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,'Segoe UI',sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:18px;
  border-bottom:1px solid var(--border);
  font-size:20px;
  font-weight:600;
}

.container{
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:16px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
}

.card h3{
  margin:0 0 6px;
  font-size:18px;
}

.meta{
  font-size:13px;
  color:var(--muted);
  margin-bottom:12px;
}

.itens div{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}

.total{
  font-weight:700;
  margin-bottom:12px;
}

.actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

button{
  border:none;
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}

.novo{background:var(--novo)}
.preparo{background:var(--preparo)}
.finalizado{background:var(--finalizado)}
.cancelar{background:var(--cancelado);color:#fff}

.empty{
  grid-column:1/-1;
  text-align:center;
  color:var(--muted);
  margin-top:40px;
}
</style>
</head>

<body>

<header>üç≥ Cozinha ‚Äî Pedidos Ativos</header>

<div class="container" id="lista"></div>

<audio id="alerta" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script type="module">
import { supabase } from "../js/supabase.js";

const lista = document.getElementById("lista");
const alerta = document.getElementById("alerta");

let app_id = null;

/* ===============================
   üîê INICIAR SISTEMA
================================= */
async function iniciar(){

  const { data: { session } } = await supabase.auth.getSession();

  if(!session){
    window.location.href = "/auth/login.html";
    return;
  }

  const { data: usuario, error } = await supabase
    .from("usuarios")
    .select("app_id, ativo")
    .eq("id", session.user.id)
    .single();

  if(error || !usuario || !usuario.ativo){
    alert("Conta inv√°lida.");
    await supabase.auth.signOut();
    window.location.href = "/auth/login.html";
    return;
  }

  app_id = usuario.app_id;

  const { data: app } = await supabase
    .from("apps")
    .select("data_expiracao, ativo")
    .eq("id", app_id)
    .single();

  if(!app || !app.ativo){
    alert("Neg√≥cio desativado.");
    await supabase.auth.signOut();
    window.location.href = "/auth/login.html";
    return;
  }

  if(new Date(app.data_expiracao) < new Date()){
    alert("Plano expirado.");
    await supabase.auth.signOut();
    window.location.href = "/auth/login.html";
    return;
  }

  carregarPedidos();
  ativarRealtime();
}

/* ===============================
   üì¶ CARREGAR PEDIDOS
================================= */
async function carregarPedidos(){

  const { data, error } = await supabase
    .from("pedidos")
    .select("*")
    .eq("app_id", app_id)
    .in("status", ["novo","preparo","entregue"])
    .order("created_at", { ascending:true });

  if(error){
    console.error(error);
    return;
  }

  renderizar(data || []);
}

/* ===============================
   üé® RENDER
================================= */
function renderizar(pedidos){

  lista.innerHTML = "";

  if(pedidos.length === 0){
    lista.innerHTML = `<div class="empty">Nenhum pedido no momento</div>`;
    return;
  }

  pedidos.forEach(p=>{

    const mesa = p.itens?.mesa || "-";
    const produtos = p.itens?.produtos || [];

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>Mesa ${mesa}</h3>
      <div class="meta">
        ${new Date(p.created_at).toLocaleTimeString()} ¬∑ Status: ${p.status}
      </div>

      <div class="itens">
        ${produtos.map(i=>`
          <div>
            <span>${i.qtd}x ${i.nome}</span>
            <span>R$ ${(i.qtd * i.preco).toFixed(2)}</span>
          </div>
        `).join("")}
      </div>

      <div class="total">Total: R$ ${Number(p.total).toFixed(2)}</div>

      <div class="actions">
        ${p.status==="novo" ? `<button class="novo" onclick="mudarStatus('${p.id}','preparo')">Preparar</button>` : ""}
        ${p.status==="preparo" ? `<button class="preparo" onclick="mudarStatus('${p.id}','entregue')">Entregar</button>` : ""}
        ${p.status==="entregue" ? `<button class="finalizado" onclick="mudarStatus('${p.id}','finalizado')">Finalizar</button>` : ""}
        <button class="cancelar" onclick="mudarStatus('${p.id}','cancelado')">Cancelar</button>
      </div>
    `;

    lista.appendChild(card);
  });
}

/* ===============================
   üîÑ MUDAR STATUS
================================= */
window.mudarStatus = async (id,status)=>{
  await supabase
    .from("pedidos")
    .update({ status })
    .eq("id", id)
    .eq("app_id", app_id);
};

/* ===============================
   üì° REALTIME
================================= */
function ativarRealtime(){

  supabase.channel("pedidos-realtime")
    .on(
      "postgres_changes",
      { event:"INSERT", schema:"public", table:"pedidos" },
      payload=>{
        if(payload.new.app_id === app_id){
          alerta.play();
          carregarPedidos();
        }
      }
    )
    .on(
      "postgres_changes",
      { event:"UPDATE", schema:"public", table:"pedidos" },
      payload=>{
        if(payload.new.app_id === app_id){
          carregarPedidos();
        }
      }
    )
    .subscribe();
}

/* INIT */
iniciar();

</script>

</body>
</html>
