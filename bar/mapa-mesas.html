<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa das Mesas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  background:#020617;
  font-family:Arial;
  color:#fff;
  overflow:hidden;
}

.topo{
  background:#0f172a;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* WRAPPER (pan do mapa) */
.mapa-wrapper{
  width:100%;
  height:calc(100vh - 64px);
  overflow:hidden;
  touch-action:none;
}

/* MAPA */
.mapa{
  position:relative;
  width:1200px;
  height:900px;
  transform-origin: 0 0;
}

/* ELEMENTOS */
.bar,.mesa{
  position:absolute;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  user-select:none;
}

.bar{
  width:160px;
  height:180px;
  border:3px solid #ef4444;
  cursor:grab;
}

.mesa{
  width:60px;
  height:60px;
  border:3px solid #22c55e;
  cursor:grab;
}

.bar:active,.mesa:active{
  cursor:grabbing;
}

/* MOBILE */
@media (max-width: 768px){
  .mapa{
    transform: scale(0.7);
  }
}
</style>
</head>

<body>

<script>
/* üîê SUPABASE */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));
const funcionario = JSON.parse(localStorage.getItem("funcionario_logado"));
const app_id = funcionario?.app_id || admin?.app_id;

if(!app_id){
  alert("Sess√£o inv√°lida");
  location.href="../auth/login.html";
}

const modoAdmin = !!admin;
</script>

<div class="topo">
  <h3>üó∫Ô∏è Mapa das Mesas</h3>
  <button onclick="history.back()">Voltar</button>
</div>

<div class="mapa-wrapper" id="wrapper">
  <div class="mapa" id="mapa">
    <div class="bar" id="bar">BAR</div>
  </div>
</div>

<script>
const mapa = document.getElementById("mapa");
const wrapper = document.getElementById("wrapper");

/* =======================
   PAN DO MAPA (MOBILE)
======================= */
let panX=0, panY=0, panAtivo=false, startX=0, startY=0;
const scale = window.innerWidth <= 768 ? 0.7 : 1;

wrapper.addEventListener("touchstart",e=>{
  if(e.touches.length!==1) return;
  panAtivo=true;
  startX=e.touches[0].clientX-panX;
  startY=e.touches[0].clientY-panY;
});

wrapper.addEventListener("touchmove",e=>{
  if(!panAtivo) return;
  panX=e.touches[0].clientX-startX;
  panY=e.touches[0].clientY-startY;
  mapa.style.transform=`translate(${panX}px,${panY}px) scale(${scale})`;
});

wrapper.addEventListener("touchend",()=>panAtivo=false);

/* =======================
   DRAG ELEMENTOS (ADMIN)
======================= */
function drag(el, config){
  if(!modoAdmin) return;

  let ativo=false, offX=0, offY=0;

  el.addEventListener("mousedown",e=>{
    ativo=true;
    offX=e.offsetX;
    offY=e.offsetY;
  });

  document.addEventListener("mousemove",e=>{
    if(!ativo) return;
    el.style.left=(e.pageX-offX-panX)/scale+"px";
    el.style.top =(e.pageY-offY-64-panY)/scale+"px";
  });

  document.addEventListener("mouseup",async()=>{
    if(!ativo) return;
    ativo=false;

    const { tipo, mesa_id } = config;

    let query = sb.from("mapa_mesas")
      .select("id")
      .eq("app_id",app_id)
      .eq("tipo",tipo);

    if(tipo==="MESA") query=query.eq("mesa_id",mesa_id);

    const { data: existe } = await query.maybeSingle();

    if(existe){
      await sb.from("mapa_mesas")
        .update({ x: el.style.left, y: el.style.top })
        .eq("id",existe.id);
    }else{
      await sb.from("mapa_mesas")
        .insert({
          app_id,
          tipo,
          mesa_id: tipo==="MESA"?mesa_id:null,
          x: el.style.left,
          y: el.style.top
        });
    }
  });
}

/* =======================
   BAR
======================= */
async function carregarBar(){
  const bar=document.getElementById("bar");

  const { data } = await sb.from("mapa_mesas")
    .select("x,y")
    .eq("app_id",app_id)
    .eq("tipo","BAR")
    .maybeSingle();

  if(data){
    bar.style.left=data.x;
    bar.style.top=data.y;
  }else{
    bar.style.left="40px";
    bar.style.top="140px";
  }

  drag(bar,{tipo:"BAR",mesa_id:null});
}

/* =======================
   MESAS
======================= */
async function carregarMesas(){
  const { data: mesas } = await sb
    .from("mesas")
    .select("id,numero_mesa")
    .eq("app_id",app_id)
    .eq("ativa",true)
    .order("numero_mesa");

  const { data: posicoes } = await sb
    .from("mapa_mesas")
    .select("mesa_id,x,y")
    .eq("app_id",app_id)
    .eq("tipo","MESA");

  const mapaPos={};
  (posicoes||[]).forEach(p=>mapaPos[p.mesa_id]=p);

  let x=260,y=60,col=0;

  mesas.forEach(m=>{
    const div=document.createElement("div");
    div.className="mesa";
    div.innerText=m.numero_mesa;

    if(mapaPos[m.id]){
      div.style.left=mapaPos[m.id].x;
      div.style.top =mapaPos[m.id].y;
    }else{
      div.style.left=x+"px";
      div.style.top =y+"px";
    }

    mapa.appendChild(div);
    drag(div,{tipo:"MESA",mesa_id:m.id});

    col++; x+=80;
    if(col>=4){col=0;x=260;y+=90;}
  });
}

/* START */
carregarBar();
carregarMesas();
</script>

</body>
</html>
