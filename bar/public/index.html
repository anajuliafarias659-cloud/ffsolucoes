<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CardÃ¡pio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* (ESTILO ORIGINAL MANTIDO) */
:root{
  --primary:#8b5e3c;
  --bg:#f6f1eb;
  --card:#ffffff;
  --text:#2e1f14;
  --muted:#7a6a5c;
  --border:#e6ded5;
}
*{box-sizing:border-box;}
body{margin:0;font-family:'Inter','Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);}
.topo{position:relative;height:240px;display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--border);}
.banner{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.topo::after{content:"";position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.25),rgba(0,0,0,.05));}
.topo-conteudo{position:relative;text-align:center;color:#fff;}
.logo{max-height:72px;margin-bottom:10px;}
.container{max-width:1100px;margin:auto;padding:28px 16px 150px;display:grid;gap:20px;}
.produto{background:#fff;border-radius:20px;padding:18px;display:flex;gap:16px;border:1px solid var(--border);}
.add-btn{width:44px;height:44px;border-radius:50%;border:none;background:var(--primary);color:#fff;font-size:22px;font-weight:900;}
.carrinho-btn{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;padding:16px 34px;border-radius:999px;font-weight:900;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-end;}
.modal-content{background:#fff;width:100%;max-width:520px;margin:auto;border-radius:26px 26px 0 0;padding:26px;}
</style>
</head>

<body>

<div class="topo">
  <img id="banner" class="banner" style="display:none">
  <div class="topo-conteudo">
    <img id="logo" class="logo" style="display:none">
    <h1 id="nome">CardÃ¡pio</h1>
  </div>
</div>

<div class="container" id="conteudo"></div>

<div class="carrinho-btn" onclick="abrirCarrinho()">
  ðŸ›’ Ver pedido (<span id="qtd">0</span>)
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3>ðŸ§¾ Seu pedido</h3>
    <input id="cliente_nome" placeholder="Seu nome">
    <input id="cliente_whatsapp" placeholder="WhatsApp">
    <input id="cliente_localizacao" placeholder="Bairro ou referÃªncia">
    <div id="lista"></div>
    <button onclick="enviarPedido()">Enviar pedido</button>
  </div>
</div>

<script>
/* ===== SUPABASE ===== */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ===== PARAMS ===== */
const params = new URLSearchParams(location.search);
const app_id = params.get("app_id") || localStorage.getItem("app_id");
const mesa_id = params.get("mesa"); // ðŸ”¥ AGORA Ã‰ UUID

if(!app_id){document.body.innerHTML="IndisponÃ­vel";throw"";}
localStorage.setItem("app_id",app_id);

let carrinho=[],produtos=[];

/* ===== CONFIG ===== */
async function carregarConfig(){
  const {data}=await sb.from("config_site").select("*").eq("app_id",app_id).single();
  if(!data) return;
  nome.innerText=data.nome_site||"CardÃ¡pio";
  if(data.logo_url){logo.src=data.logo_url;logo.style.display="block";}
  if(data.banner_url){banner.src=data.banner_url;banner.style.display="block";}
}

/* ===== PRODUTOS ===== */
async function carregarProdutos(){
  const {data}=await sb.from("produtos")
    .select("id,nome,preco,foto")
    .eq("app_id",app_id).eq("ativo",true);
  produtos=data||[];
  conteudo.innerHTML="";
  produtos.forEach(p=>{
    conteudo.innerHTML+=`
      <div class="produto">
        ${p.foto?`<img src="${p.foto}" width="90">`:""}
        <div style="flex:1">
          <b>${p.nome}</b>
          <span>R$ ${p.preco.toFixed(2)}</span>
        </div>
        <button class="add-btn" onclick="add('${p.id}')">+</button>
      </div>`;
  });
}

function add(id){
  const p=produtos.find(x=>x.id===id);
  const i=carrinho.find(x=>x.id===id);
  i?i.qtd++:carrinho.push({...p,qtd:1});
  qtd.innerText=carrinho.reduce((s,i)=>s+i.qtd,0);
}

function abrirCarrinho(){
  modal.style.display="flex";
  lista.innerHTML="";
  carrinho.forEach(i=>{
    lista.innerHTML+=`
      <div>
        ${i.qtd}x ${i.nome}
        <b>R$ ${(i.preco*i.qtd).toFixed(2)}</b>
      </div>`;
  });
}

/* ===== ENVIAR PEDIDO ===== */
async function enviarPedido(){
  const nome=cliente_nome.value.trim();
  if(!nome){alert("Informe seu nome");return;}

  const {data:pedido}=await sb.from("pedidos").insert({
    app_id,
    mesa_id: mesa_id || null,   // ðŸ”¥ CORRETO
    origem: mesa_id ? "mesa" : "web",
    cliente_nome: nome,
    cliente_whatsapp: cliente_whatsapp.value||null,
    cliente_localizacao: cliente_localizacao.value||null,
    status:"aberto",
    atendido:false
  }).select().single();

  for(const i of carrinho){
    await sb.from("pedido_itens").insert({
      app_id,
      pedido_id: pedido.id,
      produto_id: i.id,
      nome_produto: i.nome,
      preco: i.preco,
      quantidade: i.qtd
    });
  }

  alert("Pedido enviado â˜•");
  carrinho=[];qtd.innerText=0;modal.style.display="none";
}

modal.onclick=e=>e.target===modal&&(modal.style.display="none");

(async()=>{await carregarConfig();await carregarProdutos();})();
</script>

</body>
</html>
