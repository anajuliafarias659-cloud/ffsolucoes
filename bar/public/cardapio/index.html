<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const app_id = new URLSearchParams(location.search).get("app") || 
               new URLSearchParams(location.search).get("app_id");

if(!app_id){ document.body.innerHTML="IndisponÃ­vel"; throw ""; }

let produtos=[], filtro="BAR";
const carrinhoKey="carrinho_"+app_id;
let carrinho=JSON.parse(localStorage.getItem(carrinhoKey))||[];
let whatsapp="";
let fluxoPedido="whatsapp";

/* ================= CONFIG ================= */
async function carregarConfig(){
  const {data}=await sb
    .from("config_site")
    .select("*")
    .eq("app_id",app_id)
    .single();

  if(!data) return;

  nome.innerText=data.nome_site||"CardÃ¡pio";
  if(data.logo_url){logo.src=data.logo_url;logo.style.display="block";}
  if(data.banner_url){banner.src=data.banner_url;banner.style.display="block";}
  if(data.tema_site) document.body.dataset.tema=data.tema_site;

  whatsapp=data.whatsapp||"";
  fluxoPedido=data.fluxo_pedido||"whatsapp";

  document.querySelector(".modal-box .add-btn").innerText =
    fluxoPedido==="sistema" ? "Finalizar Pedido" : "Enviar no WhatsApp";
}

/* ================= PRODUTOS ================= */
async function carregarProdutos(){
  const {data}=await sb.from("produtos")
    .select("id,nome,preco,foto,destino")
    .eq("app_id",app_id)
    .eq("ativo",true)
    .order("nome");
  produtos=data||[];
  render();
}

function render(){
  conteudo.innerHTML="";
  produtos.filter(p=>(p.destino||"").toUpperCase()===filtro)
    .forEach(p=>{
      conteudo.innerHTML+=`
        <div class="produto">
          ${p.foto?`<img src="${p.foto}">`:""}
          <b>${p.nome}</b>
          <div class="preco">R$ ${p.preco.toFixed(2)}</div>
          <button class="add-btn" onclick="addProduto('${p.id}')">Adicionar</button>
        </div>`;
    });
  atualizarQtd();
}

/* ================= CARRINHO ================= */
function addProduto(id){
  const p=produtos.find(x=>x.id===id);
  const i=carrinho.find(x=>x.id===id);
  i ? i.qtd++ : carrinho.push({id:p.id,nome:p.nome,preco:p.preco,qtd:1});
  salvar();
}

function salvar(){
  localStorage.setItem(carrinhoKey,JSON.stringify(carrinho));
  atualizarQtd();
}

function atualizarQtd(){
  qtd.innerText=carrinho.reduce((s,i)=>s+i.qtd,0);
}

function abrirCarrinho(){
  modal.style.display="block";
  renderCarrinho();
}

function fecharCarrinho(){
  modal.style.display="none";
}

function renderCarrinho(){
  lista.innerHTML="";
  let total=0;
  carrinho.forEach(i=>{
    const sub=i.preco*i.qtd;
    total+=sub;
    lista.innerHTML+=`
      <div class="item">
        ${i.nome} x${i.qtd}
        <button onclick="remover('${i.id}')">âˆ’</button>
      </div>`;
  });
  document.getElementById("total").innerText=total.toFixed(2);
}

function remover(id){
  const i=carrinho.find(x=>x.id===id);
  if(i){
    i.qtd--;
    if(i.qtd<=0) carrinho=carrinho.filter(x=>x.id!==id);
    salvar();
    renderCarrinho();
  }
}

function verificarTroco(){
  trocoBox.style.display = pagamento.value==="Dinheiro" ? "block" : "none";
}

/* ================= FINALIZAR ================= */
async function finalizar(){

  if(!cliente.value.trim()){
    alert("Informe seu nome");
    return;
  }

  if(!pagamento.value){
    alert("Informe a forma de pagamento");
    return;
  }

  if(fluxoPedido==="sistema"){
    await enviarSistema();
  }else{
    enviarWhatsApp();
  }
}

/* ===== WHATSAPP ===== */
function enviarWhatsApp(){

  let msg="ðŸ›’ *Novo Pedido*\n\n";
  let total=0;

  carrinho.forEach(i=>{
    const sub=i.preco*i.qtd;
    total+=sub;
    msg+=`â€¢ ${i.nome} x${i.qtd} - R$ ${sub.toFixed(2)}\n`;
  });

  msg+=`\nðŸ’° Total: R$ ${total.toFixed(2)}`;
  msg+=`\nðŸ‘¤ ${cliente.value}`;
  if(endereco.value) msg+=`\nðŸ“ ${endereco.value}`;
  msg+=`\nðŸ’³ Pagamento: ${pagamento.value}`;
  if(pagamento.value==="Dinheiro" && troco.value)
    msg+=`\nðŸ’µ Troco para: R$ ${troco.value}`;
  if(obs.value) msg+=`\nðŸ“ ${obs.value}`;

  window.open(`https://wa.me/55${whatsapp}?text=${encodeURIComponent(msg)}`,"_blank");

  limpar();
}

/* ===== SISTEMA ===== */
async function enviarSistema(){

  let total=0;
  carrinho.forEach(i=> total+=i.preco*i.qtd);

  const {data:pedido,error} = await sb
    .from("pedidos")
    .insert([{
      app_id:app_id,
      cliente_nome:cliente.value,
      forma_pagamento:pagamento.value,
      status:"novo",
      total:total
    }])
    .select()
    .single();

  if(error){
    alert("Erro ao enviar pedido.");
    console.error(error);
    return;
  }

  const itens = carrinho.map(i=>({
    pedido_id:pedido.id,
    nome_produto:i.nome,
    quantidade:i.qtd,
    preco:i.preco
  }));

  await sb.from("pedido_itens").insert(itens);

  alert("Pedido enviado com sucesso!");
  limpar();
}

function limpar(){
  carrinho=[];
  salvar();
  fecharCarrinho();
}

/* ================= TABS ================= */
btnBar.onclick=()=>{filtro="BAR";btnBar.classList.add("ativo");btnCozinha.classList.remove("ativo");render();};
btnCozinha.onclick=()=>{filtro="COZINHA";btnCozinha.classList.add("ativo");btnBar.classList.remove("ativo");render();};

(async()=>{
  await carregarConfig();
  await carregarProdutos();
})();
</script>
