<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Card√°pio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#8b5e3c;
  --bg:#f6f1eb;
  --text:#2e1f14;
  --border:#e6ded5;
  --card-bg:#ffffff;
}

*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);}

/* TOPO */
.topo{height:220px;display:flex;align-items:center;justify-content:center;position:relative;}
.banner{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.topo::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.35);}
.topo-conteudo{position:relative;color:#fff;text-align:center;}
.logo{max-height:70px;margin-bottom:10px}

/* TABS */
.tabs{display:flex;gap:12px;padding:16px;max-width:1100px;margin:auto;}
.tab{flex:1;padding:14px;border-radius:14px;border:2px solid var(--border);background:#fff;font-weight:900;cursor:pointer;}
.tab.ativo{background:var(--primary);color:#fff;border-color:var(--primary);}

/* GRID */
.container{
  max-width:1100px;
  margin:auto;
  padding:10px 16px 160px;
  display:grid;
  gap:16px;
}
@media (max-width:768px){
  .container{grid-template-columns:repeat(2,1fr);}
  .produto img{height:120px;}
}
@media (min-width:769px){
  .container{grid-template-columns:repeat(auto-fill,minmax(220px,1fr));}
}

/* PRODUTO */
.produto{
  background:var(--card-bg);
  border-radius:16px;
  padding:12px;
  border:1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap:8px;
}
.produto img{
  width:100%;
  height:150px;
  object-fit:cover;
  border-radius:12px;
}
.preco{font-weight:800;color:var(--primary)}
.add-btn{
  margin-top:auto;
  padding:10px;
  border:none;
  border-radius:12px;
  background:var(--primary);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}

/* CARRINHO */
.carrinho-btn{
  position:fixed;
  bottom:22px;
  left:50%;
  transform:translateX(-50%);
  background:var(--primary);
  color:#fff;
  padding:16px 30px;
  border-radius:999px;
  font-weight:900;
  cursor:pointer;
  z-index:20;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  z-index:30;
}
.modal-box{
  position:absolute;
  bottom:0;
  left:0;
  right:0;
  background:#fff;
  color:#000;
  border-radius:20px 20px 0 0;
  padding:16px;
  max-height:85vh;
  overflow:auto;
}
.item{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px;}
input,textarea,select{
  width:100%;
  margin-top:8px;
  padding:10px;
  border-radius:10px;
  border:1px solid #e5e7eb;
}
</style>
</head>

<body>

<div class="topo">
  <img id="banner" class="banner" style="display:none">
  <div class="topo-conteudo">
    <img id="logo" class="logo" style="display:none">
    <h1 id="nome">Card√°pio</h1>
  </div>
</div>

<div class="tabs">
  <button class="tab ativo" id="btnBar">üç∫ Bar</button>
  <button class="tab" id="btnCozinha">üçΩÔ∏è Restaurante</button>
</div>

<div class="container" id="conteudo"></div>

<div class="carrinho-btn" onclick="abrirCarrinho()">
  üõí Ver pedido (<span id="qtd">0</span>)
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <h3>üõí Seu pedido</h3>
    <div id="lista"></div>
    <b>Total: R$ <span id="total">0.00</span></b>
    <hr>
    <input id="cliente" placeholder="Seu nome *">
    <input id="endereco" placeholder="Endere√ßo / refer√™ncia">
    <select id="pagamento">
      <option value="">Forma de pagamento *</option>
      <option value="Pix">Pix</option>
      <option value="Cart√£o">Cart√£o</option>
      <option value="Dinheiro">Dinheiro</option>
    </select>
    <textarea id="obs" placeholder="Observa√ß√µes"></textarea>
    <button class="add-btn" onclick="finalizar()" id="btnFinalizar">
      Enviar
    </button>
    <button class="add-btn" style="background:#64748b" onclick="fecharCarrinho()">Fechar</button>
  </div>
</div>

<script>
const sb = supabase.createClient("https://pdajixsoowcyhnjwhgpc.supabase.co","sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw");
const app_id=new URLSearchParams(location.search).get("app_id");
if(!app_id){document.body.innerHTML="Indispon√≠vel";throw "";}

let produtos=[],filtro="BAR",carrinho=[],whatsapp="",fluxoPedido="whatsapp";

/* CONFIG */
async function carregarConfig(){
  const {data}=await sb.from("config_site").select("*").eq("app_id",app_id).single();
  if(!data)return;
  nome.innerText=data.nome_site||"Card√°pio";
  if(data.logo_url){logo.src=data.logo_url;logo.style.display="block";}
  if(data.banner_url){banner.src=data.banner_url;banner.style.display="block";}
  whatsapp=data.whatsapp||"";
  fluxoPedido=data.fluxo_pedido||"whatsapp";
  btnFinalizar.innerText=fluxoPedido==="sistema"?"Finalizar Pedido":"Enviar no WhatsApp";
}

/* PRODUTOS */
async function carregarProdutos(){
  const {data}=await sb.from("produtos")
    .select("id,nome,preco,foto,destino")
    .eq("app_id",app_id)
    .eq("ativo",true);
  produtos=data||[];
  render();
}

function render(){
  conteudo.innerHTML="";
  const filtrados = produtos.filter(p=>{
    const destino = (p.destino||"").toString().toUpperCase().trim();
    return destino===filtro;
  });

  if(filtrados.length===0){
    conteudo.innerHTML="<p>Nenhum produto encontrado.</p>";
    return;
  }

  filtrados.forEach(p=>{
    conteudo.innerHTML+=`
    <div class="produto">
      ${p.foto?`<img src="${p.foto}">`:""}
      <b>${p.nome}</b>
      <div class="preco">R$ ${Number(p.preco).toFixed(2)}</div>
      <button class="add-btn" onclick="addProduto('${p.id}')">
        Adicionar
      </button>
    </div>`;
  });
}

/* CARRINHO */
function addProduto(id){
  const p=produtos.find(x=>x.id===id);
  const i=carrinho.find(x=>x.id===id);
  i?i.qtd++:carrinho.push({...p,qtd:1});
  atualizarQtd();
}

function atualizarQtd(){
  qtd.innerText=carrinho.reduce((s,i)=>s+i.qtd,0);
}

function abrirCarrinho(){modal.style.display="block";renderCarrinho();}
function fecharCarrinho(){modal.style.display="none";}

function renderCarrinho(){
  lista.innerHTML="";let total=0;
  carrinho.forEach(i=>{
    total+=i.preco*i.qtd;
    lista.innerHTML+=`<div class="item">${i.nome} x${i.qtd}</div>`;
  });
  document.getElementById("total").innerText=total.toFixed(2);
}

/* FINALIZAR */
async function finalizar(){
  if(!cliente.value.trim()||!pagamento.value){
    alert("Preencha nome e pagamento");
    return;
  }

  if(fluxoPedido==="sistema"){
    let total=0;carrinho.forEach(i=>total+=i.preco*i.qtd);
    const {data:pedido}=await sb.from("pedidos").insert([{
      app_id,cliente_nome:cliente.value,
      forma_pagamento:pagamento.value,
      status:"novo",total
    }]).select().single();

    await sb.from("pedido_itens").insert(
      carrinho.map(i=>({
        pedido_id:pedido.id,
        nome_produto:i.nome,
        quantidade:i.qtd,
        preco:i.preco
      }))
    );

    alert("Pedido enviado!");
  }else{
    let msg="Novo Pedido\n";
    carrinho.forEach(i=>msg+=`${i.nome} x${i.qtd}\n`);
    window.open(`https://wa.me/55${whatsapp}?text=${encodeURIComponent(msg)}`);
  }

  carrinho=[];atualizarQtd();fecharCarrinho();
}

/* TABS */
btnBar.onclick=()=>{filtro="BAR";btnBar.classList.add("ativo");btnCozinha.classList.remove("ativo");render();}
btnCozinha.onclick=()=>{filtro="COZINHA";btnCozinha.classList.add("ativo");btnBar.classList.remove("ativo");render();}

(async()=>{await carregarConfig();await carregarProdutos();})();
</script>

</body>
</html>

