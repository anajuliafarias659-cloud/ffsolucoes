<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Card√°pio Delivery</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#f6f1eb}
header{background:#8b5e3c;color:#fff;padding:16px;text-align:center}
.tabs{display:flex;gap:10px;padding:10px}
.tabs button{flex:1;padding:12px;border-radius:10px;border:none;font-weight:700}
.tabs .ativo{background:#8b5e3c;color:#fff}
.lista{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;padding:12px}
.produto{background:#fff;border-radius:12px;padding:10px}
.produto img{width:100%;height:120px;object-fit:cover;border-radius:10px}
.produto button{width:100%;margin-top:6px;padding:10px;border:none;border-radius:10px;background:#8b5e3c;color:#fff;font-weight:700}
footer{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:10px;border-top:1px solid #ddd}
footer button{width:100%;padding:14px;border:none;border-radius:12px;background:#8b5e3c;color:#fff;font-size:16px}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
#modal .box{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:400px}
#modal input{width:100%;padding:10px;margin-bottom:8px}
</style>
</head>

<body>

<header>
  <h1 id="nome">Card√°pio Delivery</h1>
</header>

<div class="tabs">
  <button id="btnBar" class="ativo">üç∫ Bar</button>
  <button id="btnCozinha">üçΩÔ∏è Cozinha</button>
</div>

<div class="lista" id="lista"></div>

<footer>
  <div>Total: R$ <span id="total">0.00</span></div>
  <button onclick="abrirModal()">Finalizar pedido</button>
</footer>

<div id="modal">
  <div class="box">
    <h3>Finalizar pedido</h3>
    <input id="nomeCliente" placeholder="Nome" />
    <input id="whats" placeholder="WhatsApp" />
    <input id="endereco" placeholder="Endere√ßo" />
    <button onclick="enviarPedido()">Enviar pedido</button>
    <button onclick="fecharModal()">Cancelar</button>
  </div>
</div>

<script>
/* CONFIG */
const SUPA_URL = "https://pdajixsoowcyhnjwhgpc.supabase.co";
const SUPA_KEY = "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw";
const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

const params = new URLSearchParams(location.search);
const app_id = params.get("app");
if(!app_id){ alert("App inv√°lido"); }

/* STATE */
let produtos = [];
let carrinho = [];
let filtro = "BAR";

/* LOAD */
async function carregarProdutos(){
  const { data, error } = await sb
    .from("produtos")
    .select("id,nome,preco,foto,destino")
    .eq("app_id", app_id)
    .eq("ativo", true);

  if(error){ console.error(error); return; }
  produtos = data;
  render();
}

function render(){
  lista.innerHTML="";
  produtos.filter(p=>p.destino===filtro).forEach(p=>{
    lista.innerHTML+=`
      <div class="produto">
        ${p.foto?`<img src="${p.foto}">`:""}
        <b>${p.nome}</b><br>
        R$ ${p.preco.toFixed(2)}
        <button onclick="add('${p.id}')">Adicionar</button>
      </div>
    `;
  });
}

function add(id){
  const p = produtos.find(x=>x.id===id);
  const i = carrinho.find(x=>x.id===id);
  if(i) i.qtd++;
  else carrinho.push({...p,qtd:1});
  atualizarTotal();
}

function atualizarTotal(){
  const t = carrinho.reduce((s,i)=>s+(i.preco*i.qtd),0);
  total.innerText = t.toFixed(2);
}

/* TABS */
btnBar.onclick=()=>{filtro="BAR";btnBar.classList.add("ativo");btnCozinha.classList.remove("ativo");render();}
btnCozinha.onclick=()=>{filtro="COZINHA";btnCozinha.classList.add("ativo");btnBar.classList.remove("ativo");render();}

/* MODAL */
function abrirModal(){ if(carrinho.length===0)return alert("Carrinho vazio"); modal.style.display="flex"; }
function fecharModal(){ modal.style.display="none"; }

/* PEDIDO */
async function enviarPedido(){
  const nome = nomeCliente.value.trim();
  const whats = whats.value.trim();
  const end = endereco.value.trim();
  if(!nome||!whats||!end) return alert("Preenche tudo");

  const totalPedido = carrinho.reduce((s,i)=>s+(i.preco*i.qtd),0);

  const { data:pedido, error } = await sb
    .from("pedidos")
    .insert({
      app_id,
      nome_cliente:nome,
      whatsapp:whats,
      endereco:end,
      total:totalPedido,
      status:"novo"
    })
    .select()
    .single();

  if(error){ console.error(error); alert("Erro ao criar pedido"); return; }

  for(const i of carrinho){
    await sb.from("pedido_itens").insert({
      pedido_id:pedido.id,
      produto_id:i.id,
      nome:i.nome,
      preco:i.preco,
      qtd:i.qtd
    });
  }

  alert("Pedido enviado ‚úÖ");
  carrinho=[];
  atualizarTotal();
  fecharModal();
}

/* START */
carregarProdutos();
</script>

</body>
</html>
