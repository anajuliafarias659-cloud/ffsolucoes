<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CardÃ¡pio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#f6f1eb}
.top{padding:20px;background:#8b5e3c;color:#fff;text-align:center}
.produto{background:#fff;margin:12px;padding:12px;border-radius:12px}
button{padding:10px;border:none;border-radius:8px;background:#8b5e3c;color:#fff;font-weight:bold}
.cart{position:fixed;bottom:20px;left:50%;transform:translateX(-50%)}
</style>
</head>

<body>

<div class="top">
  <h2 id="nome">CardÃ¡pio</h2>
</div>

<div id="produtos"></div>

<div class="cart">
  <button onclick="verPedido()">ðŸ›’ Meu pedido (<span id="qtd">0</span>)</button>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const params = new URLSearchParams(location.search);
const mesa_id = params.get("mesa");
const app_id  = params.get("app_id");

if(!mesa_id || !app_id){
  alert("QR invÃ¡lido");
  throw "";
}

// ðŸ” identifica esse cliente
let pedido_id = localStorage.getItem(`pedido_${mesa_id}`);

async function garantirPedido(){
  if(pedido_id) return;

  const { data } = await sb.from("pedidos")
    .insert({
      app_id,
      mesa_id,
      status:"aberto",
      origem:"cliente"
    })
    .select()
    .single();

  pedido_id = data.id;
  localStorage.setItem(`pedido_${mesa_id}`, pedido_id);
}

let produtos = [];
let carrinho = [];

async function carregarProdutos(){
  const { data } = await sb
    .from("produtos")
    .select("id,nome,preco")
    .eq("app_id",app_id)
    .eq("ativo",true);

  produtos = data || [];
  render();
}

function render(){
  const div = document.getElementById("produtos");
  div.innerHTML="";
  produtos.forEach(p=>{
    div.innerHTML+=`
      <div class="produto">
        <b>${p.nome}</b><br>
        R$ ${p.preco.toFixed(2)}<br><br>
        <button onclick="add('${p.id}')">Adicionar</button>
      </div>
    `;
  });
}

async function add(id){
  const p = produtos.find(x=>x.id===id);
  carrinho.push(p);

  await sb.from("pedido_itens").insert({
    app_id,
    pedido_id,
    produto_id:p.id,
    nome_produto:p.nome,
    preco:p.preco,
    quantidade:1,
    status:"novo"
  });

  document.getElementById("qtd").innerText = carrinho.length;
}

function verPedido(){
  location.href = `meu-pedido.html?pedido=${pedido_id}&app_id=${app_id}`;
}

(async()=>{
  await garantirPedido();
  await carregarProdutos();
})();
</script>

</body>
</html>
