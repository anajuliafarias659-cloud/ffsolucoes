<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Venda Avulsa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{background:#0f172a;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.container{max-width:600px;margin:auto;padding:24px}
.card{background:#0f172a;padding:20px;border-radius:16px}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:10px;
  border:none
}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.troco{color:#22c55e;font-weight:bold;margin-top:10px}
</style>
</head>

<body>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const admin = JSON.parse(localStorage.getItem("admin_logado"));
const funcionario = JSON.parse(localStorage.getItem("funcionario_logado"));
const app_id = admin?.app_id || funcionario?.app_id;

if(!app_id){
  alert("SessÃ£o expirada");
  location.href="login-funcionario.html";
}
</script>

<div class="topo">
  <h2>âž• Venda Avulsa</h2>
  <button onclick="location.href='caixa.html'">Voltar</button>
</div>

<div class="container">
  <div class="card">

    <input id="descricao" placeholder="DescriÃ§Ã£o (ex: Ãgua, Cerveja, Bala)">
    <input id="valorVenda" type="number" step="0.01" placeholder="Valor da venda">

    <select id="forma" onchange="ajustarForma()">
      <option value="dinheiro">Dinheiro</option>
      <option value="pix">PIX</option>
      <option value="debito">DÃ©bito</option>
      <option value="credito">CrÃ©dito</option>
    </select>

    <input id="valorRecebido" type="number" step="0.01" placeholder="Valor recebido">

    <div id="troco" class="troco"></div>

    <button onclick="finalizar()">âœ… Finalizar venda</button>

  </div>
</div>

<script>
function ajustarForma(){
  const forma = document.getElementById("forma").value;
  const recebido = document.getElementById("valorRecebido");
  document.getElementById("troco").innerHTML = "";

  if(forma !== "dinheiro"){
    recebido.value = "";
    recebido.disabled = true;
  } else {
    recebido.disabled = false;
  }
}

async function finalizar(){
  const descricao = document.getElementById("descricao").value || "Venda avulsa";
  const valorVenda = Number(document.getElementById("valorVenda").value || 0);
  const forma = document.getElementById("forma").value;
  let valorRecebido = Number(document.getElementById("valorRecebido").value || 0);

  if(valorVenda <= 0){
    alert("Informe o valor da venda");
    return;
  }

  let troco = 0;

  if(forma === "dinheiro"){
    if(valorRecebido < valorVenda){
      alert("Valor recebido insuficiente");
      return;
    }
    troco = valorRecebido - valorVenda;
  }

  await sb.from("pagamentos").insert({
    app_id,
    pedido_id: null,
    tipo: forma,
    valor: valorVenda,      // ðŸ”¥ isso entra no caixa
    troco: forma === "dinheiro" ? troco : 0,
    descricao
  });

  alert("Venda registrada com sucesso");
  location.href = "caixa.html";
}

ajustarForma();
</script>

</body>
</html>
