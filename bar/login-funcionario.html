<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Login do FuncionÃ¡rio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#020617;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  background:#0f172a;
  padding:28px;
  border-radius:18px;
  width:100%;
  max-width:360px;
}
h2{
  margin-top:0;
  text-align:center;
}
input,button{
  width:100%;
  padding:12px;
  margin-top:12px;
  border-radius:10px;
  border:none;
}
button{
  background:#22c55e;
  font-weight:bold;
  cursor:pointer;
}
.msg{
  margin-top:12px;
  text-align:center;
  font-size:14px;
  color:#f87171;
}
small{
  display:block;
  text-align:center;
  opacity:.6;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="card">
  <h2>ðŸ‘¤ FuncionÃ¡rio</h2>

  <!-- Nome apenas visual -->
  <input id="nome" placeholder="Nome do funcionÃ¡rio" disabled>
  <input id="pin" type="password" placeholder="PIN">

  <button onclick="entrar()">Entrar</button>

  <div class="msg" id="msg"></div>

  <small>Acesso interno do bar</small>
</div>

<script>
// ================= SUPABASE =================
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

// ================= PARAMS DO QR =================
const params = new URLSearchParams(location.search);
const uid = params.get("uid");
const app_id = params.get("app_id");

if(!uid || !app_id){
  alert("QR invÃ¡lido ou expirado");
  location.href = "../auth/login.html";
}

// ================= CARREGAR USUÃRIO PELO QR =================
let usuario = null;

(async ()=>{
  const { data, error } = await sb
    .from("usuarios")
    .select("id,nome,tipo,pin")
    .eq("id", uid)
    .eq("app_id", app_id)
    .eq("ativo", true)
    .maybeSingle();

  if(error || !data){
    alert("FuncionÃ¡rio invÃ¡lido ou desativado");
    location.href = "../auth/login.html";
    return;
  }

  usuario = data;
  document.getElementById("nome").value = data.nome;
})();

// ================= LOGIN =================
async function entrar(){
  const pinDigitado = document.getElementById("pin").value.trim();
  const msg = document.getElementById("msg");

  msg.innerText = "";

  if(!pinDigitado){
    msg.innerText = "Informe o PIN";
    return;
  }

  // ðŸ” valida PIN
  if(String(usuario.pin).trim() !== pinDigitado){
    msg.innerText = "PIN incorreto";
    return;
  }

  // âœ… salva sessÃ£o
  localStorage.setItem("usuario_bar", JSON.stringify({
    id: usuario.id,
    nome: usuario.nome,
    tipo: usuario.tipo,
    app_id
  }));

  // ðŸš¦ redireciona por tipo
  if(usuario.tipo === "garcom"){
    location.href = "mesas.html";
  }else if(usuario.tipo === "caixa"){
    location.href = "caixa.html";
  }else{
    msg.innerText = "Tipo de usuÃ¡rio invÃ¡lido";
  }
}

// Enter para login
document.addEventListener("keydown", e=>{
  if(e.key === "Enter") entrar();
});
</script>

</body>
</html>
