<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="../js/auth.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{
  background:#0f172a;
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center
}
.container{max-width:1200px;margin:auto;padding:24px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}

.resumo-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px;
  margin-top:15px;
}

.card{
  background:#1e293b;
  padding:15px;
  border-radius:12px;
  text-align:center;
}

.card h4{
  margin:0;
  color:#94a3b8;
  font-size:14px;
}

.card p{
  margin:8px 0 0 0;
  font-size:20px;
  font-weight:bold;
  color:#22c55e;
}

button{
  padding:10px 16px;
  border:none;
  border-radius:10px;
  background:#22c55e;
  font-weight:bold;
  cursor:pointer
}
button.sec{background:#1e293b;color:#fff}

.badge{
  background:#ef4444;
  color:#fff;
  border-radius:999px;
  padding:2px 8px;
  font-size:12px;
  margin-left:6px
}

table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #1e293b;font-size:14px}
th{color:#94a3b8}

@keyframes piscar{
  0%{box-shadow:0 0 0 transparent}
  50%{box-shadow:0 0 18px rgba(234,179,8,.9)}
  100%{box-shadow:0 0 0 transparent}
}
.alerta.piscar{animation:piscar 1s infinite}
</style>
</head>

<body>

<div class="topo">
  <h2>ðŸ’° Caixa</h2>
  <div>
    <button onclick="irPara('venda-avulsa.html')">âž• Venda Avulsa</button>

    <button class="alerta" id="btnContas" style="display:none" onclick="scrollContas()">
      ðŸ”” Contas <span class="badge" id="qtdContas">0</span>
    </button>

    <button class="sec" onclick="irPara('historico.html')">ðŸ“Š HistÃ³rico</button>
    <button class="sec" onclick="irPara('admin.html')">Voltar</button>
  </div>
</div>

<div class="container">

  <!-- ===== RESUMO DO CAIXA ===== -->
  <div class="box">
    <h3>ðŸ“Š Fechamento de Caixa</h3>

    <div class="resumo-grid">
      <div class="card">
        <h4>Total Recebido</h4>
        <p id="totalRecebido">R$ 0.00</p>
      </div>

      <div class="card">
        <h4>Quantidade de Vendas</h4>
        <p id="qtdVendas">0</p>
      </div>

      <div class="card">
        <h4>Data</h4>
        <p id="dataHoje">--/--/----</p>
      </div>
    </div>

    <br>
    <button onclick="gerarFechamento()">ðŸ“¥ Atualizar Fechamento</button>
  </div>

  <!-- ===== CONTAS ===== -->
  <div class="box" id="boxContas" style="display:none">
    <h3>ðŸ§¾ Mesas aguardando pagamento</h3>
    <table>
      <thead>
        <tr>
          <th>Mesa</th>
          <th>Total</th>
          <th>AÃ§Ã£o</th>
        </tr>
      </thead>
      <tbody id="listaContas"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { supabase } from "../js/supabase.js";

async function iniciar(){
  const { data: { session } } = await supabase.auth.getSession();
  if(!session){ location.href="/auth/login.html"; return; }

  const { data: usuario } = await supabase
    .from("usuarios")
    .select("app_id")
    .eq("id", session.user.id)
    .single();

  if(!usuario){ location.href="/auth/login.html"; return; }

  const appId = usuario.app_id;

  verificarContas(appId);
  gerarFechamento(appId);

  setInterval(()=>verificarContas(appId),3000);
}

window.gerarFechamento = async function(){

  const { data: { session } } = await supabase.auth.getSession();
  const { data: usuario } = await supabase
    .from("usuarios")
    .select("app_id")
    .eq("id", session.user.id)
    .single();

  const appId = usuario.app_id;

  const hoje = new Date().toISOString().split("T")[0];

  const { data } = await supabase
    .from("pedidos")
    .select(`
      id,
      pedido_itens(preco,quantidade),
      created_at
    `)
    .eq("app_id", appId)
    .eq("status", "pago");

  let total = 0;

  const vendasHoje = (data || []).filter(p =>
    p.created_at.startsWith(hoje)
  );

  vendasHoje.forEach(p=>{
    (p.pedido_itens || []).forEach(i=>{
      total += Number(i.preco) * Number(i.quantidade);
    });
  });

  document.getElementById("totalRecebido").innerText =
    "R$ " + total.toFixed(2);

  document.getElementById("qtdVendas").innerText =
    vendasHoje.length;

  document.getElementById("dataHoje").innerText =
    new Date().toLocaleDateString("pt-BR");
};

window.irPara = p => location.href = p;
window.scrollContas = () =>
  document.getElementById("boxContas")
    .scrollIntoView({behavior:"smooth"});

window.irPagamento = id =>
  location.href = `pagamento.html?pedido=${id}`;

async function verificarContas(appId){

  const { data } = await supabase
    .from("pedidos")
    .select(`
      id,
      mesas(numero_mesa),
      pedido_itens(preco,quantidade)
    `)
    .eq("app_id", appId)
    .eq("status", "conta_solicitada");

  const btn = document.getElementById("btnContas");
  const qtd = document.getElementById("qtdContas");
  const box = document.getElementById("boxContas");
  const lista = document.getElementById("listaContas");

  lista.innerHTML = "";

  if(data && data.length > 0){

    btn.style.display = "inline-block";
    btn.classList.add("piscar");
    qtd.innerText = data.length;
    box.style.display = "block";

    data.forEach(p=>{
      let total = 0;
      (p.pedido_itens || []).forEach(i=>{
        total += Number(i.preco) * Number(i.quantidade);
      });

      lista.innerHTML += `
        <tr>
          <td>Mesa ${p.mesas?.numero_mesa || "-"}</td>
          <td>R$ ${total.toFixed(2)}</td>
          <td>
            <button onclick="irPagamento('${p.id}')">ðŸ’³ Pagar</button>
          </td>
        </tr>
      `;
    });

  } else {
    btn.style.display = "none";
    btn.classList.remove("piscar");
    box.style.display = "none";
  }
}

iniciar();
</script>

</body>
</html>
