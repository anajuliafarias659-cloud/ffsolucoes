<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{background:#0f172a;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.container{max-width:1200px;margin:auto;padding:24px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
.card{background:#020617;border:1px solid #1e293b;border-radius:12px;padding:14px}
.valor{font-size:22px;font-weight:bold;margin-top:6px}
.tipo{font-size:13px;color:#94a3b8}
.total{font-size:26px;font-weight:bold}
.positivo{color:#22c55e}
.negativo{color:#ef4444}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #1e293b;font-size:14px}
th{color:#94a3b8}
button{padding:10px 16px;border:none;border-radius:10px;background:#22c55e;font-weight:bold;cursor:pointer}
button.sec{background:#1e293b;color:#fff}
small{font-size:14px}
</style>
</head>

<body>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ================= USU√ÅRIO LOGADO ================= */
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin?.app_id || !admin?.id){
  alert("Sess√£o expirada");
  location.href="../auth/login.html";
}

let total = { dinheiro:0, pix:0, debito:0, credito:0, fiado:0 };
let totalSaidas = 0;
</script>

<div class="topo">
  <h2>üí∞ Caixa</h2>
  <div>
    <button onclick="fecharCaixa()">üîí Fechar Caixa</button>
    <button class="sec" onclick="location.href='admin.html'">Voltar</button>
  </div>
</div>

<div class="container">

<div class="box">
  <label>üìÖ Data do caixa</label><br>
  <input type="date" id="dataCaixa">
  <button onclick="carregarCaixa()">Filtrar</button>
</div>

<div class="grid">
  <div class="card"><div class="tipo">Dinheiro</div><div class="valor positivo" id="tDinheiro">R$ 0,00</div></div>
  <div class="card"><div class="tipo">Pix</div><div class="valor positivo" id="tPix">R$ 0,00</div></div>
  <div class="card"><div class="tipo">D√©bito</div><div class="valor positivo" id="tDebito">R$ 0,00</div></div>
  <div class="card"><div class="tipo">Cr√©dito</div><div class="valor positivo" id="tCredito">R$ 0,00</div></div>
  <div class="card"><div class="tipo">Fiado</div><div class="valor negativo" id="tFiado">R$ 0,00</div></div>
</div>

<div class="box">
  <h3>üìã Movimenta√ß√µes</h3>
  <table>
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Valor</th>
        <th>Operador</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<div class="box">
  <p class="total">
    Total em caixa: R$ <span id="totalCaixa">0.00</span><br>
    <small class="negativo">Sa√≠das: R$ <span id="totalSaidas">0.00</span></small>
  </p>
</div>

</div>

<script>
async function carregarCaixa(){

  const data =
    document.getElementById("dataCaixa").value ||
    new Date().toISOString().split("T")[0];

  document.getElementById("dataCaixa").value = data;

  const inicio = data + "T00:00:00";
  const fim = data + "T23:59:59";

  total = { dinheiro:0, pix:0, debito:0, credito:0, fiado:0 };
  totalSaidas = 0;
  lista.innerHTML = "";

  /* ================= PAGAMENTOS ================= */

  let pagamentos = [];

  if(admin.nivel === "admin"){
    const { data } = await sb
      .from("pagamentos")
      .select("tipo,valor,funcionario_id")
      .eq("app_id", admin.app_id)
      .gte("created_at", inicio)
      .lte("created_at", fim);
    pagamentos = data || [];
  } else {
    const { data: meus } = await sb
      .from("pagamentos")
      .select("tipo,valor,funcionario_id")
      .eq("app_id", admin.app_id)
      .eq("funcionario_id", admin.id)
      .gte("created_at", inicio)
      .lte("created_at", fim);

    const { data: semFunc } = await sb
      .from("pagamentos")
      .select("tipo,valor,funcionario_id")
      .eq("app_id", admin.app_id)
      .is("funcionario_id", null)
      .gte("created_at", inicio)
      .lte("created_at", fim);

    pagamentos = [...(meus||[]), ...(semFunc||[])];
  }

  pagamentos.forEach(p=>{
    const tipo = p.tipo.toLowerCase();
    const valor = Number(p.valor)||0;
    if(total[tipo] !== undefined) total[tipo] += valor;

    lista.innerHTML += `
      <tr>
        <td>${p.tipo.toUpperCase()}</td>
        <td>R$ ${valor.toFixed(2)}</td>
        <td>${p.funcionario_id ? p.funcionario_id.slice(0,6) : "‚Äî"}</td>
      </tr>
    `;
  });

  /* ================= DESPESAS ================= */

  let despesas = [];

  if(admin.nivel === "admin"){
    const { data } = await sb
      .from("despesas")
      .select("valor")
      .eq("app_id", admin.app_id)
      .gte("created_at", inicio)
      .lte("created_at", fim);
    despesas = data || [];
  } else {
    const { data: minhas } = await sb
      .from("despesas")
      .select("valor")
      .eq("app_id", admin.app_id)
      .eq("funcionario_id", admin.id)
      .gte("created_at", inicio)
      .lte("created_at", fim);

    const { data: semFunc } = await sb
      .from("despesas")
      .select("valor")
      .eq("app_id", admin.app_id)
      .is("funcionario_id", null)
      .gte("created_at", inicio)
      .lte("created_at", fim);

    despesas = [...(minhas||[]), ...(semFunc||[])];
  }

  totalSaidas = despesas.reduce((s,d)=>s + Number(d.valor),0);

  /* ================= TOTAIS ================= */
  tDinheiro.innerText = "R$ " + total.dinheiro.toFixed(2);
  tPix.innerText = "R$ " + total.pix.toFixed(2);
  tDebito.innerText = "R$ " + total.debito.toFixed(2);
  tCredito.innerText = "R$ " + total.credito.toFixed(2);
  tFiado.innerText = "R$ " + total.fiado.toFixed(2);

  const totalCaixa =
    total.dinheiro + total.pix + total.debito + total.credito;

  totalCaixaSpan.innerText = totalCaixa.toFixed(2);
  totalSaidasSpan.innerText = totalSaidas.toFixed(2);
}

/* ================= FECHAR CAIXA ================= */
async function fecharCaixa(){
  const data = document.getElementById("dataCaixa").value;
  if(!data){ alert("Selecione a data"); return; }

  if(!confirm("Deseja fechar o caixa deste dia?")) return;

  await sb.from("fechamento_caixa").insert({
    app_id: admin.app_id,
    funcionario_id: admin.id,
    data,
    total_dinheiro: total.dinheiro,
    total_pix: total.pix,
    total_debito: total.debito,
    total_credito: total.credito,
    total_fiado: total.fiado,
    total_caixa:
      total.dinheiro + total.pix + total.debito + total.credito,
    total_saidas: totalSaidas
  });

  alert("Caixa fechado com sucesso ‚úÖ");
}

/* ================= START ================= */
carregarCaixa();
</script>

</body>
</html>
