<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pagamento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="../js/auth.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{background:#0f172a;padding:16px 24px}
.container{max-width:600px;margin:auto;padding:24px}
.box{background:#0f172a;padding:20px;border-radius:16px}
button{width:100%;padding:14px;border:none;border-radius:10px;background:#22c55e;font-weight:bold;cursor:pointer;margin-top:12px}
input,select{width:100%;padding:12px;margin-top:10px;border-radius:10px;border:none}
.alert{color:#facc15;margin-top:8px}
</style>
</head>

<body>

<div class="topo">
  <h2>üí≥ Pagamento</h2>
</div>

<div class="container">
  <div class="box">

    <p>Total</p>
    <h2 id="totalPedido">R$ 0,00</h2>

    <label>Forma de Pagamento</label>
    <select id="formaPagamento">
      <option value="Dinheiro">Dinheiro</option>
      <option value="Pix">Pix</option>
      <option value="Cart√£o Cr√©dito">Cart√£o Cr√©dito</option>
      <option value="Cart√£o D√©bito">Cart√£o D√©bito</option>
    </select>

    <label>Valor pago</label>
    <input type="number" id="valorRecebido" step="0.01">

    <p id="info" class="alert"></p>

    <p>Troco</p>
    <h3 id="troco">R$ 0,00</h3>

    <button id="btnConfirmar">Confirmar</button>

  </div>
</div>

<script type="module">
import { supabase } from "../js/supabase.js";

const params = new URLSearchParams(location.search);
const pedidoId = params.get("pedido");

let totalPedido = 0;
let mesaId = null;
let processando = false;

/* üîê AGUARDA APP_ID */
async function aguardarSessao(){
  while(!window.APP_ID){
    await new Promise(r=>setTimeout(r,100));
  }

  if(!pedidoId){
    location.href="caixa.html";
    return;
  }

  carregarPedido();
}
aguardarSessao();

/* CARREGAR PEDIDO */
async function carregarPedido(){

  const { data: pedido } = await supabase
    .from("pedidos")
    .select("mesa_id")
    .eq("id", pedidoId)
    .eq("app_id", window.APP_ID)
    .single();

  if(!pedido){
    alert("Pedido n√£o encontrado");
    location.href="caixa.html";
    return;
  }

  mesaId = pedido.mesa_id;

  const { data: itens } = await supabase
    .from("pedido_itens")
    .select("preco,quantidade")
    .eq("pedido_id", pedidoId);

  totalPedido = 0;

  (itens || []).forEach(i=>{
    totalPedido += Number(i.preco) * Number(i.quantidade);
  });

  document.getElementById("totalPedido").innerText =
    `R$ ${totalPedido.toFixed(2)}`;
}

/* CALCULAR TROCO */
function calcular(){

  const recebido =
    Number(document.getElementById("valorRecebido").value || 0);

  const descontoMax = totalPedido * 0.10;
  const minimo = totalPedido - descontoMax;

  const info = document.getElementById("info");
  const trocoEl = document.getElementById("troco");

  if(recebido < minimo){
    info.innerText =
      `Desconto m√°ximo permitido: R$ ${descontoMax.toFixed(2)}`;
  }
  else if(recebido < totalPedido){
    info.innerText =
      `Desconto aplicado: R$ ${(totalPedido - recebido).toFixed(2)}`;
  }
  else{
    info.innerText="";
  }

  const troco =
    recebido > totalPedido ? recebido - totalPedido : 0;

  trocoEl.innerText = `R$ ${troco.toFixed(2)}`;
}

document
  .getElementById("valorRecebido")
  .addEventListener("input", calcular);

/* CONFIRMAR PAGAMENTO */
document
  .getElementById("btnConfirmar")
  .addEventListener("click", confirmarPagamento);

async function confirmarPagamento(){

  if(processando) return;
  processando = true;

  try{

    const valorPago =
      Number(document.getElementById("valorRecebido").value);

    const formaPagamento =
      document.getElementById("formaPagamento").value;

    if(!valorPago || valorPago <= 0){
      processando = false;
      return;
    }

    const descontoMax = totalPedido * 0.10;
    const minimo = totalPedido - descontoMax;

    if(valorPago < minimo){
      alert("Desconto acima do permitido");
      processando = false;
      return;
    }

    const { data:{ session } } =
      await supabase.auth.getSession();

    const nomeUsuario =
      session?.user?.email || "Sistema";

    /* 1Ô∏è‚É£ FINALIZA PEDIDO + SALVA PAGAMENTO */

    const { error: erroUpdate } = await supabase
      .from("pedidos")
      .update({
        status: "finalizado",
        forma_pagamento: formaPagamento,
        recebido_em: new Date(),
        recebido_por: nomeUsuario
      })
      .eq("id", pedidoId)
      .eq("app_id", window.APP_ID);

    if(erroUpdate){
      alert("Erro ao finalizar pedido");
      processando = false;
      return;
    }

    /* 2Ô∏è‚É£ BAIXA ESTOQUE */

    const { data: itens } = await supabase
      .from("pedido_itens")
      .select("produto_id,quantidade")
      .eq("pedido_id", pedidoId);

    if(itens){
      for(const item of itens){
        await supabase.rpc("baixar_estoque", {
          p_produto_id: item.produto_id,
          p_quantidade: item.quantidade
        });
      }
    }

    /* 3Ô∏è‚É£ LIBERA MESA */

    if(mesaId){
      await supabase
        .from("mesas")
        .update({ status: "livre" })
        .eq("id", mesaId)
        .eq("app_id", window.APP_ID);
    }

    location.href="caixa.html";

  } catch(e){
    alert("Erro inesperado");
  }

  processando = false;
}
</script>

</body>
</html>
