<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="../js/auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{background:#0f172a;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.container{max-width:1200px;margin:auto;padding:24px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}
.resumo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:15px}
.card{background:#1e293b;padding:15px;border-radius:12px;text-align:center}
.card h4{margin:0;color:#94a3b8;font-size:14px}
.card p{margin:8px 0 0 0;font-size:18px;font-weight:bold;color:#22c55e}
button{padding:10px 16px;border:none;border-radius:10px;background:#22c55e;font-weight:bold;cursor:pointer;margin-right:8px}
button.sec{background:#1e293b;color:#fff}
.badge{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #1e293b;font-size:14px}
th{color:#94a3b8}
@keyframes piscar{0%{box-shadow:0 0 0 transparent}50%{box-shadow:0 0 18px rgba(234,179,8,.9)}100%{box-shadow:0 0 0 transparent}}
.alerta.piscar{animation:piscar 1s infinite}
</style>
</head>

<body>

<div class="topo">
  <h2>ðŸ’° Caixa</h2>
  <div>
    <button onclick="irPara('venda-avulsa.html')">âž• Venda Avulsa</button>
    <button class="alerta" id="btnContas" style="display:none" onclick="scrollContas()">
      ðŸ”” Contas <span class="badge" id="qtdContas">0</span>
    </button>
    <button class="sec" onclick="irPara('historico.html')">ðŸ“Š HistÃ³rico</button>
    <button class="sec" onclick="irPara('admin.html')">Voltar</button>
  </div>
</div>

<div class="container">

  <div class="box">
    <h3>ðŸ“Š Fechamento de Caixa</h3>

    <div class="resumo-grid">
      <div class="card">
        <h4>Total Recebido Hoje</h4>
        <p id="totalRecebido">R$ 0.00</p>
      </div>
      <div class="card">
        <h4>Quantidade de Vendas</h4>
        <p id="qtdVendas">0</p>
      </div>
      <div class="card">
        <h4>Data</h4>
        <p id="dataHoje">--/--/----</p>
      </div>
    </div>

    <br>
    <button onclick="gerarFechamento()">ðŸ”„ Atualizar</button>
    <button onclick="fecharCaixa()">ðŸ“„ Fechar Caixa Hoje (PDF)</button>
  </div>

  <div class="box" id="boxContas" style="display:none">
    <h3>ðŸ§¾ Mesas aguardando pagamento</h3>
    <table>
      <thead>
        <tr>
          <th>Mesa</th>
          <th>Total</th>
          <th>AÃ§Ã£o</th>
        </tr>
      </thead>
      <tbody id="listaContas"></tbody>
    </table>
  </div>

</div>

<script type="module">
import { supabase } from "../js/supabase.js";

let resumoPagamentosGlobal = "";
let canalRealtime = null;

/* =========================
   AGUARDAR SESSÃƒO
========================= */
async function aguardarSessao(){
  while(!window.APP_ID){
    await new Promise(r=>setTimeout(r,100));
  }

  await verificarContas(window.APP_ID);
  await gerarFechamento();
  ativarRealtime();
}
aguardarSessao();

window.irPara = p => location.href = p;
window.scrollContas = () => document.getElementById("boxContas").scrollIntoView({behavior:"smooth"});
window.irPagamento = id => location.href = `pagamento.html?pedido=${id}`;

/* =========================
   REALTIME PROFISSIONAL
========================= */
function ativarRealtime(){

  if(canalRealtime){
    supabase.removeChannel(canalRealtime);
  }

  canalRealtime = supabase
    .channel("caixa-contas-"+window.APP_ID)
    .on(
      "postgres_changes",
      {
        event: "*",
        schema: "public",
        table: "pedidos",
        filter: `app_id=eq.${window.APP_ID}`
      },
      async (payload) => {

        const novoStatus = payload.new?.status;

        if(novoStatus === "conta_solicitada"){
          tocarSomNotificacao();
        }

        await verificarContas(window.APP_ID);
        await gerarFechamento();
      }
    )
    .subscribe();
}

/* =========================
   SOM NOTIFICAÃ‡ÃƒO
========================= */
function tocarSomNotificacao(){
  const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  audio.play().catch(()=>{});
}

/* =========================
   GERAR FECHAMENTO
========================= */
window.gerarFechamento = async function(){

  const inicio = new Date();
  inicio.setHours(0,0,0,0);
  const amanha = new Date(inicio.getTime() + 86400000);

  const { data: pedidos } = await supabase
    .from("pedidos")
    .select("id, forma_pagamento, created_at")
    .eq("app_id", window.APP_ID)
    .eq("status", "finalizado")
    .gte("created_at", inicio.toISOString())
    .lt("created_at", amanha.toISOString());

  if(!pedidos || pedidos.length === 0){
    document.getElementById("totalRecebido").innerText = "R$ 0.00";
    document.getElementById("qtdVendas").innerText = "0";
    document.getElementById("dataHoje").innerText = new Date().toLocaleDateString("pt-BR");
    resumoPagamentosGlobal = "";
    return;
  }

  const ids = pedidos.map(p => p.id);

  const { data: itens } = await supabase
    .from("pedido_itens")
    .select("pedido_id, preco, quantidade")
    .in("pedido_id", ids);

  let total = 0;
  let pagamentos = {};

  pedidos.forEach(p => {
    let totalPedido = 0;

    (itens || [])
      .filter(i => i.pedido_id === p.id)
      .forEach(i => {
        totalPedido += Number(i.preco) * Number(i.quantidade);
      });

    total += totalPedido;

    const forma = p.forma_pagamento || "NÃ£o informado";
    if(!pagamentos[forma]) pagamentos[forma] = 0;
    pagamentos[forma] += totalPedido;
  });

  document.getElementById("totalRecebido").innerText = "R$ " + total.toFixed(2);
  document.getElementById("qtdVendas").innerText = pedidos.length;
  document.getElementById("dataHoje").innerText = new Date().toLocaleDateString("pt-BR");

  let resumo = "";
  for(const forma in pagamentos){
    resumo += `${forma}: R$ ${pagamentos[forma].toFixed(2)}\n`;
  }
  resumoPagamentosGlobal = resumo;
};

/* =========================
   FECHAR CAIXA
========================= */
window.fecharCaixa = async function(){

  await gerarFechamento();

  const totalTexto = document.getElementById("totalRecebido").innerText;
  const qtd = parseInt(document.getElementById("qtdVendas").innerText);
  const dataBR = document.getElementById("dataHoje").innerText;

  const totalNumero = Number(totalTexto.replace("R$","").trim());

  if(qtd === 0){
    alert("NÃ£o hÃ¡ vendas para fechar hoje.");
    return;
  }

  if(!confirm("Deseja realmente fechar o caixa?")){
    return;
  }

  await supabase.from("fechamentos_caixa").insert([{
    app_id: window.APP_ID,
    data: new Date().toISOString().split("T")[0],
    total: totalNumero,
    qtd_vendas: qtd,
    resumo_pagamentos: resumoPagamentosGlobal
  }]);

  const inicio = new Date();
  inicio.setHours(0,0,0,0);
  const amanha = new Date(inicio.getTime() + 86400000);

  await supabase
    .from("pedidos")
    .update({ status: "fechado" })
    .eq("app_id", window.APP_ID)
    .eq("status", "finalizado")
    .gte("created_at", inicio.toISOString())
    .lt("created_at", amanha.toISOString());

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("FECHAMENTO DE CAIXA", 20, 20);
  doc.setFontSize(12);
  doc.text("Data: " + dataBR, 20, 35);
  doc.text("Quantidade de Vendas: " + qtd, 20, 45);
  doc.text("Total Recebido: R$ " + totalNumero.toFixed(2), 20, 55);

  if(resumoPagamentosGlobal){
    doc.text("Por Forma de Pagamento:", 20, 70);
    const linhas = doc.splitTextToSize(resumoPagamentosGlobal, 170);
    doc.text(linhas, 20, 80);
  }

  doc.save("fechamento-caixa-" + dataBR + ".pdf");

  document.getElementById("totalRecebido").innerText = "R$ 0.00";
  document.getElementById("qtdVendas").innerText = "0";
  resumoPagamentosGlobal = "";

  alert("âœ… Caixa fechado com sucesso!");
};

/* =========================
   CONTAS
========================= */
async function verificarContas(appId){

  const { data } = await supabase
    .from("pedidos")
    .select("id, mesas(numero_mesa), pedido_itens(preco,quantidade)")
    .eq("app_id", appId)
    .eq("status", "conta_solicitada");

  const btn = document.getElementById("btnContas");
  const qtd = document.getElementById("qtdContas");
  const box = document.getElementById("boxContas");
  const lista = document.getElementById("listaContas");

  lista.innerHTML = "";

  if(data && data.length > 0){
    btn.style.display = "inline-block";
    btn.classList.add("piscar");
    qtd.innerText = data.length;
    box.style.display = "block";

    data.forEach(p=>{
      let total = 0;
      (p.pedido_itens || []).forEach(i=>{
        total += Number(i.preco) * Number(i.quantidade);
      });

      lista.innerHTML += `
        <tr>
          <td>Mesa ${p.mesas?.numero_mesa || "-"}</td>
          <td>R$ ${total.toFixed(2)}</td>
          <td>
            <button onclick="irPagamento('${p.id}')">ðŸ’³ Pagar</button>
          </td>
        </tr>
      `;
    });

  } else {
    btn.style.display = "none";
    btn.classList.remove("piscar");
    box.style.display = "none";
  }
}
</script>


</body>
</html>

