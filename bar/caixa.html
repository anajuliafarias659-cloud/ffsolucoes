<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caixa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="../js/auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{background:#0f172a;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.container{max-width:1200px;margin:auto;padding:24px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}
.resumo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:15px}
.card{background:#1e293b;padding:15px;border-radius:12px;text-align:center}
.card h4{margin:0;color:#94a3b8;font-size:14px}
.card p{margin:8px 0 0 0;font-size:18px;font-weight:bold;color:#22c55e}
button{padding:10px 16px;border:none;border-radius:10px;background:#22c55e;font-weight:bold;cursor:pointer;margin-right:8px}
button.sec{background:#1e293b;color:#fff}
</style>
</head>

<body>

<div class="topo">
  <h2>ðŸ’° Caixa</h2>
  <div>
    <button onclick="gerarFechamento()">ðŸ”„ Atualizar</button>
    <button onclick="fecharCaixa()">ðŸ“„ Gerar PDF</button>
    <button class="sec" onclick="location.href='admin.html'">Voltar</button>
  </div>
</div>

<div class="container">
  <div class="box">
    <h3>ðŸ“Š Fechamento de Caixa</h3>

    <div class="resumo-grid">
      <div class="card">
        <h4>Total Recebido Hoje</h4>
        <p id="totalRecebido">R$ 0.00</p>
      </div>

      <div class="card">
        <h4>Quantidade de Vendas</h4>
        <p id="qtdVendas">0</p>
      </div>

      <div class="card">
        <h4>Data</h4>
        <p id="dataHoje">--/--/----</p>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from "../js/supabase.js";

let pedidosDoDia = [];

async function iniciar(){

  const { data: { session } } = await supabase.auth.getSession();
  if(!session){
    location.href="/auth/login.html";
    return;
  }

  const { data: usuario } = await supabase
    .from("usuarios")
    .select("app_id")
    .eq("id", session.user.id)
    .single();

  window.APP_ID = usuario.app_id;

  await gerarFechamento();
}

window.gerarFechamento = async function(){

  const inicio = new Date();
  inicio.setHours(0,0,0,0);

  const fim = new Date();
  fim.setHours(23,59,59,999);

  const { data } = await supabase
    .from("pedidos")
    .select(`
      id,
      mesa_id,
      forma_pagamento,
      mesas(numero_mesa),
      pedido_itens(preco,quantidade)
    `)
    .eq("app_id", window.APP_ID)
    .eq("status","finalizado")
    .gte("created_at", inicio.toISOString())
    .lte("created_at", fim.toISOString());

  pedidosDoDia = data || [];

  let total = 0;

  pedidosDoDia.forEach(p=>{
    (p.pedido_itens || []).forEach(i=>{
      total += Number(i.preco) * Number(i.quantidade);
    });
  });

  document.getElementById("totalRecebido").innerText =
    "R$ " + total.toFixed(2);

  document.getElementById("qtdVendas").innerText =
    pedidosDoDia.length;

  document.getElementById("dataHoje").innerText =
    new Date().toLocaleDateString("pt-BR");
};

/* =========================
   PDF COMPLETO PROFISSIONAL
========================= */

window.fecharCaixa = async function(){

  await gerarFechamento();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const dataHoje = new Date().toLocaleDateString("pt-BR");

  doc.setFontSize(16);
  doc.text("FECHAMENTO DE CAIXA", 20, 20);

  doc.setFontSize(12);
  doc.text("Data: " + dataHoje, 20, 35);

  let y = 50;
  let total = 0;
  let formas = {};

  doc.text("Detalhamento:", 20, y);
  y += 10;

  pedidosDoDia.forEach(p=>{

    let totalPedido = 0;

    (p.pedido_itens || []).forEach(i=>{
      totalPedido += Number(i.preco) * Number(i.quantidade);
    });

    total += totalPedido;

    let identificacao = "Venda Avulsa";
    if(p.mesas?.numero_mesa){
      identificacao = "Mesa " + p.mesas.numero_mesa;
    }

    let forma = p.forma_pagamento || "NÃ£o informado";

    if(!formas[forma]) formas[forma] = 0;
    formas[forma] += totalPedido;

    doc.text(`${identificacao} | ${forma} | R$ ${totalPedido.toFixed(2)}`, 20, y);
    y += 8;

    if(y > 270){
      doc.addPage();
      y = 20;
    }
  });

  y += 5;
  doc.text("Total Geral: R$ " + total.toFixed(2), 20, y);

  y += 12;
  doc.text("Resumo por Forma de Pagamento:", 20, y);
  y += 8;

  for(const forma in formas){
    doc.text(`${forma}: R$ ${formas[forma].toFixed(2)}`, 20, y);
    y += 8;
  }

  doc.save("fechamento-caixa-" + dataHoje + ".pdf");
};

iniciar();
</script>

</body>
</html>
