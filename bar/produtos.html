<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="../js/auth.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{background:#0f172a;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.container{padding:24px;max-width:1100px;margin:auto}
form{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:30px;display:grid;gap:12px}
input,select,button{padding:12px;border-radius:10px;border:none}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.lista{display:grid;gap:16px}
.card{background:#0f172a;padding:16px;border-radius:14px}
.card img{width:100%;height:160px;object-fit:cover;border-radius:10px;margin-bottom:10px}
.preview{width:100%;max-height:200px;object-fit:cover;border-radius:10px;display:none}
.btn-sec{background:#1e293b;color:#fff;margin-top:6px}
.desativar{background:#ef4444;color:#fff;margin-top:6px}
</style>
</head>
<body>

<div class="topo">
  <h2>üçî Produtos</h2>
  <button onclick="history.back()">‚¨Ö Voltar</button>
</div>

<div class="container">

<form id="formProduto">
  <input type="hidden" id="produtoId">

  <input id="nome" placeholder="Nome do produto" required>
  <input id="preco" type="number" step="0.01" placeholder="Pre√ßo" required>
  <input id="estoque" type="number" placeholder="Estoque" required>

  <select id="destino">
    <option value="cozinha">üç≥ Cozinha</option>
    <option value="bar">üç∫ Bar</option>
  </select>

  <!-- üì∑ CAMERA -->
  <input id="imagem" type="file"
         accept="image/*"
         capture="environment">

  <img id="previewImg" class="preview">

  <button type="submit">Salvar produto</button>
</form>

<div class="lista" id="lista"></div>

</div>

<script type="module">
import { supabase } from "../js/supabase.js";

const MAX_MB = 2;
let imagemFinal = null;

/* üîê ESPERA SESS√ÉO */
async function esperarSessao(){
  while(!window.APP_ID){
    await new Promise(r=>setTimeout(r,100));
  }
  listarProdutos();
}
esperarSessao();

/* üì∑ COMPRESS√ÉO ULTRA LEVE */
imagem.addEventListener("change", async function(){

  const file = this.files[0];
  if(!file) return;

  const tamanhoMB = file.size / (1024*1024);

  if(tamanhoMB > MAX_MB){
    alert("Imagem muito pesada (m√°x 2MB).");
    this.value="";
    return;
  }

  imagemFinal = await comprimirImagem(file);

  previewImg.src = URL.createObjectURL(imagemFinal);
  previewImg.style.display="block";
});

function comprimirImagem(file){
  return new Promise(resolve=>{

    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);

    img.onload = ()=>{
      const MAX_WIDTH = 600;
      const scale = MAX_WIDTH / img.width;

      const canvas = document.createElement("canvas");
      canvas.width = MAX_WIDTH;
      canvas.height = img.height * scale;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0,canvas.width,canvas.height);

      canvas.toBlob(blob=>{
        resolve(new File([blob], file.name, {
          type:"image/jpeg"
        }));
      },"image/jpeg",0.5);
    };
  });
}

/* üì¶ UPLOAD */
async function uploadImagem(file){
  if(!file) return null;

  const path = `${window.APP_ID}/${Date.now()}.jpg`;

  const { error } = await supabase
    .storage
    .from("produtos")
    .upload(path,file,{upsert:true});

  if(error){
    alert("Erro upload imagem");
    return null;
  }

  return supabase
    .storage
    .from("produtos")
    .getPublicUrl(path)
    .data.publicUrl;
}

/* üíæ SALVAR */
formProduto.onsubmit = async e=>{
  e.preventDefault();

  const id = produtoId.value;

  let fotoUrl = null;

  if(imagemFinal){
    fotoUrl = await uploadImagem(imagemFinal);
  }

  const dados = {
    nome:nome.value,
    preco:Number(preco.value),
    estoque:Number(estoque.value),
    destino:destino.value
  };

  if(fotoUrl) dados.foto = fotoUrl;

  if(id){
    await supabase.from("produtos")
      .update(dados)
      .eq("id",id);
  } else {
    await supabase.from("produtos")
      .insert({
        ...dados,
        app_id:window.APP_ID,
        ativo:true
      });
  }

  formProduto.reset();
  previewImg.style.display="none";
  imagemFinal=null;
  produtoId.value="";
  listarProdutos();
};

/* üìã LISTAR */
async function listarProdutos(){

  const { data } = await supabase
    .from("produtos")
    .select("*")
    .eq("app_id",window.APP_ID)
    .eq("ativo",true)
    .order("created_at",{ascending:false});

  lista.innerHTML="";

  (data||[]).forEach(p=>{
    lista.innerHTML+=`
      <div class="card">
        ${p.foto?`<img src="${p.foto}">`:""}
        <b>${p.nome}</b><br>
        R$ ${p.preco.toFixed(2)}<br>
        Estoque: ${p.estoque}<br>

        <button onclick="reporEstoque('${p.id}',${p.estoque})" class="btn-sec">Repor estoque</button>
        <button onclick="editar('${p.id}','${p.nome}',${p.preco},${p.estoque}','${p.destino}')" class="btn-sec">Editar</button>
        <button onclick="desativarProduto('${p.id}')" class="desativar">Desativar</button>
      </div>
    `;
  });
}

/* üîÑ REPOR */
async function reporEstoque(id,atual){
  const qtd = prompt("Quantidade para repor:");
  if(!qtd) return;

  await supabase.from("produtos")
    .update({estoque:atual + Number(qtd)})
    .eq("id",id);

  listarProdutos();
}

/* ‚úèÔ∏è EDITAR */
function editar(id,nomeProd,precoProd,estoqueProd,dest){
  produtoId.value=id;
  nome.value=nomeProd;
  preco.value=precoProd;
  estoque.value=estoqueProd;
  destino.value=dest;
  window.scrollTo({top:0,behavior:"smooth"});
}

/* ‚ùå DESATIVAR */
async function desativarProduto(id){
  if(confirm("Desativar produto?")){
    await supabase.from("produtos")
      .update({ativo:false})
      .eq("id",id);
    listarProdutos();
  }
}

/* EXP√ïE */
window.reporEstoque=reporEstoque;
window.editar=editar;
window.desativarProduto=desativarProduto;

</script>

</body>
</html>
