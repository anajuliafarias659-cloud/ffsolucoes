<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="../js/auth.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{background:#0f172a;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.container{padding:32px;max-width:1100px;margin:auto}
form{background:#0f172a;padding:24px;border-radius:18px;margin-bottom:32px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
input,select,button{padding:12px;border-radius:10px;border:none}
select{background:#fff;color:#000}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.preview{grid-column:1/-1;text-align:center}
.preview img{max-width:200px;border-radius:12px;margin-top:10px}
.lista{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.card{background:#0f172a;border-radius:18px;padding:16px}
.card img{width:100%;height:160px;object-fit:cover;border-radius:12px;margin-bottom:10px}
</style>
</head>

<body>

<div class="topo">
  <h2>üçî Produtos</h2>
  <button onclick="history.back()">‚¨Ö Voltar</button>
</div>

<div class="container">

<form id="formProduto">
  <input type="hidden" id="produtoId">

  <input id="nome" placeholder="Nome do produto" required>
  <input id="preco" type="number" step="0.01" placeholder="Pre√ßo" required>
  <input id="estoque" type="number" min="0" placeholder="Estoque" required>

  <select id="categoria" required></select>

  <select id="destino" required>
    <option value="cozinha">üç≥ Cozinha</option>
    <option value="bar">üç∫ Bar</option>
  </select>

  <input id="imagem" type="file" accept="image/*" capture="environment">

  <div class="preview">
    <div>Preview:</div>
    <img id="previewImg" style="display:none;">
  </div>

  <button type="submit">Salvar produto</button>
</form>

<div class="lista" id="lista"></div>
</div>

<script type="module">
import { supabase } from "../js/supabase.js";

let imagemProcessada = null;

/* üîê Espera auth carregar */
async function esperarSessao(){
  while(!window.APP_ID){
    await new Promise(r=>setTimeout(r,100));
  }
  iniciar();
}

async function iniciar(){
  carregarCategorias();
  listarProdutos();
}

/* ===== PREVIEW + COMPRESS√ÉO ===== */
document.getElementById("imagem").addEventListener("change", async e=>{
  const file = e.target.files[0];
  if(!file) return;

  if(file.size > 20 * 1024 * 1024){
    alert("Imagem muito grande (m√°x 20MB)");
    return;
  }

  const img = await createImageBitmap(file);

  const canvas = document.createElement("canvas");
  const maxWidth = 1280;

  let width = img.width;
  let height = img.height;

  if(width > maxWidth){
    height = height * (maxWidth / width);
    width = maxWidth;
  }

  canvas.width = width;
  canvas.height = height;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(img,0,0,width,height);

  imagemProcessada = await new Promise(resolve =>
    canvas.toBlob(resolve,"image/jpeg",0.7)
  );

  const preview = document.getElementById("previewImg");
  preview.src = URL.createObjectURL(imagemProcessada);
  preview.style.display="block";
});

/* ===== UPLOAD ===== */
async function uploadImagem(){
  if(!imagemProcessada) return null;

  const nomeFinal = `${window.APP_ID}/${Date.now()}.jpg`;

  const { error } = await supabase.storage
    .from("produtos")
    .upload(nomeFinal, imagemProcessada,{
      contentType:"image/jpeg",
      upsert:true
    });

  if(error){
    console.error(error);
    alert("Erro ao enviar imagem");
    return null;
  }

  const { data } = supabase.storage
    .from("produtos")
    .getPublicUrl(nomeFinal);

  return data.publicUrl;
}

/* ===== CATEGORIAS ===== */
async function carregarCategorias(){
  const { data } = await supabase
    .from("categorias")
    .select("id,nome")
    .eq("app_id",window.APP_ID)
    .eq("ativo",true)
    .order("nome");

  const select = document.getElementById("categoria");
  select.innerHTML="<option value=''>Categoria</option>";

  (data||[]).forEach(c=>{
    select.innerHTML+=`<option value="${c.id}">${c.nome}</option>`;
  });
}

/* ===== SALVAR ===== */
document.getElementById("formProduto").addEventListener("submit",async e=>{
  e.preventDefault();

  const foto = await uploadImagem();

  const dados = {
    nome:nome.value,
    preco:Number(preco.value),
    estoque:Number(estoque.value),
    categoria_id:categoria.value,
    destino:destino.value
  };

  if(foto) dados.foto=foto;

  if(produtoId.value){
    await supabase.from("produtos")
      .update(dados)
      .eq("id",produtoId.value);
  }else{
    await supabase.from("produtos")
      .insert({...dados,app_id:window.APP_ID,ativo:true});
  }

  formProduto.reset();
  imagemProcessada=null;
  previewImg.style.display="none";
  listarProdutos();
});

/* ===== LISTAR ===== */
async function listarProdutos(){
  const { data } = await supabase
    .from("produtos")
    .select("*")
    .eq("app_id",window.APP_ID)
    .eq("ativo",true)
    .order("created_at",{ascending:false});

  const div=document.getElementById("lista");
  div.innerHTML="";

  (data||[]).forEach(p=>{
    div.innerHTML+=`
      <div class="card">
        ${p.foto?`<img src="${p.foto}">`:""}
        <b>${p.nome}</b><br>
        R$ ${p.preco.toFixed(2)}<br>
        Estoque: ${p.estoque}<br>
        <button onclick="reporEstoque('${p.id}',${p.estoque})">Repor</button>
      </div>
    `;
  });
}

/* ===== REPOR ===== */
window.reporEstoque=async function(id,atual){
  const qtd=prompt("Quantidade:");
  if(!qtd) return;

  await supabase.from("produtos")
    .update({estoque:atual+Number(qtd)})
    .eq("id",id);

  listarProdutos();
}

esperarSessao();
</script>

</body>
</html>
