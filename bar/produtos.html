<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module" src="../js/auth.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{
  background:#0f172a;
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{padding:32px;max-width:1100px;margin:auto}
form{
  background:#0f172a;
  padding:24px;
  border-radius:18px;
  margin-bottom:32px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
}
input,select,button{
  padding:12px;
  border-radius:10px;
  border:none;
}
select{background:#fff;color:#000}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.preview{
  grid-column:1/-1;
  text-align:center;
}
.preview img{
  max-width:200px;
  max-height:200px;
  border-radius:12px;
  margin-top:10px;
}
.lista{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:16px;
}
.card{
  background:#0f172a;
  border-radius:18px;
  padding:16px;
}
.card img{
  width:100%;
  height:160px;
  object-fit:cover;
  border-radius:12px;
  margin-bottom:10px;
}
</style>
</head>

<body>

<div class="topo">
  <h2>üçî Produtos</h2>
  <button onclick="history.back()">‚¨Ö Voltar</button>
</div>

<div class="container">

<form id="formProduto">

  <input type="hidden" id="produtoId">

  <input id="nome" placeholder="Nome do produto" required>
  <input id="preco" type="number" step="0.01" placeholder="Pre√ßo" required>
  <input id="estoque" type="number" min="0" placeholder="Estoque" required>

  <select id="destino" required>
    <option value="cozinha">üç≥ Cozinha</option>
    <option value="bar">üç∫ Bar</option>
  </select>

  <!-- üì∑ C√ÇMERA DIRETA -->
  <input id="imagem" type="file" accept="image/*" capture="environment">

  <!-- üñº PREVIEW -->
  <div class="preview">
    <strong>Preview:</strong><br>
    <img id="previewImg" style="display:none;">
  </div>

  <button type="submit">Salvar produto</button>
</form>

<div class="lista" id="lista"></div>
</div>

<script type="module">
import { supabase } from "../js/supabase.js";

const MAX_MB = 3;
let imagemComprimida = null;

/* ========= ESPERA SESS√ÉO ========= */
async function aguardarSessao(){
  while(!window.APP_ID){
    await new Promise(r=>setTimeout(r,100));
  }
  listarProdutos();
}

/* ========= PREVIEW + VALIDA√á√ÉO ========= */
imagem.addEventListener("change", async function(){

  const file = this.files[0];
  if(!file) return;

  const tamanhoMB = file.size / (1024*1024);

  if(tamanhoMB > MAX_MB){
    alert("Imagem maior que 3MB ‚ùå");
    this.value = "";
    return;
  }

  imagemComprimida = await comprimirImagem(file);

  previewImg.src = URL.createObjectURL(imagemComprimida);
  previewImg.style.display="block";
});

/* ========= COMPRESS√ÉO ========= */
function comprimirImagem(file){
  return new Promise(resolve=>{

    const reader = new FileReader();
    reader.readAsDataURL(file);

    reader.onload = e=>{

      const img = new Image();
      img.src = e.target.result;

      img.onload = ()=>{

        const canvas = document.createElement("canvas");
        const MAX_WIDTH = 800;

        let width = img.width;
        let height = img.height;

        if(width > MAX_WIDTH){
          height *= MAX_WIDTH / width;
          width = MAX_WIDTH;
        }

        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(img,0,0,width,height);

        canvas.toBlob(blob=>{
          resolve(new File([blob], file.name, {
            type:"image/jpeg",
            lastModified:Date.now()
          }));
        },"image/jpeg",0.7); // qualidade 70%
      };
    };
  });
}

/* ========= UPLOAD ========= */
async function uploadImagem(file){

  if(!file) return null;

  const nomeArquivo =
    window.APP_ID + "/" + Date.now() + "_" + file.name;

  const { error } = await supabase
    .storage
    .from("produtos")
    .upload(nomeArquivo, file, { upsert:true });

  if(error){
    alert("Erro upload");
    return null;
  }

  const { data } = supabase
    .storage
    .from("produtos")
    .getPublicUrl(nomeArquivo);

  return data.publicUrl;
}

/* ========= SALVAR ========= */
formProduto.onsubmit = async e=>{
  e.preventDefault();

  const id = produtoId.value;

  let fotoUrl = null;

  if(imagemComprimida){
    fotoUrl = await uploadImagem(imagemComprimida);
  }

  const dados = {
    nome: nome.value,
    preco: Number(preco.value),
    estoque: Number(estoque.value),
    destino: destino.value
  };

  if(fotoUrl) dados.foto = fotoUrl;

  if(id){
    await supabase.from("produtos")
      .update(dados)
      .eq("id", id);
  } else {
    await supabase.from("produtos")
      .insert({
        ...dados,
        foto: fotoUrl,
        app_id: window.APP_ID,
        ativo:true
      });
  }

  formProduto.reset();
  previewImg.style.display="none";
  imagemComprimida=null;

  listarProdutos();
};

/* ========= LISTAR ========= */
async function listarProdutos(){

  const { data } = await supabase
    .from("produtos")
    .select("*")
    .eq("app_id", window.APP_ID)
    .eq("ativo", true)
    .order("created_at",{ascending:false});

  lista.innerHTML="";

  (data||[]).forEach(p=>{
    lista.innerHTML+=`
      <div class="card">
        ${p.foto?`<img src="${p.foto}">`:""}
        <b>${p.nome}</b><br>
        <b>R$ ${Number(p.preco).toFixed(2)}</b><br>
        <small>Estoque: ${p.estoque}</small>
      </div>
    `;
  });
}

aguardarSessao();
</script>

</body>
</html>
