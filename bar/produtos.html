<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#020617;
  color:#fff;
}
.topo{
  background:#0f172a;
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{
  padding:32px;
  max-width:1100px;
  margin:auto;
}
form{
  background:#0f172a;
  padding:24px;
  border-radius:18px;
  margin-bottom:32px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
}
input, select, button{
  padding:12px;
  border-radius:10px;
  border:none;
}
select{
  background:#fff;
  color:#000;
}
button{
  background:#22c55e;
  font-weight:bold;
  cursor:pointer;
}
.lista{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:16px;
}
.card{
  background:#0f172a;
  border-radius:18px;
  padding:16px;
}
.card img{
  width:100%;
  height:160px;
  object-fit:cover;
  border-radius:12px;
  margin-bottom:10px;
}
.desativar{
  background:#ef4444;
  color:#fff;
  margin-top:8px;
}
.excluir{
  background:#7f1d1d;
  color:#fff;
  margin-top:6px;
}
.repor{
  background:#2563eb;
  color:#fff;
  margin-top:6px;
}
small{color:#cbd5f5}
</style>
</head>

<body>

<div class="topo">
  <h2>üçî Produtos</h2>
  <button onclick="history.back()">‚¨Ö Voltar</button>
</div>

<div class="container">

  <!-- FORM PRODUTO -->
  <form id="formProduto">
    <input id="nome" placeholder="Nome do produto" required>
    <input id="preco" type="number" step="0.01" placeholder="Pre√ßo" required>
    <input id="estoque" type="number" min="0" placeholder="Estoque inicial" required>

    <select id="categoria" required></select>

    <input id="imagem" type="file" accept="image/*">
    <button type="submit">Salvar produto</button>
  </form>

  <!-- LISTA -->
  <div class="lista" id="lista"></div>

</div>

<script>
const admin = JSON.parse(localStorage.getItem("admin_logado"));
const funcionario = JSON.parse(localStorage.getItem("usuario_bar"));

// ‚ùå se for funcion√°rio, bloqueia
if(funcionario){
  alert("Acesso restrito ao administrador");
  location.href = "login-funcionario.html";
}

// ‚ùå se n√£o for admin v√°lido, bloqueia
if(!admin || admin.tipo !== "bar"){
  alert("Acesso restrito ao administrador");
  location.href = "../auth/login.html";
}

// üîê ADMIN
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if(!admin || !admin.app_id){
  alert("Sess√£o expirada");
  location.href="../auth/login.html";
}

// üîå SUPABASE
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

// üßº limpar nome arquivo
function limparNomeArquivo(nome){
  return nome
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "_")
    .replace(/[^a-zA-Z0-9._-]/g, "");
}

// üì§ upload imagem
async function uploadImagem(file){
  if(!file) return null;

  const nomeLimpo = limparNomeArquivo(file.name);
  const path = `${admin.app_id}/${Date.now()}_${nomeLimpo}`;

  const { error } = await sb.storage
    .from("produtos")
    .upload(path, file, { upsert:true });

  if(error){
    console.error(error);
    alert("Erro ao enviar imagem");
    return null;
  }

  return sb.storage.from("produtos").getPublicUrl(path).data.publicUrl;
}

// üìÇ categorias
async function carregarCategorias(){
  const select = document.getElementById("categoria");

  const { data, error } = await sb
    .from("categorias")
    .select("*")
    .eq("app_id", admin.app_id)
    .eq("ativo", true)
    .order("nome");

  if(error){
    console.error(error);
    select.innerHTML = `<option disabled>Erro</option>`;
    return;
  }

  select.innerHTML =
    `<option value="" disabled selected>Categoria</option>` +
    data.map(c=>`<option value="${c.id}">${c.nome}</option>`).join("");
}

// üíæ salvar produto
document.getElementById("formProduto").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const nome = document.getElementById("nome").value.trim();
  const preco = Number(document.getElementById("preco").value);
  const estoque = Number(document.getElementById("estoque").value);
  const categoria_id = document.getElementById("categoria").value;
  const file = document.getElementById("imagem").files[0];

  const foto = await uploadImagem(file);

  const { error } = await sb.from("produtos").insert({
    app_id: admin.app_id,
    nome,
    preco,
    estoque,
    categoria_id,
    foto,
    ativo: true
  });

  if(error){
    console.error(error);
    alert("Erro ao salvar produto");
    return;
  }

  e.target.reset();
  listarProdutos();
});

// üìã listar produtos
async function listarProdutos(){
  const { data, error } = await sb
    .from("produtos")
    .select("*")
    .eq("app_id", admin.app_id)
    .eq("ativo", true)
    .order("created_at", { ascending:false });

  if(error){
    console.error(error);
    return;
  }

  const lista = document.getElementById("lista");
  lista.innerHTML="";

  data.forEach(p=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      ${p.foto ? `<img src="${p.foto}">` : ""}
      <b>${p.nome}</b><br>
      <b>R$ ${Number(p.preco).toFixed(2)}</b><br>
      <small>Estoque: ${p.estoque}</small>

      <button class="repor" onclick="reporEstoque('${p.id}', ${p.estoque})">
        Repor estoque
      </button>

      <button class="desativar" onclick="desativarProduto('${p.id}')">
        Desativar
      </button>

      <button class="excluir" onclick="excluirProduto('${p.id}','${p.nome}')">
        Excluir
      </button>
    `;
    lista.appendChild(div);
  });
}

// üîÑ repor estoque
async function reporEstoque(produtoId, estoqueAtual){
  const qtd = prompt(
    `Quantidade para REPOR:\n\nEstoque atual: ${estoqueAtual}`,
    "1"
  );

  if(!qtd) return;

  const quantidade = Number(qtd);
  if(isNaN(quantidade) || quantidade <= 0){
    alert("Quantidade inv√°lida");
    return;
  }

  const { error } = await sb.from("produtos")
    .update({ estoque: estoqueAtual + quantidade })
    .eq("id", produtoId)
    .eq("app_id", admin.app_id);

  if(error){
    console.error(error);
    alert("Erro ao repor estoque");
    return;
  }

  listarProdutos();
}

// ‚ùå desativar
async function desativarProduto(id){
  if(!confirm("Desativar produto?")) return;

  await sb.from("produtos")
    .update({ ativo:false })
    .eq("id", id)
    .eq("app_id", admin.app_id);

  listarProdutos();
}

// üóëÔ∏è excluir
async function excluirProduto(id, nome){
  const ok = confirm(
    `‚ö†Ô∏è EXCLUIR DEFINITIVAMENTE?\n\nProduto: "${nome}"`
  );
  if(!ok) return;

  const { error } = await sb.from("produtos")
    .delete()
    .eq("id", id)
    .eq("app_id", admin.app_id);

  if(error){
    console.error(error);
    alert("Erro ao excluir produto");
    return;
  }

  listarProdutos();
}

// üöÄ INIT
carregarCategorias();
listarProdutos();
</script>

</body>
</html>
