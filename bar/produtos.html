<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module" src="../js/auth.js"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.topo{background:#0f172a;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.container{padding:32px;max-width:1100px;margin:auto}
form{background:#0f172a;padding:24px;border-radius:18px;margin-bottom:32px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
input,select,button{padding:12px;border-radius:10px;border:none}
select{background:#fff;color:#000}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.btn-camera{background:#2563eb;color:#fff}
.btn-editar{background:#facc15;color:#000;margin-top:6px}
.repor{background:#2563eb;color:#fff;margin-top:6px}
.desativar{background:#ef4444;color:#fff;margin-top:6px}
.lista{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.card{background:#0f172a;border-radius:18px;padding:16px}
.card img{width:100%;height:160px;object-fit:cover;border-radius:12px;margin-bottom:10px}
small{color:#cbd5f5}
</style>
</head>

<body>

<div class="topo">
  <h2>üçî Produtos</h2>
  <button onclick="history.back()">‚¨Ö Voltar</button>
</div>

<div class="container">

<form id="formProduto">
  <input type="hidden" id="produtoId">

  <input id="nome" placeholder="Nome do produto" required>
  <input id="preco" type="number" step="0.01" placeholder="Pre√ßo" required>
  <input id="estoque" type="number" min="0" placeholder="Estoque" required>

  <select id="categoria" required></select>

  <select id="destino" required>
    <option value="cozinha">üç≥ Cozinha</option>
    <option value="bar">üç∫ Bar</option>
  </select>

  <input id="imagem" type="file" accept="image/*" capture="environment">
  <button type="button" class="btn-camera" onclick="abrirCamera()">üì∑ Tirar / Trocar foto</button>

  <button type="submit">Salvar produto</button>
</form>

<div class="lista" id="lista"></div>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

let app_id = null;

/* üîê ESPERA AUTH */
function esperarSessao(){
  if(window.APP_ID){
    app_id = window.APP_ID;
    iniciarSistema();
  } else {
    setTimeout(esperarSessao,100);
  }
}

function iniciarSistema(){
  carregarCategorias();
  listarProdutos();
}

function abrirCamera(){
  document.getElementById("imagem").click();
}

async function carregarCategorias(){
  const { data } = await sb
    .from("categorias")
    .select("id,nome")
    .eq("app_id", app_id)
    .eq("ativo", true)
    .order("nome");

  categoria.innerHTML =
    `<option disabled selected>Categoria</option>` +
    (data || []).map(c=>`<option value="${c.id}">${c.nome}</option>`).join("");
}

function limparNomeArquivo(nome){
  return nome.normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g,"_")
    .replace(/[^a-zA-Z0-9._-]/g,"");
}

async function uploadImagem(file){
  if(!file) return null;
  const path = `${app_id}/${Date.now()}_${limparNomeArquivo(file.name)}`;
  await sb.storage.from("produtos").upload(path, file, { upsert:true });
  return sb.storage.from("produtos").getPublicUrl(path).data.publicUrl;
}

formProduto.onsubmit = async e =>{
  e.preventDefault();

  const id = produtoId.value;
  const file = imagem.files[0];
  const foto = file ? await uploadImagem(file) : null;

  const dados = {
    nome: nome.value,
    preco: Number(preco.value),
    estoque: Number(estoque.value),
    categoria_id: categoria.value,
    destino: destino.value
  };

  if(foto) dados.foto = foto;

  if(id){
    await sb.from("produtos").update(dados).eq("id", id);
  }else{
    await sb.from("produtos").insert({
      ...dados,
      app_id,
      ativo:true
    });
  }

  formProduto.reset();
  produtoId.value="";
  listarProdutos();
};

async function listarProdutos(){
  const { data } = await sb
    .from("produtos")
    .select("*, categorias(nome)")
    .eq("app_id", app_id)
    .eq("ativo", true)
    .order("created_at",{ascending:false});

  lista.innerHTML="";
  (data || []).forEach(p=>{
    lista.innerHTML+=`
      <div class="card">
        ${p.foto?`<img src="${p.foto}">`:""}
        <b>${p.nome}</b><br>
        <b>R$ ${p.preco.toFixed(2)}</b><br>
        <small>Categoria: ${p.categorias?.nome||""}</small><br>
        <small>Destino: ${p.destino}</small><br>
        <small>Estoque: ${p.estoque}</small><br>

        <button class="repor" onclick="reporEstoque('${p.id}', ${p.estoque})">Repor estoque</button>
        <button class="btn-editar" onclick='editar(${JSON.stringify(p)})'>Editar</button>
        <button class="desativar" onclick="desativarProduto('${p.id}')">Desativar</button>
      </div>`;
  });
}

function editar(p){
  produtoId.value = p.id;
  nome.value = p.nome;
  preco.value = p.preco;
  estoque.value = p.estoque;
  categoria.value = p.categoria_id;
  destino.value = p.destino;
  window.scrollTo({top:0,behavior:"smooth"});
}

async function reporEstoque(id, atual){
  const qtd = prompt(`Quantidade para REPOR:\nEstoque atual: ${atual}`, "1");
  if(!qtd) return;

  const n = Number(qtd);
  if(isNaN(n) || n <= 0){
    alert("Quantidade inv√°lida");
    return;
  }

  await sb.from("produtos")
    .update({ estoque: atual + n })
    .eq("id", id);

  listarProdutos();
}

async function desativarProduto(id){
  if(confirm("Desativar produto?")){
    await sb.from("produtos").update({ativo:false}).eq("id",id);
    listarProdutos();
  }
}

esperarSessao();
</script>

</body>
</html>
