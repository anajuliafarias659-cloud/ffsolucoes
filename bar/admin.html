<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel do Bar / Restaurante</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}

body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#020617;
  color:#fff;
}

.topo{
  background:#0f172a;
  padding:14px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.sair{
  background:#e53935;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}

.container{
  padding:16px;
  max-width:1100px;
  margin:auto;
}

/* ğŸ“± CELULAR â†’ 2 POR LINHA */
.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:14px;
  margin-bottom:30px;
}

/* ğŸ’» DESKTOP â†’ AUTOMÃTICO */
@media(min-width:768px){
  .grid{
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  }
}

.card{
  background:#0f172a;
  padding:16px;
  border-radius:14px;
  cursor:pointer;
  transition:.2s;
  display:flex;
  flex-direction:column;
  justify-content:center;
  text-align:center;
}

.card:hover{
  transform:translateY(-4px);
  background:#1e293b;
}

.card h3{
  margin:0 0 10px 0;
  font-size:15px;
}

select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#1e293b;
  color:#fff;
  margin-top:8px;
}

.botao-link{
  margin-top:10px;
  font-size:13px;
  opacity:.8;
  cursor:pointer;
}

.botao-link:hover{
  opacity:1;
}
</style>
</head>

<body>

<div class="topo">
  <h2>ğŸ» Painel</h2>
  <button class="sair" onclick="logout()">Sair</button>
</div>

<div class="container">

  <p>
    Bem-vindo, <b id="nome"></b><br>
    <small style="opacity:.6">
      ID do NegÃ³cio: <span id="negocioId"></span>
    </small>
  </p>

  <div class="grid">

    <div class="card" onclick="irPara('produtos.html')">ğŸ“¦ Produtos</div>
    <div class="card" onclick="irPara('categorias.html')">ğŸ“‚ Categorias</div>
    <div class="card" onclick="irPara('mesas.html')">ğŸª‘ Mesas</div>
    <div class="card" onclick="irPara('cozinha.html')">ğŸ§¾ Cozinha</div>
    <div class="card" onclick="irPara('caixa.html')">ğŸ’° Caixa</div>
    <div class="card" onclick="irPara('admins.html')">âš™ï¸ Admins</div>

    <!-- ğŸŒ PÃGINA PÃšBLICA -->
    <div class="card">
      <h3>ğŸŒ PÃ¡gina PÃºblica</h3>

      <select id="modo_publico">
        <option value="cardapio">ğŸ›’ CardÃ¡pio</option>
        <option value="site">ğŸŒ Site</option>
      </select>

      <div class="botao-link" onclick="compartilharPagina()">
        ğŸ”— Compartilhar PÃ¡gina
      </div>
    </div>

  </div>

</div>

<script type="module">
import { supabase } from "../js/supabase.js";

let app_id = null;

/* ğŸ” VERIFICAR SESSÃƒO */
async function verificarSessao(){
  const { data: { session } } = await supabase.auth.getSession();
  if(!session){
    window.location.href = "/auth/login.html";
    return null;
  }
  return session.user.id;
}

/* ğŸ‘¤ CARREGAR USUÃRIO */
async function carregarUsuario(){

  const userId = await verificarSessao();
  if(!userId) return;

  const { data: usuario } = await supabase
    .from("usuarios")
    .select("nome, app_id")
    .eq("id", userId)
    .single();

  if(!usuario) return;

  app_id = usuario.app_id;

  document.getElementById("nome").innerText = usuario.nome;
  document.getElementById("negocioId").innerText = usuario.app_id;

  carregarModo();
}

/* ğŸŒ CARREGAR MODO */
async function carregarModo(){

  const { data } = await supabase
    .from("config_site")
    .select("modo_cardapio")
    .eq("app_id", app_id)
    .maybeSingle();

  if(data){
    document.getElementById("modo_publico").value =
      data.modo_cardapio || "cardapio";
  } else {
    document.getElementById("modo_publico").value = "cardapio";
  }
}

/* ğŸ’¾ SALVAR AO TROCAR */
document.addEventListener("change", async (e)=>{

  if(e.target.id !== "modo_publico") return;

  const modo = e.target.value;

  const { data: existente } = await supabase
    .from("config_site")
    .select("id")
    .eq("app_id", app_id)
    .maybeSingle();

  if(existente){
    await supabase
      .from("config_site")
      .update({ modo_cardapio: modo })
      .eq("app_id", app_id);
  }else{
    await supabase
      .from("config_site")
      .insert({ app_id, modo_cardapio: modo });
  }

});

/* ğŸ”— COMPARTILHAR */
window.compartilharPagina = function(){

  const modo = document.getElementById("modo_publico").value;
  const base = location.origin;

  let url = "";

  if(modo === "cardapio"){
    url = `${base}/bar/public/cardapio/?app_id=${app_id}`;
  }

  if(modo === "site"){
    url = `${base}/bar/public/site/?app_id=${app_id}`;
  }

  if(navigator.share){
    navigator.share({
      title: "PÃ¡gina do meu negÃ³cio",
      text: "Confira aqui:",
      url: url
    });
  }else{
    navigator.clipboard.writeText(url);
    alert("Link copiado ğŸ”¥");
  }
};

window.irPara = pagina => window.location.href = pagina;

window.logout = async ()=>{
  await supabase.auth.signOut();
  window.location.href = "/auth/login.html";
};

carregarUsuario();
</script>

</body>
</html>
