<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel do Bar / Restaurante</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}

body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#020617;
  color:#fff;
}

.topo{
  background:#0f172a;
  padding:14px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.sair{
  background:#e53935;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}

.container{
  padding:16px;
  max-width:1100px;
  margin:auto;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:14px;
  margin-bottom:30px;
}

.card{
  background:#0f172a;
  padding:14px;
  border-radius:14px;
  cursor:pointer;
  transition:.2s;
}

.card:hover{
  transform:translateY(-4px);
  background:#1e293b;
}

.bloco-publico{
  background:#0f172a;
  padding:20px;
  border-radius:14px;
  margin-top:20px;
}

select{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
  background:#1e293b;
  color:#fff;
}

.compartilhar-card{
  margin-top:12px;
  padding:10px;
  text-align:center;
  font-size:14px;
}
</style>
</head>

<body>

<div class="topo">
  <h2>ğŸ» Painel do Bar / Restaurante</h2>
  <button class="sair" onclick="logout()">Sair</button>
</div>

<div class="container">

  <p>
    Bem-vindo, <b id="nome"></b><br>
    <small style="opacity:.6">
      ID do NegÃ³cio: <span id="negocioId"></span>
    </small>
  </p>

  <div class="grid">

    <div class="card" onclick="irPara('produtos.html')">ğŸ“¦ Produtos</div>
    <div class="card" onclick="irPara('categorias.html')">ğŸ“‚ Categorias</div>
    <div class="card" onclick="irPara('mesas.html')">ğŸª‘ Mesas</div>
    <div class="card" onclick="irPara('cozinha.html')">ğŸ§¾ Cozinha</div>
    <div class="card" onclick="irPara('caixa.html')">ğŸ’° Caixa</div>
    <div class="card" onclick="irPara('admins.html')">âš™ï¸ Admins</div>
    <div class="card" onclick="irPara('config-site.html')">âš™ï¸ Configurar o Seu Site</div>

  </div>

  <!-- BLOCO PÃšBLICO -->
  <div class="bloco-publico">

    <h3>ğŸŒ PÃ¡gina PÃºblica</h3>

    <select id="modo_publico">
      <option value="cardapio">ğŸ›’ CardÃ¡pio</option>
      <option value="site">ğŸŒ Site</option>
    </select>

    <div class="card compartilhar-card" onclick="compartilharPagina()">
      ğŸ”— Compartilhar PÃ¡gina
    </div>

  </div>

</div>

<script type="module">
import { supabase } from "../js/supabase.js";

let app_id = null;

/* ===============================
   VERIFICAR SESSÃƒO
================================= */
async function verificarSessao(){
  const { data: { session } } = await supabase.auth.getSession();
  if(!session){
    window.location.href = "/auth/login.html";
    return null;
  }
  return session.user.id;
}

/* ===============================
   CARREGAR USUÃRIO
================================= */
async function carregarUsuario(){

  const userId = await verificarSessao();
  if(!userId) return;

  const { data: usuario } = await supabase
    .from("usuarios")
    .select("nome, app_id")
    .eq("id", userId)
    .single();

  if(!usuario) return;

  app_id = usuario.app_id;

  document.getElementById("nome").innerText = usuario.nome;
  document.getElementById("negocioId").innerText = usuario.app_id;

  carregarModo();
}

/* ===============================
   CARREGAR MODO
================================= */
async function carregarModo(){

  const { data } = await supabase
    .from("config_site")
    .select("modo_publico")
    .eq("app_id", app_id)
    .maybeSingle();

  if(data){
    document.getElementById("modo_publico").value =
      data.modo_publico || "cardapio";
  }
}

/* ===============================
   SALVAR AO TROCAR
================================= */
document.getElementById("modo_publico")
.addEventListener("change", async (e)=>{

  const modo = e.target.value;

  const { data: existente } = await supabase
    .from("config_site")
    .select("id")
    .eq("app_id", app_id)
    .maybeSingle();

  if(existente){
    await supabase
      .from("config_site")
      .update({ modo_publico: modo })
      .eq("app_id", app_id);
  }else{
    await supabase
      .from("config_site")
      .insert({ app_id, modo_publico: modo });
  }

});

/* ===============================
   COMPARTILHAR
================================= */
window.compartilharPagina = async function(){

  const modo = document.getElementById("modo_publico").value;
  const base = location.origin;

  let url = "";

  if(modo === "cardapio"){
    url = `${base}/bar/public/cardapio/?app_id=${app_id}`;
  }

  if(modo === "site"){
    url = `${base}/bar/public/site/?app_id=${app_id}`;
  }

  // Compartilhamento nativo (celular)
  if(navigator.share){
    try{
      await navigator.share({
        title: "PÃ¡gina do meu negÃ³cio",
        text: "Confira aqui:",
        url: url
      });
    }catch(err){}
  }else{
    await navigator.clipboard.writeText(url);
    alert("Link copiado ğŸ”¥");
  }
};

window.irPara = pagina => window.location.href = pagina;

window.logout = async ()=>{
  await supabase.auth.signOut();
  window.location.href = "/auth/login.html";
};

carregarUsuario();
</script>

</body>
</html>

